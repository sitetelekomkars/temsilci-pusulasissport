function formatWeekLabel(e){try{if(!e)return"";const t=String(e).split("-");if(t.length>=2){const e=t[0].trim(),a=t[1].trim(),n=new Date(e),i=new Date(a);if(!isNaN(n)&&!isNaN(i)){if(n.getMonth()===i.getMonth()&&n.getFullYear()===i.getFullYear()){const e=n.toLocaleDateString("tr-TR",{day:"2-digit"}),t=i.toLocaleDateString("tr-TR",{day:"2-digit"});return`${e} - ${t} ${n.toLocaleDateString("tr-TR",{month:"long",year:"numeric"})}`}{const e=n.toLocaleDateString("tr-TR",{day:"2-digit",month:"long",year:"numeric"});return`${e} - ${i.toLocaleDateString("tr-TR",{day:"2-digit",month:"long",year:"numeric"})}`}}}}catch(e){}return e||""}function formatShiftDate(e){try{const t=new Date(e);if(!isNaN(t))return t.toLocaleDateString("tr-TR",{weekday:"short",day:"2-digit",month:"2-digit"})}catch(e){}return e}const BAKIM_MODU=!1;function showGlobalError(e){try{console.warn("[Pusula]",e)}catch(e){}try{const t=localStorage.getItem("sSportRole")||"";"admin"!==t&&"locadmin"!==t||Swal.fire({toast:!0,position:"bottom-end",icon:"warning",title:String(e||"UyarÄ±"),showConfirmButton:!1,timer:2500})}catch(e){}}function b64toBlob(e,t="",a=512){try{const n=atob(e),i=[];for(let e=0;e<n.length;e+=a){const t=n.slice(e,e+a),l=new Array(t.length);for(let e=0;e<t.length;e++)l[e]=t.charCodeAt(e);const r=new Uint8Array(l);i.push(r)}return new Blob(i,{type:t})}catch(e){return console.error("b64toBlob error:",e),null}}const SUPABASE_URL="https://psauvjohywldldgppmxz.supabase.co",SUPABASE_KEY="sb_publishable_ITFx76ndmOc3UJkNbHOSlQ_kD91kq45",sb=window.supabase&&"function"==typeof window.supabase.createClient?window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY):null,GAS_MAIL_URL="https://script.google.com/macros/s/AKfycbwZZbRVksffgpu_WvkgCoZehIBVTTTm5j5SEqffwheCU44Q_4d9b64kSmf40wL1SR8/exec";async function sendMailNotification(e,t,a,n=null,i=null){if(GAS_MAIL_URL.includes("X0X0"))console.warn("[Pusula Mail] Mail servisi URL'si ayarlanmamÄ±ÅŸ.");else try{const l={action:"sendEmail",to:e,subject:t,body:a};n&&(l.cc=n),i&&(l.bcc=i),await fetch(GAS_MAIL_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),console.log("[Pusula Mail] GÃ¶nderim tetiklendi:",e)}catch(e){console.error("[Pusula Mail] Hata:",e)}}async function saveLog(e,t){if(sb)try{await sb.from("Logs").insert([{Username:currentUser||localStorage.getItem("sSportUser")||"-",Action:e,Details:t,"Ä°P ADRESÄ°":globalUserIP||"-",Date:(new Date).toISOString()}])}catch(e){console.error("[Pusula Log] Hata:",e)}}function normalizeKeys(e){if(!e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(normalizeKeys);const t={};return Object.keys(e).forEach(a=>{t[a]=e[a];const n=a.toLowerCase().replace(/\s+/g,"");if(t[n]=e[a],"AgentName"!==a&&"Username"!==a&&"Temsilci"!==a&&"Name"!==a&&"Ä°sim"!==a||(t.agent=e[a],t.agentName=e[a],t.username=e[a],t.temsilci=e[a],t.name=e[a]),"CallID"!==a&&"CallId"!==a&&"Call_ID"!==a||(t.callId=e[a]),"CallDate"===a&&(t.callDate=formatDateToDDMMYYYY(e[a])),"Date"===a&&(t.date=formatDateToDDMMYYYY(e[a])),"Tarih"===a){const n=formatDateToDDMMYYYY(e[a]);t.callDate||(t.callDate=n),t.date||(t.date=n)}"Score"!==a&&"Puan"!==a&&"Points"!==a||(t.score=e[a],t.points=e[a]),"Orta Puan"!==a&&"MediumScore"!==a||(t.mediumScore=e[a]),"KÃ¶tÃ¼ Puan"!==a&&"BadScore"!==a||(t.badScore=e[a]),"Okundu"===a&&(t.isSeen=!0===e[a]||"true"===String(e[a])||"1"===String(e[a])),"Durum"!==a&&"Status"!==a||(t.status=e[a]),"FeedbackType"===a&&(t.feedbackType=e[a]),"BaÅŸlÄ±k"!==a&&"Teklif AdÄ±"!==a&&"Title"!==a||(t.title=e[a],t.head=e[a]),"Key"===a&&(t.key=e[a]),"BlockId"!==a&&"blockId"!==a||(t.blockId=e[a]),"Ä°Ã§erik"!==a&&"AÃ§Ä±klama"!==a&&"Description"!==a&&"Metin"!==a&&"Soru_Metinleri"!==a&&"Soru"!==a&&"Text"!==a&&"Content"!==a||(t.content=e[a],t.text=e[a],t.description=e[a],t.questions=e[a]),"Script"!==a&&"Senaryo"!==a||(t.script=e[a]),"Kategori"!==a&&"Segment"!==a&&"TargetGroup"!==a&&"Konu"!==a&&"VisibleGroups"!==a||(t.category=e[a],t.segment=e[a],t.group=e[a],t.subject=e[a],t.visibleGroups=e[a]),"GÃ¶rsel"!==a&&"Image"!==a&&"Link"!==a||(t.image=e[a],t.link=e[a]),"ContentLink"===a&&(t.link=e[a]),"DocLink"===a&&(t.docLink=e[a]),"TargetUser"===a&&(t.targetUser=e[a]),"TargetGroup"===a&&(t.target=e[a]),"CreatedBy"===a&&(t.creator=e[a]),"StartDate"===a&&(t.startDate=e[a]),"EndDate"===a&&(t.endDate=e[a]),"Duration"===a&&(t.duration=e[a]);const i=String(a||"").replace(/\s+/g," ").trim().toUpperCase();"DATE"!==i&&"TARÄ°H"!==i&&"TARIH"!==i||(t.date||(t.date=e[a]),t.dateISO=e[a]),"EVENT NAME - TURKISH"!==i&&"MAC"!==i&&"EVENT"!==i&&"TITLE"!==i&&"BAÅžLIK"!==i&&"BASLIK"!==i||(t.match=e[a],t.event=e[a]),("SAAT"===i||"TIME"===i||"START_TIME_TSI"===i||"START TIME TSI"===i||i.includes("START")&&i.includes("TIME"))&&(t.time=e[a]),"ANNOUNCER"!==i&&"KANAL"!==i&&"PLATFORM"!==i||(t.channel=e[a],t.announcer=e[a]);const l=t.date||t.dateISO,r=t.time;if(l&&r)try{const e=String(l).includes(".")?String(l).split(".").reverse().join("-"):String(l).split(" ")[0],a=`${e}T${5===String(r).trim().length?`${String(r).trim()}:00`:String(r).trim()}`,n=new Date(a);isNaN(n.getTime())||(t.startEpoch=n.getTime())}catch(e){}"Details"!==a&&"Detay"!==a||(t.details=e[a]),"Feedback"!==a&&"Geri Bildirim"!==a||(t.feedback=e[a]),"Temsilci Notu"!==a&&"AgentNote"!==a||(t.agentNote=e[a]),"YÃ¶netici CevabÄ±"!==a&&"ManagerReply"!==a||(t.managerReply=e[a]),"StepID"!==a&&"StepId"!==a&&"AdÄ±mID"!==a||(t.stepId=e[a]),(a.toLowerCase().includes("option")||a.toLowerCase().includes("button")||"SeÃ§enekler"===a||"Butonlar"===a)&&(t.options&&!String(e[a]).includes("|")||(t.options=e[a])),"Alert"!==a&&"UyarÄ±"!==a||(t.alert=e[a]),"Result"!==a&&"SonuÃ§"!==a||(t.result=e[a]),"SuccessRate"!==a&&"BaÅŸarÄ±"!==a||(t.average=e[a]),"TotalQuestions"===a&&(t.total=e[a])}),t}async function apiCall(e,t={}){console.log(`[Pusula] apiCall: ${e}`,t);try{switch(e){case"getRolePermissions":{const{data:e,error:t}=await sb.from("RolePermissions").select("*");if(t)throw t;const a=(e||[]).map(normalizeKeys),n=[...new Set(a.map(e=>e.role||e.Role).filter(Boolean))];return{result:"success",permissions:a,groups:n}}case"setRolePermissions":{const{role:e,perms:a}=t;for(const t of a)await sb.from("RolePermissions").upsert({Role:e,Resource:t.resource||t.Resource,Permission:t.permission||t.Permission,Value:void 0!==t.value?t.value:t.Value},{onConflict:"Role,Resource,Permission"});return saveLog("Yetki GÃ¼ncelleme",`${e} rolÃ¼ iÃ§in yetkiler gÃ¼ncellendi.`),{result:"success"}}case"fetchEvaluations":{let e=sb.from("Evaluations").select("*");t.targetAgent&&"all"!==t.targetAgent?e=e.eq("AgentName",t.targetAgent):t.targetGroup&&"all"!==t.targetGroup&&(e=e.ilike("Group",t.targetGroup));const{data:a,error:n}=await e.order("id",{ascending:!1});if(n)throw n;return{result:"success",evaluations:a.map(normalizeKeys)}}case"logEvaluation":{const{data:e,error:a}=await sb.from("Evaluations").insert([{AgentName:t.agentName,Evaluator:currentUser,CallID:t.callId,CallDate:t.callDate,Score:t.score,Details:t.details,Feedback:t.feedback,FeedbackType:t.feedbackType,Group:t.agentGroup,Date:(new Date).toISOString(),Okundu:0,Durum:t.status||"TamamlandÄ±"}]).select("id").single();if(a)throw a;return saveLog("DeÄŸerlendirme KaydÄ±",`${t.agentName} | ${t.callId} | ${t.score}`),(async()=>{try{const{data:e}=await sb.from("profiles").select("email").ilike("username",t.agentName).maybeSingle();if(e&&e.email){const a=`Yeni Kalite DeÄŸerlendirmesi: ${t.callId}`,n=`Merhaba ${t.agentName},\n\nYeni bir kalite deÄŸerlendirmesi kaydedildi.\n\nÃ‡aÄŸrÄ± ID: ${t.callId}\nPuan: ${t.score}\nGeri Bildirim: ${t.feedback}\n\nDetaylarÄ± Pusula Ã¼zerinden inceleyebilirsin.\nÄ°yi Ã§alÄ±ÅŸmalar.\nS Sport Plus Kalite Ekibi`,i="kalite@ssportplus.com",l="dogus.yalcinkaya@sitetelekom.com.tr";"function"==typeof sendMailNotification?sendMailNotification(e.email,a,n,i,l):console.warn("sendMailNotification fonksiyonu bulunamadÄ±, mail atÄ±lamadÄ±.")}}catch(e){console.error("Mail gÃ¶nderme hatasÄ±:",e)}})(),{result:"success"}}case"logCard":{const e={Type:t.type,Category:t.category,Title:t.title,Text:t.text,Script:t.script,Code:t.code,Status:t.status,Link:t.link,Tip:t.tip,Detail:t.detail,Pronunciation:t.pronunciation,Icon:t.icon,Date:t.date||(new Date).toISOString(),QuizOptions:t.quizOptions,QuizAnswer:t.quizAnswer},{error:a}=await sb.from("Data").insert([e]);if(a)throw a;return saveLog("Yeni Kart Ekleme",`${t.title} (${t.type})`),{result:"success"}}case"addCard":return await apiCall("logCard",t);case"editCard":{const{error:e}=await sb.from("Data").update({Category:t.category,Title:t.title,Text:t.text,Script:t.script,Code:t.code,Link:t.link,Image:t.image}).eq("id",t.id);if(e)throw e;return saveLog("Kart DÃ¼zenleme",`${t.title} (ID: ${t.id})`),{result:"success"}}case"deleteCard":{const{error:e}=await sb.from("Data").delete().eq("id",t.id);if(e)throw e;return saveLog("Kart Silme",`ID: ${t.id}`),{result:"success"}}case"saveUser":{const{id:e,username:a,fullName:n,role:i,group:l}=t;if(!e)return{result:"error",message:"Yeni kullanÄ±cÄ±lar Supabase Dashboard Ã¼zerinden eklenmelidir."};const r={username:a,full_name:n,role:i,group:l},{error:s}=await sb.from("profiles").update(r).eq("id",e);if(s)throw s;return saveLog("KullanÄ±cÄ± Profil GÃ¼ncelleme",`${a} (ID: ${e})`),{result:"success"}}case"deleteUser":{const{error:e}=await sb.from("profiles").delete().eq("id",t.id);if(e)throw e;return saveLog("KullanÄ±cÄ± Profil Silme",`ID: ${t.id}`),{result:"success"}}case"exportEvaluations":{let e=sb.from("Evaluations").select("*");"all"!==t.targetAgent&&(e=e.ilike("AgentName",t.targetAgent)),"all"!==t.targetGroup&&(e=e.ilike("Group",t.targetGroup));const{data:a,error:n}=await e.order("id",{ascending:!1});if(n)throw n;const i=(a||[]).map(normalizeKeys),l="all"===t.targetPeriod?i:i.filter(e=>{const a=e.callDate||e.date;if(!a)return!1;if(a.includes(".")){const e=a.split(".");if(e.length>=3){return`${e[1]}-${e[2].split(" ")[0]}`===t.targetPeriod}}else if(a.includes("-")){const e=a.split("-");if(e.length>=2){const a=e[0];return`${e[1]}-${a}`===t.targetPeriod}}return!1});let r=[],s=new Set;l.forEach(e=>{try{const t="string"==typeof e.details?JSON.parse(e.details):e.details;Array.isArray(t)&&t.forEach(e=>{e.q&&s.add(e.q)})}catch(e){}});const o=Array.from(s);o.forEach(e=>{r.push(e),r.push(`Not (${e})`)});const d=["Log Tarihi","DeÄŸerleyen","Temsilci","Grup","Call ID","Puan","Genel Geri Bildirim","Durum","Temsilci Notu","YÃ¶netici CevabÄ±","Ã‡aÄŸrÄ± Tarihi",...r];return{result:"success",headers:d,data:l.map(e=>{let t=[e.date||"",e.evaluator||"",e.agentName||e.agent||"",e.group||"",e.callId||"",e.score||0,e.feedback||"",e.status||e.durum||"",e.agentNote||"",e.managerReply||"",e.callDate||""],a=[];try{a="string"==typeof e.details?JSON.parse(e.details):e.details||[],Array.isArray(a)||(a=[])}catch(e){a=[]}return o.forEach(e=>{const n=a.find(t=>t.q===e);n?(t.push(n.score),t.push(n.note||"")):(t.push(""),t.push(""))}),t}),fileName:`Evaluations_${t.targetPeriod}.xls`}}case"updateEvaluation":{const{error:e}=await sb.from("Evaluations").update({CallDate:t.callDate,Score:t.score,Details:t.details,Feedback:t.feedback,Durum:t.status}).eq("CallID",t.callId);if(e)throw e;return saveLog("DeÄŸerlendirme GÃ¼ncelleme",`CallID: ${t.callId}`),{result:"success"}}case"markEvaluationSeen":{const{error:e}=await sb.from("Evaluations").update({Okundu:!0}).eq("CallID",t.callId);if(e)throw e;return saveLog("DeÄŸerlendirme Okundu Ä°ÅŸaretleme",`CallID: ${t.callId}`),{result:"success"}}case"getTrainings":{const e=localStorage.getItem("sSportUser")||"",a=localStorage.getItem("sSportGroup")||"",n=!!t.asAdmin,{data:i,error:l}=await sb.from("Trainings").select("*").order("Date",{ascending:!1});if(l)throw l;let r=new Set;try{const{data:t,error:a}=await sb.from("Training_Logs").select("*").eq("Username",e);!a&&Array.isArray(t)&&t.forEach(e=>{const t=String(e.Status||"").toLowerCase();"completed"!==t&&"tamamlandi"!==t&&"tamamlandÄ±"!==t&&1!==e.Status&&!0!==e.Status||r.add(String(e.TrainingID))})}catch(e){}const s=(i||[]).filter(t=>{if(n)return!0;const i=String(t.TargetGroup||"").toLowerCase(),l=String(t.TargetUser||"").toLowerCase(),r=String(t.Status||"").toLowerCase();return(!r||"aktif"===r||"active"===r)&&(!i||"all"===i||"herkes"===i||("group"===i||"grup"===i?String(a||"").toLowerCase()===l:"individual"===i||"bireysel"===i?String(e||"").toLowerCase()===l:String(a||"").toLowerCase()===i))});return{result:"success",trainings:s.map(e=>{const t=normalizeKeys(e);t.title=t.title||e.Title||"",t.desc=t.desc||e.Description||"",t.link=t.link||e.ContentLink||"",t.docLink=t.docLink||e.DocLink||"",t.target=t.target||e.TargetGroup||"All",t.targetUser=t.targetUser||e.TargetUser||"",t.creator=t.creator||e.CreatedBy||"",t.startDate=t.startDate||e.StartDate||"",t.endDate=t.endDate||e.EndDate||"",t.duration=t.duration||e.Duration||"",t.date=t.date||formatDateToDDMMYYYY(e.Date);const a=String(e.id||e.ID||t.id||"");return t.isCompleted=r.has(a),t})}}case"startTraining":{const e=localStorage.getItem("sSportUser")||"",a=t.trainingId,{data:n}=await sb.from("Training_Logs").select("*").eq("TrainingID",a).eq("Username",e).maybeSingle();if(n&&"completed"===String(n.Status||"").toLowerCase())return{result:"success"};const{error:i}=await sb.from("Training_Logs").upsert([{TrainingID:a,Username:e,Status:"started",Date:(new Date).toISOString()}],{onConflict:"TrainingID,Username"});if(i)throw i;return saveLog("EÄŸitim BaÅŸlatma",`ID: ${t.trainingId}`),{result:"success"}}case"completeTraining":{const e=localStorage.getItem("sSportUser")||"",a=t.trainingId,{error:n}=await sb.from("Training_Logs").upsert([{TrainingID:a,Username:e,Status:"completed",Date:(new Date).toISOString()}],{onConflict:"TrainingID,Username"});if(n)throw n;return saveLog("EÄŸitim Tamamlama",`ID: ${t.trainingId}`),{result:"success"}}case"assignTraining":{const e={Title:t.title||"",Description:t.desc||"",ContentLink:t.link||"",DocLink:t.docLink||"",TargetGroup:t.target||"All",TargetUser:t.targetAgent||"",CreatedBy:t.creator||localStorage.getItem("sSportUser")||"",StartDate:t.startDate||"",EndDate:t.endDate||"",Duration:t.duration||"",Status:"Aktif",Date:(new Date).toISOString()},{error:a}=await sb.from("Trainings").insert([e]);if(a)throw a;return saveLog("EÄŸitim Atama",`${t.title} -> ${t.target}`),{result:"success"}}case"getUserList":{const{data:e,error:t}=await sb.from("profiles").select("*");if(t)return{result:"success",users:[]};return{result:"success",users:(e||[]).map(e=>({id:e.id,username:e.username||e.email,name:e.full_name||e.username,role:e.role,group:e.group||e.group_name}))}}case"getCriteria":{let e=sb.from("Settings").select("*");t.group&&(e=e.eq("Grup",t.group));const{data:a,error:n}=await e.order("Sira",{ascending:!0});if(n)throw n;return{result:"success",criteria:(a||[]).map(normalizeKeys).filter(e=>e.text)}}case"getShiftData":{const{data:e,error:t}=await sb.from("Vardiya").select("*");if(t)throw t;if(!e||0===e.length)return{result:"success",shifts:{}};const a=["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma","Cumartesi","Pazar"],n=e.map(e=>({name:e.Temsilci||e.temsilci||e.Name||e.username||"-",cells:a.map(t=>e[t]||"")})),i=n.find(e=>String(e.name).trim().toLowerCase()===String(currentUser).trim().toLowerCase());return{result:"success",shifts:{headers:a,rows:n,myRow:i,weekLabel:"HaftalÄ±k Vardiya PlanÄ±"}}}case"submitShiftRequest":{const{error:e}=await sb.from("ShiftRequests").insert([{username:currentUser,...t,timestamp:(new Date).toISOString()}]);if(e)throw e;return saveLog("Vardiya Talebi GÃ¶nderme",`${currentUser} -> ${t.date} ${t.shift}`),{result:"success"}}case"fetchFeedbackLogs":{const{data:e,error:t}=await sb.from("Feedback_Logs").select("*");if(t)throw t;return{result:"success",feedbackLogs:(e||[]).map(normalizeKeys)}}case"getTelesalesOffers":{const{data:e,error:t}=await sb.from("Telesatis_DataTeklifleri").select("*");return{result:"success",data:(e||[]).map(normalizeKeys)}}case"saveAllTelesalesOffers":{await sb.from("Telesatis_DataTeklifleri").delete().neq("id",-1);const e=(t.offers||[]).map(e=>({Segment:e.segment||"","Teklif AdÄ±":e.title||"","AÃ§Ä±klama":e.desc||"",Not:e.note||"",Durum:e.status||"Aktif","GÃ¶rsel":e.image||""})),{error:a}=await sb.from("Telesatis_DataTeklifleri").insert(e);return saveLog("TelesatÄ±ÅŸ Teklifleri GÃ¼ncelleme",`${e.length} teklif kaydedildi.`),{result:a?"error":"success"}}case"getTelesalesScripts":{const{data:e,error:t}=await sb.from("Telesatis_Scripts").select("*");return{result:"success",items:(e||[]).map(normalizeKeys)}}case"saveTelesalesScripts":{const{scripts:e}=t;await sb.from("Telesatis_Scripts").delete().neq("id",-1);const{error:a}=await sb.from("Telesatis_Scripts").insert((e||[]).map(e=>({"BaÅŸlÄ±k":e.title||"",Metin:e.text||"",UpdatedAt:(new Date).toISOString(),UpdatedBy:localStorage.getItem("sSportUser")||""})));return saveLog("TelesatÄ±ÅŸ Script GÃ¼ncelleme",`${e.length} script kaydedildi.`),{result:a?"error":"success"}}case"getTechDocs":{const{data:e,error:t}=await sb.from("Teknik_Dokumanlar").select("*");return{result:"success",data:(e||[]).map(normalizeKeys)}}case"getTechDocCategories":{const{data:e,error:t}=await sb.from("Teknik_Dokumanlar").select("Kategori");return{result:"success",categories:[...new Set(e.filter(e=>e.Kategori).map(e=>e.Kategori))]}}case"upsertTechDoc":{const{data:e}=await sb.from("Teknik_Dokumanlar").select("*").limit(1),a=e&&e[0]?Object.keys(e[0]):[],n=e=>{for(let t of e){const e=a.find(e=>e.toLowerCase()===t.toLowerCase());if(e)return e}return null},i={},l=(e,t)=>{const a=n(e);a&&(i[a]=t)};t.id&&l(["id","ID"],t.id),l(["Kategori","Category"],t.kategori),l(["BaÅŸlÄ±k","Baslik","Title"],t.baslik),l(["Ä°Ã§erik","Icerik","Content"],t.icerik),l(["AdÄ±m","Adim","Step"],t.adim||""),l(["Not","Note"],t.not||""),l(["Link"],t.link||""),l(["GÃ¶rsel","Gorsel","Image","Resim"],t.image||null),l(["Durum","Status"],t.durum||"Aktif");const{error:r}=await sb.from("Teknik_Dokumanlar").upsert(i,{onConflict:n(["id","ID"])||"id"});return r?(console.error("[Pusula] upsertTechDoc error:",r),{result:"error",message:r.message}):(saveLog("Teknik DÃ¶kÃ¼man KayÄ±t",`${t.baslik} (${t.kategori})`),{result:"success"})}case"updateHomeBlock":{const{error:e}=await sb.from("HomeBlocks").upsert({Key:t.key,Title:t.title,Content:t.content,VisibleGroups:t.visibleGroups},{onConflict:"Key"});if(e)throw e;return saveLog("Blok Ä°Ã§erik GÃ¼ncelleme",`${t.key}`),{result:e?"error":"success"}}case"updateDoc":{const{error:e}=await sb.from("Teknik_Dokumanlar").update({"BaÅŸlÄ±k":t.title,"Ä°Ã§erik":t.content,Kategori:t.category,"GÃ¶rsel":t.image,Link:t.link}).eq("id",t.id);return{result:e?"error":"success"}}case"getActiveUsers":{const e=new Date(Date.now()-864e5).toISOString(),{data:t,error:a}=await sb.from("profiles").select("*").gt("last_seen",e).order("last_seen",{ascending:!1});if(a)return console.error("Active Users Error:",a),{result:"error",message:"Veri Ã§ekilemedi: "+a.message};return{result:"success",users:(t||[]).map(e=>({username:e.username,role:e.role,group:e.group||e.group_name,last_seen:e.last_seen,id:e.id}))}}case"logAction":{const{error:e}=await sb.from("Logs").insert([{Username:t.username||currentUser,Action:t.action,Details:t.details,"Ä°P ADRESÄ°":t.ip||"-",Date:(new Date).toISOString()}]);return{result:e?"error":"success"}}case"submitAgentNote":{const{error:e}=await sb.from("Evaluations").update({"Temsilci Notu":t.note,Durum:t.status||"Bekliyor"}).ilike("CallID",String(t.callId).replace("#","").trim());return e&&console.error("[Pusula Note Error]",e),{result:e?"error":"success",message:e?e.message:""}}case"logQuiz":{const{error:e}=await sb.from("QuizResults").insert([{Username:t.username,Score:t.score,TotalQuestions:t.total,SuccessRate:t.successRate,Date:(new Date).toISOString()}]);return e&&console.error("[Pusula Quiz Error]",e),{result:e?"error":"success"}}case"getLogs":{const{data:e,error:t}=await sb.from("Logs").select("*").order("Date",{ascending:!1}).limit(500);if(t)throw t;return{result:"success",logs:e}}case"resolveAgentFeedback":{const{error:e}=await sb.from("Evaluations").update({"YÃ¶netici CevabÄ±":t.reply,Durum:t.status||"TamamlandÄ±"}).ilike("CallID",String(t.callId).replace("#","").trim());return{result:e?"error":"success"}}case"getBroadcastFlow":{const{data:e,error:t}=await sb.from("YayinAkisi").select("*");return t?(console.warn("[Pusula] BroadcastFlow fetch error:",t),{result:"success",items:[]}):{result:"success",items:(e||[]).map(normalizeKeys)}}case"uploadImage":case"uploadTrainingDoc":{const{fileName:a,mimeType:n,base64:i}=t,l=b64toBlob(i,n);if(!l)throw new Error("Dosya iÅŸlenemedi (Base64 HatasÄ±)");const r="uploadImage"===e?"images":"trainings",s=`${r}/${Date.now()}_${a}`,{data:o,error:d}=await sb.storage.from("pusula").upload(s,l,{contentType:n,cacheControl:"3600",upsert:!1});if(d)throw d;const{data:c}=sb.storage.from("pusula").getPublicUrl(s);return saveLog("Dosya YÃ¼kleme",`${a} (${r})`),{result:"success",url:c.publicUrl}}case"deleteTechDoc":{const{error:e}=await sb.from("Teknik_Dokumanlar").delete().eq("id",t.id);return e?(console.error("[Pusula] deleteTechDoc error:",e),{result:"error",message:e.message}):(saveLog("Teknik DÃ¶kÃ¼man Silme",`ID: ${t.id}`),{result:"success"})}default:return console.warn(`[Pusula] Bilinmeyen apiCall action: ${e}`),{result:"error",message:`Hizmet taÅŸÄ±nÄ±yor: ${e}`}}}catch(t){return console.error(`[Pusula] apiCall Error (${e}):`,t),{result:"error",message:t.message}}}"undefined"==typeof Swal&&(window.Swal={fire:(e,t,a)=>{try{alert(e&&e.title||e||t||a||"")}catch(e){}}});let jokers={call:1,half:1,double:1},doubleChanceUsed=!1,firstAnswerIndex=-1;const VALID_CATEGORIES=["Teknik","Ä°kna","Kampanya","Bilgi"],MONTH_NAMES=["Ocak","Åžubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];let __dataLoadedResolve,database=[],newsData=[],sportsData=[],salesScripts=[],quizQuestions=[],quickDecisionQuestions=[];window.__dataLoadedPromise=new Promise(e=>{__dataLoadedResolve=e});let sessionTimeout,techWizardData={},currentUser="",currentUserId="",globalUserIP="",isAdminMode=!1,isLocAdmin=!1,isEditingActive=!1,activeRole="",allRolePermissions=[],adminUserList=[],activeCards=[],currentCategory="home",allEvaluationsData=[],trainingData=[],feedbackLogsData=[],homeBlocks={};async function loadHomeBlocks(){try{const{data:e,error:t}=await sb.from("HomeBlocks").select("*");if(t)throw t;homeBlocks={},e.forEach(e=>{const t=normalizeKeys(e),a=(t.key||e.Key||t.blockId||e.BlockId||e.id||"").toString().toLowerCase();a&&(homeBlocks[a]=t)}),console.log("[Pusula] HomeBlocks yÃ¼klendi:",Object.keys(homeBlocks));try{localStorage.setItem("homeBlocksCache",JSON.stringify(homeBlocks||{}))}catch(e){}try{renderHomePanels()}catch(e){}return homeBlocks}catch(e){console.error("[Pusula] HomeBlocks Fetch Error:",e);try{homeBlocks=JSON.parse(localStorage.getItem("homeBlocksCache")||"{}")||{}}catch(e){homeBlocks={}}try{renderHomePanels()}catch(e){}return homeBlocks}}function normalizeRole(e){return String(e||"").trim().toLowerCase()}function normalizeGroup(e){if(!e)return"";let t=String(e).trim().toLowerCase().replace(/iÌ‡/g,"i").replace(/Ä±/g,"i").replace(/ÅŸ/g,"s").replace(/ÄŸ/g,"g").replace(/Ã¼/g,"u").replace(/Ã¶/g,"o").replace(/Ã§/g,"c");return t.charAt(0).toUpperCase()+t.slice(1)}function normalizeList(e){return e?String(e).split(",").map(e=>e.trim()).filter(Boolean):[]}function getMyGroup(){return normalizeGroup(localStorage.getItem("sSportGroup")||"")}function getMyRole(){return normalizeRole(localStorage.getItem("sSportRole")||"")}function enterBas(e){"Enter"===e.key&&girisYap()}let sessionInterval,heartbeatInterval,wizardStepsData={},dashboardChart=null,dashTrendChart=null,dashChannelChart=null,dashScoreDistChart=null,dashGroupAvgChart=null;function getToken(){return localStorage.getItem("sSportToken")}function setHomeWelcomeUser(e){try{const t=document.getElementById("home-welcome-user");t&&(t.textContent=e||"Misafir")}catch(e){}}function getFavs(){return JSON.parse(localStorage.getItem("sSportFavs")||"[]")}function toggleFavorite(e){event.stopPropagation();let t=getFavs();t.includes(e)?t=t.filter(t=>t!==e):t.push(e),localStorage.setItem("sSportFavs",JSON.stringify(t));try{const a=t.includes(e);Swal.fire({toast:!0,position:"top-end",icon:a?"success":"info",title:a?"Favorilere eklendi":"Favorilerden kaldÄ±rÄ±ldÄ±",showConfirmButton:!1,timer:1200})}catch(e){}"fav"===currentCategory?filterCategory(document.querySelector(".btn-fav"),"fav"):renderCards(activeCards);try{updateSearchResultCount(activeCards.length||0,database.length)}catch(e){}}function isFav(e){return getFavs().includes(e)}function formatDateToDDMMYYYY(e){if(!e)return"N/A";if(e.match(/^\d{2}\.\d{2}\.\d{4}/))return e.split(" ")[0];try{const t=new Date(e);if(isNaN(t.getTime()))return e;const a=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0");return`${a}.${n}.${t.getFullYear()}`}catch(t){return e}}function processImageUrl(e){if(!e)return"";try{let t="";const a=e.match(/\/d\/([-\w]+)/)||e.match(/id=([-\w]+)/);if(a&&a[1]&&(t=a[1]),t&&e.includes("drive.google.com"))return"https://drive.google.com/thumbnail?id="+t+"&sz=w1000"}catch(e){}return e}function parseDateTRToTS(e){try{if(!e)return 0;const t=String(e).split(" ")[0];if(t.includes(".")){const e=t.split(".");if(e.length>=3){const t=parseInt(e[0],10),a=parseInt(e[1],10),n=parseInt(e[2],10);return new Date(n,a-1,t).getTime()||0}}return new Date(e).getTime()||0}catch(e){return 0}}function isNew(e){if(!e)return!1;let t;if(e.indexOf(".")>-1){const a=e.split(" ")[0].split(".");t=new Date(a[2],a[1]-1,a[0])}else t=new Date(e);if(isNaN(t.getTime()))return!1;const a=new Date,n=Math.abs(a-t);return Math.ceil(n/864e5)<=3}function getCategorySelectHtml(e,t){let a=VALID_CATEGORIES.map(t=>`<option value="${t}" ${t===e?"selected":""}>${t}</option>`).join("");return e&&!VALID_CATEGORIES.includes(e)&&(a=`<option value="${e}" selected>${e} (Hata)</option>`+a),`<select id="${t}" class="swal2-input" style="width:100%; margin-top:5px;">${a}</select>`}function escapeForJsString(e){return e?e.toString().replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,""):""}function copyScriptContent(e){copyText(decodeURIComponent(e))}function copyText(e){const t=document.createElement("textarea");t.value=e.replace(/\\n/g,"\n"),document.body.appendChild(t),t.select();try{document.execCommand("copy"),Swal.fire({icon:"success",title:"KopyalandÄ±",toast:!0,position:"top-end",showConfirmButton:!1,timer:1500})}catch(e){Swal.fire({icon:"error",title:"KopyalanamadÄ±",text:"LÃ¼tfen manuel kopyalayÄ±n.",toast:!0,position:"top-end",showConfirmButton:!1,timer:2500})}document.body.removeChild(t)}async function checkSession(){const{data:{session:e},error:t}=await sb.auth.getSession();if(!e||t){console.log("[Pusula] Oturum bulunamadÄ±, giriÅŸ ekranÄ±na yÃ¶nlendiriliyor."),logout();try{document.getElementById("app-preloader").style.display="none"}catch(e){}return}const a=e.user;currentUserId=a.id;let n="user",i="Genel",l=a.email?a.email.split("@")[0]:"KullanÄ±cÄ±";try{const{data:e,error:t}=await sb.from("profiles").select("*").eq("id",a.id).single();if(e){if(n=e.role||"user",i=e.group||e.group_name||"Genel",l=e.username||l,e.force_logout)return await sb.from("profiles").update({force_logout:!1}).eq("id",a.id),logout(),void Swal.fire("Oturum KapandÄ±","YÃ¶netici tarafÄ±ndan Ã§Ä±kÄ±ÅŸÄ±nÄ±z saÄŸlandÄ±.","warning");if(e.must_change_password)return document.getElementById("login-screen").style.display="none",document.getElementById("app-preloader").style.display="none",void changePasswordPopup(!0)}}catch(e){console.warn("Profil Ã§ekilemedi, metadata kullanÄ±lÄ±yor.",e),n=a.user_metadata.role||"user",l=a.user_metadata.username||l}if(currentUser=l,activeRole=n,localStorage.setItem("sSportGroup",i),document.getElementById("login-screen").style.display="none",document.getElementById("user-display").innerText=currentUser,setHomeWelcomeUser(currentUser),checkAdmin(activeRole),startSessionTimer(),localStorage.setItem("sSportUser",currentUser),localStorage.setItem("sSportRole",activeRole),"admin"===activeRole||"locadmin"===activeRole)try{fetchUserListForAdmin()}catch(e){}document.getElementById("main-app").style.removeProperty("display"),document.getElementById("main-app").style.display="block",loadPermissionsOnStartup().then(()=>{loadHomeBlocks(),loadContentData(),loadWizardData(),loadTechWizardData()});try{document.getElementById("app-preloader").style.display="none"}catch(e){}}function enterBas(e){"Enter"===e.key&&girisYap()}async function girisYap(){const e=document.getElementById("usernameInput").value.trim(),t=document.getElementById("passInput").value.trim(),a=document.getElementById("loading-msg"),n=document.getElementById("error-msg");if(!e||!t)return n.innerText="LÃ¼tfen e-posta ve ÅŸifrenizi giriniz.",void(n.style.display="block");let i=e;if(i.includes("@")||(i+="@ssportplus.com"),!i.includes("@"))return n.innerText="LÃ¼tfen geÃ§erli bir e-posta adresi giriniz.",void(n.style.display="block");a.style.display="block",a.innerText="Oturum aÃ§Ä±lÄ±yor...",n.style.display="none",document.querySelector(".login-btn").disabled=!0;try{const{data:e,error:n}=await sb.auth.signInWithPassword({email:i,password:t});if(n)throw n;console.log("GiriÅŸ BaÅŸarÄ±lÄ±:",e),await checkSession(),a.style.display="none",document.querySelector(".login-btn").disabled=!1;try{apiCall("logAction",{action:"GiriÅŸ",details:"Supabase Auth Login",username:i})}catch(e){console.warn("Log hatasÄ±:",e)}}catch(e){console.error("Login Error:",e),a.style.display="none",document.querySelector(".login-btn").disabled=!1,n.innerText="GiriÅŸ baÅŸarÄ±sÄ±z: "+("Invalid global failure"===e.message?"Bilgiler hatalÄ±.":e.message),n.style.display="block"}}async function logout(){try{await sb.auth.signOut()}catch(e){console.error("Logout error:",e)}localStorage.removeItem("sSportUser"),localStorage.removeItem("sSportToken"),localStorage.removeItem("sSportRole"),localStorage.removeItem("sSportGroup"),document.getElementById("login-screen").style.removeProperty("display"),document.getElementById("login-screen").style.display="flex",document.getElementById("main-app").style.display="none";try{document.getElementById("app-preloader").style.display="none"}catch(e){}console.log("[Pusula] Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±.")}async function forgotPasswordPopup(){const{value:e}=await Swal.fire({title:"Åžifre SÄ±fÄ±rlama",input:"email",inputLabel:"E-posta Adresiniz",inputPlaceholder:"ornek@ssportplus.com",showCancelButton:!0,confirmButtonText:"SÄ±fÄ±rlama Linki GÃ¶nder",cancelButtonText:"Ä°ptal"});if(e){Swal.fire({title:"GÃ¶nderiliyor...",didOpen:()=>{Swal.showLoading()}});try{const{error:t}=await sb.auth.resetPasswordForEmail(e,{redirectTo:window.location.origin});if(t)throw t;Swal.fire("BaÅŸarÄ±lÄ±","Åžifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± e-posta adresinize gÃ¶nderildi.","success")}catch(e){console.error("Forgot Pass Error:",e),Swal.fire("Hata",e.message||"Ä°ÅŸlem baÅŸarÄ±sÄ±z.","error")}}}function checkAdmin(e){const t=document.getElementById("dropdownAddCard"),a=document.getElementById("dropdownImage"),n=document.getElementById("dropdownQuickEdit");activeRole=e,isAdminMode="admin"===e||"locadmin"===e,isLocAdmin="locadmin"===e,isEditingActive=!1,document.body.classList.remove("editing"),isAdminMode?(t&&(t.style.display="flex"),a&&(a.style.display="flex"),n&&(n.style.display="flex")):(t&&(t.style.display="none"),a&&(a.style.display="none"),n&&(n.style.display="none",n.innerHTML='<i class="fas fa-pen" style="color:var(--secondary);"></i> DÃ¼zenlemeyi AÃ§',n.classList.remove("active")),["dropdownPerms","dropdownActiveUsers","dropdownUserMgmt","dropdownLogs"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none")}));try{applyPermissionsToUI()}catch(e){}}function logout(){currentUser="",currentUserId="",isAdminMode=!1,isEditingActive=!1;try{document.getElementById("user-display").innerText="Misafir"}catch(e){}setHomeWelcomeUser("Misafir"),document.body.classList.remove("editing"),localStorage.clear(),sessionTimeout&&clearTimeout(sessionTimeout),document.getElementById("main-app").style.display="none",document.getElementById("login-screen").style.display="flex",document.getElementById("passInput").value="",document.getElementById("usernameInput").value="",document.getElementById("error-msg").style.display="none",document.getElementById("quality-fullscreen").style.display="none";try{document.getElementById("tech-fullscreen").style.display="none"}catch(e){}try{document.getElementById("telesales-fullscreen").style.display="none"}catch(e){}}async function sendHeartbeat(){if(currentUser)try{if(!currentUserId)return;const{data:e,error:t}=await sb.from("profiles").update({last_seen:(new Date).toISOString()}).eq("id",currentUserId).select("force_logout").single();if(e&&!0===e.force_logout)return await sb.from("profiles").update({force_logout:!1}).eq("id",currentUserId),void Swal.fire({icon:"error",title:"Oturum SonlandÄ±rÄ±ldÄ±",text:"YÃ¶netici tarafÄ±ndan sistemden Ã§Ä±karÄ±ldÄ±nÄ±z.",allowOutsideClick:!1,confirmButtonText:"Tamam"}).then(()=>{logout()})}catch(e){console.warn("Heartbeat failed",e)}}function startSessionTimer(){sessionInterval&&clearInterval(sessionInterval),heartbeatInterval&&clearInterval(heartbeatInterval),sendHeartbeat(),heartbeatInterval=setInterval(()=>{sendHeartbeat()},3e4),sessionTimeout=setTimeout(()=>{Swal.fire({icon:"warning",title:"Oturum SÃ¼resi Doldu",text:"GÃ¼venlik nedeniyle otomatik Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±.",confirmButtonText:"Tamam"}).then(()=>{logout()})},288e5)}function openUserMenu(){toggleUserDropdown()}async function changePasswordPopup(e=!1){const{value:t}=await Swal.fire({title:e?"âš ï¸ GÃ¼venlik UyarÄ±sÄ±":"Åžifre DeÄŸiÅŸtir",text:e?"YÃ¶netici tarafÄ±ndan ÅŸifrenizi deÄŸiÅŸtirmeniz istendi. LÃ¼tfen yeni bir ÅŸifre belirleyiniz.":"",input:"password",inputLabel:"Yeni Åžifreniz",inputPlaceholder:"En az 6 karakter",showCancelButton:!e,confirmButtonText:"GÃ¼ncelle",cancelButtonText:"Ä°ptal",allowOutsideClick:!e,allowEscapeKey:!e,icon:e?"warning":"info",inputValidator:e=>{if(!e||e.length<6)return"Åžifre en az 6 karakter olmalÄ±dÄ±r!"}});if(t){Swal.fire({title:"GÃ¼ncelleniyor...",didOpen:()=>{Swal.showLoading()}});try{const{error:a}=await sb.auth.updateUser({password:t});if(a)throw a;e&&await sb.from("profiles").update({must_change_password:!1}).eq("id",currentUserId),Swal.fire({icon:"success",title:"BaÅŸarÄ±lÄ±",text:"Åžifreniz gÃ¼ncellendi. LÃ¼tfen yeni ÅŸifrenizle giriÅŸ yapÄ±n.",confirmButtonText:"Tamam"}).then(()=>{e&&logout()})}catch(t){Swal.fire("Hata","Åžifre gÃ¼ncellenemedi: "+t.message,"error"),e&&setTimeout(()=>changePasswordPopup(!0),2e3)}}else e&&changePasswordPopup(!0)}async function loadContentData(){try{console.log("[Pusula] Fetching data from Supabase...");const{data:e,error:t}=await sb.from("Data").select("*");if(t)throw t;processRawData(e||[]),console.log("[Pusula] Data loaded successfully."),"function"==typeof __dataLoadedResolve&&__dataLoadedResolve(),"function"==typeof filterContent&&filterContent(),"function"==typeof startTicker&&startTicker()}catch(e){console.error("[Pusula] Supabase Fetch Error:",e),apiCall("getData").then(e=>processRawData(e.data)).catch(()=>{})}}function processRawData(e){if(Array.isArray(e)){database=[],newsData=[],sportsData=[],salesScripts=[],quizQuestions=[],quickDecisionQuestions=[],e.forEach(e=>{const t=(e.Type||"").toLowerCase();(e.Category||"").toLowerCase();if(["card","bilgi","teknik","kampanya","ikna"].includes(t))database.push({title:e.Title,category:e.Category,text:e.Text,script:e.Script,code:e.Code,link:e.Link,image:e.Image,date:formatDateToDDMMYYYY(e.Date)});else if("news"===t)newsData.push({date:formatDateToDDMMYYYY(e.Date),title:e.Title,desc:e.Text,type:e.Category,status:e.Status,image:e.Image});else if("sport"===t)sportsData.push({title:e.Title,icon:e.Icon,desc:e.Text,tip:e.Tip,detail:e.Detail,pronunciation:e.Pronunciation});else if("sales"===t)salesScripts.push({title:e.Title,text:e.Text});else if("quiz"===t)quizQuestions.push({q:e.Text,opts:e.QuizOptions?e.QuizOptions.split(",").map(e=>e.trim()):[],a:parseInt(e.QuizAnswer)});else if("quickdecision"===t){const t=String(e.QuizOptions||"").split("|").map(e=>e.trim()).filter(Boolean);let a=parseInt(e.QuizAnswer,10);isNaN(a)&&(a=0),a<0&&(a=0),t.length&&a>=t.length&&(a=t.length-1);const n=(e.Detail||"").toString().trim();(e.Text||"").toString().trim()&&Array.isArray(t)&&t.length>=2&&quickDecisionQuestions.push({q:(e.Text||"").toString().trim(),opts:t,a:a,exp:n})}}),database.sort((e,t)=>parseDateTRToTS(t.date)-parseDateTRToTS(e.date)),newsData.sort((e,t)=>parseDateTRToTS(t.date)-parseDateTRToTS(e.date));try{applySportsRights()}catch(e){}"fav"===currentCategory?filterCategory(document.querySelector(".btn-fav"),"fav"):(activeCards=database,"home"===currentCategory?showHomeScreen():(hideHomeScreen(),renderCards(database))),startTicker();try{updateSearchResultCount(activeCards.length||database.length,database.length)}catch(e){}}}async function loadContentData(){const e="sSportContentCache";let t=!1;try{const a=localStorage.getItem(e);if(a){const e=JSON.parse(a);e&&Array.isArray(e)&&e.length>0&&(console.log("[Cache] Veriler Ã¶nbellekten yÃ¼klendi."),document.getElementById("loading").style.display="none",processRawData(e),t=!0)}}catch(e){}t||(document.getElementById("loading").style.display="block");try{const{data:a,error:n}=await sb.from("Data").select("*");if(n)throw n;t||(document.getElementById("loading").style.display="none"),localStorage.setItem(e,JSON.stringify(a)),processRawData(a)}catch(e){console.error("[Pusula] Supabase Load error:",e),t||(document.getElementById("loading").innerHTML="Veriler yÃ¼klenirken bir hata oluÅŸtu: "+e.message)}finally{"function"==typeof __dataLoadedResolve&&__dataLoadedResolve()}}async function loadWizardData(){try{const{data:e,error:t}=await sb.from("WizardSteps").select("*");if(t)throw t;wizardStepsData={},(e||[]).map(normalizeKeys).forEach(e=>{if(!e.stepId)return;const t=String(e.stepId).trim(),a=[];let n=e.options||"";n&&String(n).split(",").forEach(e=>{const t=e.trim().split("|");t.length>=2&&a.push({text:t[0].trim(),next:t[1].trim(),style:t[2]?t[2].trim():"primary"})}),wizardStepsData[t]={title:e.title||e.Title||"",text:e.text||e.Text||"",script:e.script||"",result:e.result||"",alert:e.alert||"",options:a}}),console.log("[Wizard] Data Loaded:",Object.keys(wizardStepsData).length,"steps")}catch(e){console.error("[Pusula] Wizard Fetch Error:",e)}}async function loadTechWizardData(){try{const{data:e,error:t}=await sb.from("TechWizardSteps").select("*");if(t)throw t;techWizardData={},(e||[]).map(normalizeKeys).forEach(e=>{if(!e.stepId)return;const t=String(e.stepId).trim(),a=[];let n=e.options||"";n&&String(n).split(",").forEach(e=>{const t=e.trim().split("|");t.length>=2&&a.push({text:t[0].trim(),next:t[1].trim(),style:t[2]?t[2].trim():"primary"})}),techWizardData[t]={title:e.title||e.Title||"",text:e.text||e.Text||"",script:e.script||"",alert:e.alert||"",result:e.result||"",buttons:a,options:a}}),console.log("[TechWizard] Data Loaded:",Object.keys(techWizardData).length,"steps")}catch(e){console.error("[Pusula] TechWizard Fetch Error:",e)}}window.v2_setScore=function(e,t,a,n){const i=document.getElementById(`criteria-${e}`),l=document.getElementById(`note-row-${e}`);i.querySelectorAll(".eval-btn-v2").forEach(e=>e.classList.remove("active"));const r=i.querySelector(`.eval-btn-v2.${n}`);r&&r.classList.add("active");const s=Number(t)<Number(a);l&&(l.style.display=s?"block":"none");const o=document.getElementById(`note-${e}`);o&&!l&&(o.style.display=s?"block":"none"),s?i.classList.add("failed"):(o&&(o.value=""),i.classList.remove("failed")),i.setAttribute("data-current-score",t),window.v2_recalc()},window.v2_updateSlider=function(e,t){const a=document.getElementById(`criteria-${e}`),n=document.getElementById(`slider-${e}`),i=document.getElementById(`val-${e}`),l=document.getElementById(`note-row-${e}`);if(!n)return;const r=parseInt(n.value);i&&(i.innerText=`${r} / ${t}`);const s=Number(r)<Number(t);l&&(l.style.display=s?"block":"none");const o=document.getElementById(`note-${e}`);o&&!l&&(o.style.display=s?"block":"none"),s?a.classList.add("failed"):(o&&(o.value=""),a.classList.remove("failed")),window.v2_recalc()},window.v2_recalc=function(){let e=0;document.querySelectorAll(".criteria-item-v2").forEach(t=>{const a=t.querySelector('input[type="range"]');if(a)e+=parseInt(a.value)||0;else{const a=t.querySelector(".eval-btn-v2.active");a&&(e+=parseInt(a.getAttribute("data-score"))||0)}});const t=document.getElementById("v2-live-score");t&&(t.innerText=e,t.style.color=e>=90?"#2f855a":e>=75?"#ed8936":"#e53e3e")},window.setButtonScore=(e,t,a)=>window.v2_setScore(e,t,a,t===a?"good":0===t?"bad":"medium"),window.recalcTotalScore=()=>window.v2_recalc(),window.updateRowSliderScore=(e,t)=>window.v2_updateSlider(e,t),window.recalcTotalSliderScore=()=>window.v2_recalc(),document.addEventListener("contextmenu",e=>e.preventDefault()),document.onkeydown=function(e){if(123==e.keyCode)return!1},document.addEventListener("DOMContentLoaded",()=>{checkSession(),fetch("https://ipapi.co/json/").then(e=>e.json()).then(e=>{globalUserIP=`${e.ip} [${e.city||"-"}, ${e.region||"-"}]`}).catch(()=>{})});const DISPLAY_LIMIT=50;let currentDisplayCount=DISPLAY_LIMIT;function renderCards(e){try{activeCards=e;const t=document.getElementById("cardGrid");if(!t)return;if(0===e.length)return void(t.innerHTML='<div style="grid-column:1/-1; text-align:center; padding:20px; color:#777;">KayÄ±t bulunamadÄ±.</div>');currentDisplayCount=DISPLAY_LIMIT;const a=a=>{const n=e.slice(0,a).map((e,t)=>{const a=escapeForJsString(e.title),n=isFav(e.title)?"fas fa-star active":"far fa-star",i=isNew(e.date)?'<span class="new-badge">YENÄ°</span>':"",l=isAdminMode&&isEditingActive?`<i class="fas fa-pencil-alt edit-icon" onclick="editContent(${t})" style="display:block;"></i>`:"";let r=(e.text||"").replace(/\n/g,"<br>").replace(/\*(.*?)\*/g,"<b>$1</b>");const s=e.image?`<div style="margin-bottom:8px;"><img src="${processImageUrl(e.image)}" loading="lazy" onerror="this.style.display='none'" style="max-width:100%;border-radius:6px;max-height:150px;object-fit:cover;"></div>`:"";return`<div class="card ${e.category}">${i}\n                    <div class="icon-wrapper">${l}<i class="${n} fav-icon" onclick="toggleFavorite('${a}')"></i></div>\n                    <div class="card-header"><h3 class="card-title">${highlightText(e.title)}</h3><span class="badge">${e.category}</span></div>\n                    <div class="card-content" onclick="showCardDetailByIndex(${t})">\n                        ${s}\n                        <div class="card-text-truncate">${highlightText(r)}</div>\n                        <div style="font-size:0.8rem; color:#999; margin-top:5px; text-align:right;">(TamamÄ±nÄ± oku)</div>\n                    </div>\n                    <div class="script-box">${highlightText(e.script)}</div>\n                    <div class="card-actions">\n                        <button class="btn btn-copy" onclick="copyText('${escapeForJsString(e.script)}')"><i class="fas fa-copy"></i> Kopyala</button>\n                        ${e.code?`<button class="btn btn-copy" style="background:var(--secondary); color:#333;" onclick="copyText('${escapeForJsString(e.code)}')">Kod</button>`:""}\n                        ${e.link?`<a href="${e.link}" target="_blank" class="btn btn-link"><i class="fas fa-external-link-alt"></i> Link</a>`:""}\n                    </div>\n                </div>`});e.length>a&&n.push(`<div id="load-more-container" style="grid-column:1/-1; text-align:center; padding:20px;">\n                    <button class="btn" style="background:var(--primary); color:white; padding:10px 40px;" onclick="loadMoreCards()">Daha Fazla YÃ¼kle (${e.length-a} kaldÄ±)</button>\n                </div>`),t.innerHTML=n.join("")};a(currentDisplayCount),window.loadMoreCards=()=>{currentDisplayCount+=DISPLAY_LIMIT,a(currentDisplayCount)}}catch(e){console.error("[renderCards]",e)}}function highlightText(e){if(!e)return"";const t=document.getElementById("searchInput").value.toLocaleLowerCase("tr-TR").trim();if(!t)return e;try{const a=new RegExp(`(${t})`,"gi");return e.toString().replace(a,'<span class="highlight">$1</span>')}catch(t){return e}}function updateSearchResultCount(e,t){const a=document.getElementById("searchResultCount");if(!a)return;if(!(!!(document.getElementById("searchInput")?.value||"").trim()||currentCategory&&"all"!==currentCategory))return a.style.display="none",void(a.innerText="");a.style.display="block",a.innerText=`ðŸ”Ž ${e} sonuÃ§${null!=t?" / "+t:""}`}function filterCategory(e,t){if("home"===t)return currentCategory="home",setActiveFilterButton(e),void showHomeScreen();const a=String(t||"").toLowerCase();return a.includes("teknik")?(hideHomeScreen(),void openTechArea("broadcast")):a.includes("telesat")?(hideHomeScreen(),void openTelesalesArea()):(a.includes("kalite")&&hideHomeScreen(),currentCategory=t,hideHomeScreen(),document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),void filterContent())}function filterContent(){const e=document.getElementById("searchInput").value.toLocaleLowerCase("tr-TR").trim();if("home"===currentCategory){if(!e)return updateSearchResultCount(database.length,database.length),void showHomeScreen();hideHomeScreen()}let t=database;"fav"===currentCategory?t=t.filter(e=>isFav(e.title)):"all"!==currentCategory&&"home"!==currentCategory&&(t=t.filter(e=>e.category===currentCategory)),e&&(t=t.filter(t=>{const a=(t.title||"").toString().toLocaleLowerCase("tr-TR"),n=(t.text||"").toString().toLocaleLowerCase("tr-TR"),i=(t.script||"").toString().toLocaleLowerCase("tr-TR"),l=(t.code||"").toString().toLocaleLowerCase("tr-TR");return a.includes(e)||n.includes(e)||i.includes(e)||l.includes(e)})),activeCards=t,updateSearchResultCount(t.length,database.length),renderCards(t)}function showCardDetail(e,t){if(e&&"object"==typeof e){const t=e,a=t.title||t.name||"Detay",n=(t.text||t.desc||"").toString(),i=(t.script||"").toString(),l=(t.alert||"").toString(),r=(t.link||"").toString(),s=`\n          <div style="text-align:left; font-size:1rem; line-height:1.6; white-space:pre-line;">\n            ${escapeHtml(n).replace(/\n/g,"<br>")}\n            ${r?`<div style="margin-top:12px"><a href="${escapeHtml(r)}" target="_blank" rel="noreferrer" style="font-weight:800;color:var(--info);text-decoration:none"><i class="fas fa-link"></i> Link</a></div>`:""}\n            ${i?`<div class="tech-script-box" style="margin-top:12px">\n                <span class="tech-script-label">MÃ¼ÅŸteriye iletilecek:</span>${escapeHtml(i).replace(/\n/g,"<br>")}\n              </div>`:""}\n            ${l?`<div class="tech-alert" style="margin-top:12px">${escapeHtml(l).replace(/\n/g,"<br>")}</div>`:""}\n          </div>`;return void Swal.fire({title:a,html:s,showCloseButton:!0,showConfirmButton:!1,width:"820px",background:"#f8f9fa"})}const a=(t??"").toString();Swal.fire({title:e,html:`<div style="text-align:left; font-size:1rem; line-height:1.6;">${escapeHtml(a).replace(/\n/g,"<br>")}</div>`,showCloseButton:!0,showConfirmButton:!1,width:"600px",background:"#f8f9fa"})}function showCardDetailByIndex(e){const t=activeCards[e];if(!t)return;const a=t.title||"Detay",n=(t.text||"").toString(),i=(t.script||"").toString(),l=(t.link||"").toString(),r=(t.image||"").toString(),s=processImageUrl(r),o=`\n      <div style="text-align:left; font-size:1rem; line-height:1.6; white-space:pre-line;">\n        ${r?`<div style="margin-bottom:15px;text-align:center;"><img src="${escapeHtml(s)}" onerror="this.style.display='none'" style="max-width:100%;border-radius:8px;"></div>`:""}\n        ${escapeHtml(n).replace(/\n/g,"<br>")}\n        ${l?`<div style="margin-top:12px"><a href="${escapeHtml(l)}" target="_blank" rel="noreferrer" style="font-weight:800;color:var(--info);text-decoration:none"><i class="fas fa-link"></i> Link</a></div>`:""}\n        ${i?`<div class="tech-script-box" style="margin-top:12px">\n            <span class="tech-script-label">MÃ¼ÅŸteriye iletilecek:</span>${escapeHtml(i).replace(/\n/g,"<br>")}\n          </div>`:""}\n      </div>`;Swal.fire({title:a,html:o,showCloseButton:!0,showConfirmButton:!1,width:"820px",background:"#f8f9fa"})}function toggleEditMode(){if(!isAdminMode)return;isEditingActive=!isEditingActive,document.body.classList.toggle("editing",isEditingActive);const e=document.getElementById("dropdownQuickEdit");isEditingActive?(e.classList.add("active"),e.innerHTML='<i class="fas fa-times" style="color:var(--accent);"></i> DÃ¼zenlemeyi Kapat',Swal.fire({icon:"success",title:"DÃ¼zenleme Modu AÃ‡IK",text:"Kalem ikonlarÄ±na tÄ±klayarak iÃ§erikleri dÃ¼zenleyebilirsiniz.",timer:1500,showConfirmButton:!1})):(e.classList.remove("active"),e.innerHTML='<i class="fas fa-pen" style="color:var(--secondary);"></i> DÃ¼zenlemeyi AÃ§'),filterContent();try{"home"===currentCategory&&renderHomePanels()}catch(e){}"flex"===document.getElementById("quality-fullscreen").style.display&&openQualityArea(),"flex"===document.getElementById("shift-fullscreen").style.display&&openShiftArea(),"flex"===document.getElementById("guide-modal").style.display&&openGuide(),"flex"===document.getElementById("sales-modal").style.display&&openSales(),"flex"===document.getElementById("news-modal").style.display&&openNews()}async function sendUpdate(e,t,a,n="card"){Swal.isVisible()||Swal.fire({title:"Kaydediliyor...",didOpen:()=>{Swal.showLoading()}});try{const{error:n}=await sb.from("Data").update({[t]:a}).eq("Title",e);if(n)throw n;Swal.fire({icon:"success",title:"BaÅŸarÄ±lÄ±",timer:1500,showConfirmButton:!1}),setTimeout(loadContentData,1600)}catch(e){console.error("Update error:",e),Swal.fire("Hata","Kaydedilemedi: "+e.message,"error")}}async function addNewCardPopup(){const e=getCategorySelectHtml("Bilgi","swal-new-cat"),{value:t}=await Swal.fire({title:"Yeni Ä°Ã§erik Ekle",html:`\n        <div style="margin-bottom:15px; text-align:left;">\n            <label style="font-weight:bold; font-size:0.9rem;">Ne Ekleyeceksin?</label>\n            <select id="swal-type-select" class="swal2-input" style="width:100%; margin-top:5px; height:35px; font-size:0.9rem;" onchange="toggleAddFields()">\n                <option value="card"> ðŸ“Œ  Bilgi KartÄ±</option>\n                <option value="news"> ðŸ“¢  Duyuru</option>\n                <option value="sales"> ðŸ“ž  TelesatÄ±ÅŸ Scripti</option>\n                <option value="sport"> ðŸ†  Spor Ä°Ã§eriÄŸi</option>\n                <option value="quiz"> â“  Quiz Sorusu</option>\n            </select>\n        </div>\n        <div id="preview-card" class="card Bilgi" style="text-align:left; box-shadow:none; border:1px solid #e0e0e0; margin-top:10px;">\n            <div class="card-header" style="align-items: center; gap: 10px;">\n                <input id="swal-new-title" class="swal2-input" style="margin:0; height:40px; flex-grow:1; border:none; border-bottom:2px solid #eee; padding:0 5px; font-weight:bold; color:#0e1b42;" placeholder="BaÅŸlÄ±k Giriniz...">\n                <div id="cat-container" style="width: 110px;">${e}</div>\n            </div>\n            <div class="card-content" style="margin-bottom:10px;">\n                <textarea id="swal-new-text" class="swal2-textarea" style="margin:0; width:100%; box-sizing:border-box; border:none; resize:none; font-family:inherit; min-height:100px; padding:10px; background:#f9f9f9;" placeholder="Ä°Ã§erik metni..."></textarea>\n            </div>\n            <div id="script-container" class="script-box" style="padding:0; border:1px solid #f0e68c;">\n                <textarea id="swal-new-script" class="swal2-textarea" style="margin:0; width:100%; box-sizing:border-box; border:none; background:transparent; font-style:italic; min-height:80px; font-size:0.9rem;" placeholder="Script metni (Ä°steÄŸe baÄŸlÄ±)..."></textarea>\n            </div>\n            <div id="extra-container" class="card-actions" style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">\n                <div style="position:relative;"><i class="fas fa-code" style="position:absolute; left:10px; top:10px; color:#aaa;"></i><input id="swal-new-code" class="swal2-input" style="margin:0; height:35px; font-size:0.85rem; padding-left:30px;" placeholder="Kod"></div>\n                <div style="position:relative;"><i class="fas fa-link" style="position:absolute; left:10px; top:10px; color:#aaa;"></i><input id="swal-new-link" class="swal2-input" style="margin:0; height:35px; font-size:0.85rem; padding-left:30px;" placeholder="Link"></div>\n            </div>\n            <div id="sport-extra" style="display:none; padding:10px;">\n                <label style="font-weight:bold;">KÄ±sa AÃ§Ä±klama (Desc)</label><input id="swal-sport-tip" class="swal2-input" placeholder="KÄ±sa Ä°pucu/Tip">\n                <label style="font-weight:bold;">DetaylÄ± Metin (Detail)</label><input id="swal-sport-detail" class="swal2-input" placeholder="DetaylÄ± AÃ§Ä±klama (Alt Metin)">\n                <label style="font-weight:bold;">OkunuÅŸu (Pronunciation)</label><input id="swal-sport-pron" class="swal2-input" placeholder="OkunuÅŸu">\n                <label style="font-weight:bold;">Ä°kon SÄ±nÄ±fÄ± (Icon)</label><input id="swal-sport-icon" class="swal2-input" placeholder="FontAwesome Ä°kon SÄ±nÄ±fÄ± (e.g., fa-futbol)">\n            </div>\n            <div id="news-extra" style="display:none; padding:10px;">\n                <label style="font-weight:bold;">Duyuru Tipi</label><select id="swal-news-type" class="swal2-input"><option value="info">Bilgi</option><option value="update">DeÄŸiÅŸiklik</option><option value="fix">Ã‡Ã¶zÃ¼ldÃ¼</option></select>\n                <label style="font-weight:bold;">Durum</label><select id="swal-news-status" class="swal2-input"><option value="Aktif">Aktif</option><option value="Pasif">Pasif (Gizle)</option></select>\n            </div>\n            <div id="quiz-extra" style="display:none; padding:10px;">\n                <label style="font-weight:bold;">Soru Metni (Text)</label><textarea id="swal-quiz-q" class="swal2-textarea" placeholder="Quiz sorusu..."></textarea>\n                <label style="font-weight:bold;">SeÃ§enekler (VirgÃ¼lle AyÄ±rÄ±n)</label><input id="swal-quiz-opts" class="swal2-input" placeholder="Ã–rn: ÅŸÄ±k A,ÅŸÄ±k B,ÅŸÄ±k C,ÅŸÄ±k D">\n                <label style="font-weight:bold;">DoÄŸru Cevap Ä°ndeksi</label><input id="swal-quiz-ans" type="number" class="swal2-input" placeholder="0 (A), 1 (B), 2 (C) veya 3 (D)" min="0" max="3">\n            </div>\n        </div>`,width:"700px",showCancelButton:!0,confirmButtonText:'<i class="fas fa-plus"></i> Ekle',cancelButtonText:"Ä°ptal",focusConfirm:!1,didOpen:()=>{const e=document.getElementById("swal-new-cat"),t=document.getElementById("preview-card");e.style.margin="0",e.style.height="30px",e.style.fontSize="0.8rem",e.style.padding="0 5px",e.addEventListener("change",function(){t.className="card "+this.value}),window.toggleAddFields=function(){const e=document.getElementById("swal-type-select").value,t=document.getElementById("cat-container"),a=document.getElementById("script-container"),n=document.getElementById("extra-container"),i=document.getElementById("sport-extra"),l=document.getElementById("news-extra"),r=document.getElementById("quiz-extra"),s=document.getElementById("preview-card");t.style.display="none",a.style.display="none",n.style.display="none",i.style.display="none",l.style.display="none",r.style.display="none",document.getElementById("swal-new-title").value="",document.getElementById("swal-new-text").value="",s.style.borderLeft="5px solid var(--info)",s.className="card Bilgi","card"===e?(t.style.display="block",a.style.display="block",n.style.display="grid",s.className="card "+document.getElementById("swal-new-cat").value,document.getElementById("swal-new-title").placeholder="BaÅŸlÄ±k Giriniz...",document.getElementById("swal-new-text").placeholder="Ä°Ã§erik metni..."):"sales"===e?(a.style.display="block",document.getElementById("swal-new-script").placeholder="SatÄ±ÅŸ Metni...",s.style.borderLeft="5px solid var(--sales)",document.getElementById("swal-new-title").placeholder="Script BaÅŸlÄ±ÄŸÄ±...",document.getElementById("swal-new-text").placeholder="Sadece buraya metin girilecek."):"sport"===e?(i.style.display="block",s.style.borderLeft="5px solid var(--primary)",document.getElementById("swal-new-title").placeholder="Spor Terimi BaÅŸlÄ±ÄŸÄ±...",document.getElementById("swal-new-text").placeholder="KÄ±sa AÃ§Ä±klama (Desc)..."):"news"===e?(l.style.display="block",s.style.borderLeft="5px solid var(--secondary)",document.getElementById("swal-new-title").placeholder="Duyuru BaÅŸlÄ±ÄŸÄ±...",document.getElementById("swal-new-text").placeholder="Duyuru Metni (Desc)..."):"quiz"===e&&(r.style.display="block",document.getElementById("swal-new-title").placeholder="Quiz BaÅŸlÄ±ÄŸÄ± (Ã–rn: Soru 1)",document.getElementById("swal-new-text").placeholder="Bu alan boÅŸ bÄ±rakÄ±lacak.",s.style.borderLeft="5px solid var(--quiz)")}},preConfirm:()=>{const e=document.getElementById("swal-type-select").value,t=new Date,a=t.getDate()+"."+(t.getMonth()+1)+"."+t.getFullYear(),n="quiz"===e?document.getElementById("swal-quiz-opts").value:"",i="quiz"===e?document.getElementById("swal-quiz-ans").value:"",l="quiz"===e?document.getElementById("swal-quiz-q").value:"";return"quiz"!==e||l&&n&&""!==i?{cardType:e,category:"card"===e?document.getElementById("swal-new-cat").value:"news"===e?document.getElementById("swal-news-type").value:"",title:document.getElementById("swal-new-title").value,text:"quiz"===e?l:document.getElementById("swal-new-text").value,script:"card"===e||"sales"===e?document.getElementById("swal-new-script").value:"",code:"card"===e?document.getElementById("swal-new-code").value:"",status:"news"===e?document.getElementById("swal-news-status").value:"",link:"card"===e?document.getElementById("swal-new-link").value:"",tip:"sport"===e?document.getElementById("swal-sport-tip").value:"",detail:"sport"===e?document.getElementById("swal-sport-detail").value:"",pronunciation:"sport"===e?document.getElementById("swal-sport-pron").value:"",icon:"sport"===e?document.getElementById("swal-sport-icon").value:"",date:a,quizOptions:n,quizAnswer:i}:(Swal.showValidationMessage("Quiz sorusu iÃ§in tÃ¼m alanlar zorunludur."),!1)}});if(t){if(!t.title)return void Swal.fire("Hata","BaÅŸlÄ±k zorunlu!","error");Swal.fire({title:"Ekleniyor...",didOpen:()=>{Swal.showLoading()}});try{const e=await apiCall("logCard",{type:t.cardType,category:t.category,title:t.title,text:t.text,script:t.script,code:t.code,status:t.status,link:t.link,tip:t.tip,detail:t.detail,pronunciation:t.pronunciation,icon:t.icon,date:new Date,quizOptions:t.quizOptions,quizAnswer:t.quizAnswer});if("success"!==e.result)throw new Error(e.message||"Eklenemedi");Swal.fire({icon:"success",title:"BaÅŸarÄ±lÄ±",text:"Ä°Ã§erik eklendi.",timer:2e3,showConfirmButton:!1}),setTimeout(loadContentData,3500)}catch(e){console.error("Add content error:",e),Swal.fire("Hata",e.message||"Eklenemedi.","error")}}}async function editContent(e){const t=activeCards[e],a=getCategorySelectHtml(t.category,"swal-cat"),{value:n}=await Swal.fire({title:"KartÄ± DÃ¼zenle",html:`\n        <div id="preview-card-edit" class="card ${t.category}" style="text-align:left; box-shadow:none; border:1px solid #e0e0e0; margin-top:10px;">\n            <div class="card-header" style="align-items: center; gap: 10px;">\n                <input id="swal-title" class="swal2-input" style="margin:0; height:40px; flex-grow:1; border:none; border-bottom:2px solid #eee; padding:0 5px; font-weight:bold; color:#0e1b42;" value="${t.title}" placeholder="BaÅŸlÄ±k">\n                <div style="width: 110px;">${a}</div>\n            </div>\n            <div class="card-content" style="margin-bottom:10px;">\n                <textarea id="swal-text" class="swal2-textarea" style="margin:0; width:100%; box-sizing:border-box; border:none; resize:none; font-family:inherit; min-height:120px; padding:10px; background:#f9f9f9;" placeholder="Ä°Ã§erik metni...">${(t.text||"").toString().replace(/<br>/g,"\n")}</textarea>\n            </div>\n            <div class="script-box" style="padding:0; border:1px solid #f0e68c;">\n                <textarea id="swal-script" class="swal2-textarea" style="margin:0; width:100%; box-sizing:border-box; border:none; background:transparent; font-style:italic; min-height:80px; font-size:0.9rem;" placeholder="Script metni...">${(t.script||"").toString().replace(/<br>/g,"\n")}</textarea>\n            </div>\n            <div class="card-actions" style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">\n                <div style="position:relative;"><i class="fas fa-code" style="position:absolute; left:10px; top:10px; color:#aaa;"></i><input id="swal-code" class="swal2-input" style="margin:0; height:35px; font-size:0.85rem; padding-left:30px;" value="${t.code||""}" placeholder="Kod"></div>\n                <div style="position:relative;"><i class="fas fa-link" style="position:absolute; left:10px; top:10px; color:#aaa;"></i><input id="swal-link" class="swal2-input" style="margin:0; height:35px; font-size:0.85rem; padding-left:30px;" value="${t.link||""}" placeholder="Link"></div>\n                <div style="position:relative;grid-column: 1 / -1;"><i class="fas fa-image" style="position:absolute; left:10px; top:10px; color:#aaa;"></i><input id="swal-image" class="swal2-input" style="margin:0; height:35px; font-size:0.85rem; padding-left:30px; width: 100%; box-sizing: border-box;" value="${t.image||""}" placeholder="GÃ¶rsel Linki (Drive vb.)"></div>\n            </div>\n        </div>`,width:"700px",showCancelButton:!0,confirmButtonText:'<i class="fas fa-save"></i> Kaydet',cancelButtonText:"Ä°ptal",focusConfirm:!1,didOpen:()=>{const e=document.getElementById("swal-cat"),t=document.getElementById("preview-card-edit");e.style.margin="0",e.style.height="30px",e.style.fontSize="0.8rem",e.style.padding="0 5px",e.addEventListener("change",function(){t.className="card "+this.value})},preConfirm:()=>({cat:document.getElementById("swal-cat").value,title:document.getElementById("swal-title").value,text:document.getElementById("swal-text").value,script:document.getElementById("swal-script").value,code:document.getElementById("swal-code").value,link:document.getElementById("swal-link").value,image:document.getElementById("swal-image").value})});n&&(n.cat!==t.category&&sendUpdate(t.title,"Category",n.cat,"card"),n.text!==(t.text||"").replace(/<br>/g,"\n")&&setTimeout(()=>sendUpdate(t.title,"Text",n.text,"card"),500),n.script!==(t.script||"").replace(/<br>/g,"\n")&&setTimeout(()=>sendUpdate(t.title,"Script",n.script,"card"),1e3),n.code!==(t.code||"")&&setTimeout(()=>sendUpdate(t.title,"Code",n.code,"card"),1500),n.link!==(t.link||"")&&setTimeout(()=>sendUpdate(t.title,"Link",n.link,"card"),2e3),n.image!==(t.image||"")&&setTimeout(()=>sendUpdate(t.title,"Image",n.image,"card"),2250),n.title!==t.title&&setTimeout(()=>sendUpdate(t.title,"Title",n.title,"card"),2500))}async function editSport(e){event.stopPropagation();const t=sportsData.find(t=>t.title===e);if(!t)return Swal.fire("Hata","Ä°Ã§erik bulunamadÄ±.","error");const{value:a}=await Swal.fire({title:"Spor Ä°Ã§eriÄŸini DÃ¼zenle",html:`\n        <div class="card" style="text-align:left; border-left: 5px solid var(--primary); padding:15px; background:#f8f9fa;">\n            <label style="font-weight:bold;">BaÅŸlÄ±k</label><input id="swal-title" class="swal2-input" style="width:100%; margin-bottom:10px;" value="${t.title}">\n            <label style="font-weight:bold;">AÃ§Ä±klama (KÄ±sa)</label><textarea id="swal-desc" class="swal2-textarea" style="margin-bottom:10px;">${t.desc||""}</textarea>\n            <label style="font-weight:bold;">Ä°pucu (Tip)</label><input id="swal-tip" class="swal2-input" style="width:100%; margin-bottom:10px;" value="${t.tip||""}">\n            <label style="font-weight:bold;">Detay (Alt Metin)</label><textarea id="swal-detail" class="swal2-textarea" style="margin-bottom:10px;">${t.detail||""}</textarea>\n            <label style="font-weight:bold;">OkunuÅŸu</label><input id="swal-pron" class="swal2-input" style="width:100%; margin-bottom:10px;" value="${t.pronunciation||""}">\n            <label style="font-weight:bold;">Ä°kon SÄ±nÄ±fÄ±</label><input id="swal-icon" class="swal2-input" style="width:100%;" value="${t.icon||""}">\n        </div>`,width:"700px",showCancelButton:!0,confirmButtonText:"Kaydet",preConfirm:()=>[document.getElementById("swal-title").value,document.getElementById("swal-desc").value,document.getElementById("swal-tip").value,document.getElementById("swal-detail").value,document.getElementById("swal-pron").value,document.getElementById("swal-icon").value]});if(a){const e=t.title;a[1]!==t.desc&&sendUpdate(e,"Text",a[1],"sport"),a[2]!==t.tip&&setTimeout(()=>sendUpdate(e,"Tip",a[2],"sport"),500),a[3]!==t.detail&&setTimeout(()=>sendUpdate(e,"Detail",a[3],"sport"),1e3),a[4]!==t.pronunciation&&setTimeout(()=>sendUpdate(e,"Pronunciation",a[4],"sport"),1500),a[5]!==t.icon&&setTimeout(()=>sendUpdate(e,"Icon",a[5],"sport"),2e3),a[0]!==e&&setTimeout(()=>sendUpdate(e,"Title",a[0],"sport"),2500)}}async function editSales(e){event.stopPropagation();const t=salesScripts.find(t=>t.title===e);if(!t)return Swal.fire("Hata","Ä°Ã§erik bulunamadÄ±.","error");const{value:a}=await Swal.fire({title:"SatÄ±ÅŸ Metnini DÃ¼zenle",html:`<div class="card" style="text-align:left; border-left: 5px solid var(--sales); padding:15px; background:#ecfdf5;"><label style="font-weight:bold;">BaÅŸlÄ±k</label><input id="swal-title" class="swal2-input" style="width:100%; margin-bottom:10px;"\n        value="${t.title}"><label style="font-weight:bold;">Metin</label><textarea id="swal-text" class="swal2-textarea" style="min-height:150px;">${t.text||""}</textarea></div>`,width:"700px",showCancelButton:!0,confirmButtonText:"Kaydet",preConfirm:()=>[document.getElementById("swal-title").value,document.getElementById("swal-text").value]});if(a){const e=t.title;a[1]!==t.text&&sendUpdate(e,"Text",a[1],"sales"),a[0]!==e&&setTimeout(()=>sendUpdate(e,"Title",a[0],"sales"),500)}}async function editNews(e){const t=newsData[e];let a=`<option value="Aktif" ${"Pasif"!==t.status?"selected":""}>Aktif</option><option value="Pasif" ${"Pasif"===t.status?"selected":""}>Pasif</option>`,n=`<option value="info" ${"info"===t.type?"selected":""}>Bilgi</option><option value="update" ${"update"===t.type?"selected":""}>DeÄŸiÅŸiklik</option><option value="fix" ${"fix"===t.type?"selected":""}>Ã‡Ã¶zÃ¼ldÃ¼</option>`;const{value:i}=await Swal.fire({title:"Duyuruyu DÃ¼zenle",html:`<div class="card" style="text-align:left; border-left: 5px solid var(--secondary); padding:15px; background:#fff8e1;"><label style="font-weight:bold;">BaÅŸlÄ±k</label><input id="swal-title" class="swal2-input" style="width:100%; margin-bottom:10px;"\n        value="${t.title||""}"><div style="display:flex; gap:10px; margin-bottom:10px;"><div style="flex:1;"><label style="font-weight:bold;">Tarih</label><input id="swal-date" class="swal2-input" style="width:100%;"\n        value="${t.date||""}"></div><div style="flex:1;"><label style="font-weight:bold;">TÃ¼r</label><select id="swal-type" class="swal2-input" style="width:100%;">${n}</select></div></div><label style="font-weight:bold;">Metin</label><textarea id="swal-desc" class="swal2-textarea" style="margin-bottom:10px;">${t.desc||""}</textarea><label style="font-weight:bold;">GÃ¶rsel Linki</label><input id="swal-image" class="swal2-input" style="width:100%; margin-bottom:10px;" value="${t.image||""}" placeholder="GÃ¶rsel URL (opsiyonel)"><label style="font-weight:bold;">Durum</label><select id="swal-status" class="swal2-input" style="width:100%;">${a}</select></div>`,width:"600px",showCancelButton:!0,confirmButtonText:"Kaydet",preConfirm:()=>[document.getElementById("swal-title").value,document.getElementById("swal-date").value,document.getElementById("swal-desc").value,document.getElementById("swal-type").value,document.getElementById("swal-status").value,document.getElementById("swal-image").value]});if(i){const e=t.title;i[1]!==t.date&&sendUpdate(e,"Date",i[1],"news"),i[2]!==t.desc&&setTimeout(()=>sendUpdate(e,"Text",i[2],"news"),500),i[3]!==t.type&&setTimeout(()=>sendUpdate(e,"Category",i[3],"news"),1e3),i[4]!==t.status&&setTimeout(()=>sendUpdate(e,"Status",i[4],"news"),1500),i[5]!==(t.image||"")&&setTimeout(()=>sendUpdate(e,"Image",i[5],"news"),1750),i[0]!==e&&setTimeout(()=>sendUpdate(e,"Title",i[0],"news"),2e3)}}function closeModal(e){document.getElementById(e).style.display="none"}function startTicker(){const e=document.getElementById("ticker-content"),t=newsData.filter(e=>"Pasif"!==e.status);if(0===t.length)return e.innerHTML="GÃ¼ncel duyuru yok.",void(e.style.animation="none");let a=t.map(e=>`<span style="color:#fabb00; font-weight:bold;">[${e.date}]</span> <span style="color:#fff;">${e.title}:</span> <span style="color:#ddd;">${e.desc}</span>`).join(" &nbsp;&nbsp;&nbsp;&nbsp; â€¢ &nbsp;&nbsp;&nbsp;&nbsp; ");e.innerHTML=a+" &nbsp;&nbsp;&nbsp;&nbsp; â€¢ &nbsp;&nbsp;&nbsp;&nbsp; "+a;const n=(e.innerText||e.textContent).length;let i=Math.max(30,Math.round(n/6));e.style.animation=`ticker-scroll ${i}s linear infinite`}function openNews(){document.getElementById("news-modal").style.display="flex";const e=document.getElementById("news-container");e.innerHTML="",newsData.forEach((t,a)=>{let n="fix"===t.type?"tag-fix":"update"===t.type?"tag-update":"tag-info",i="fix"===t.type?"Ã‡Ã¶zÃ¼ldÃ¼":"update"===t.type?"DeÄŸiÅŸiklik":"Bilgi",l="Pasif"===t.status?"opacity:0.5; background:#eee;":"",r="Pasif"===t.status?'<span class="news-tag" style="background:#555; color:white;">PASÄ°F</span>':"",s=isAdminMode&&isEditingActive?`<i class="fas fa-pencil-alt edit-icon" style="top:0; right:0; font-size:0.9rem; padding:4px;" onclick="event.stopPropagation(); editNews(${a})"></i>`:"",o=t.image?`<div style="margin:10px 0;"><img src="${processImageUrl(t.image)}" loading="lazy" onerror="this.style.display='none'" style="max-width:100%; border-radius:8px; max-height:300px; object-fit:cover;"></div>`:"";e.innerHTML+=`<div class="news-item" style="${l}">${s}<span class="news-date">${t.date}</span><span class="news-title">${t.title} ${r}</span>${o}<div class="news-desc" style="white-space: pre-line">${t.desc}</div><span class="news-tag ${n}">${i}</span></div>`})}async function fetchBroadcastFlow(){try{const{data:e,error:t}=await sb.from("YayinAkisi").select("*");if(t)throw t;return(e||[]).map(normalizeKeys)}catch(e){return console.error("[Pusula] YayinAkisi Fetch Error:",e),[]}}async function openBroadcastFlow(){Swal.fire({title:"YayÄ±n AkÄ±ÅŸÄ±",html:"",didOpen:()=>Swal.showLoading(),showConfirmButton:!1});try{const e=await fetchBroadcastFlow();if(!e||!e.length)return void Swal.fire("YayÄ±n AkÄ±ÅŸÄ±","KayÄ±t bulunamadÄ±.","info");const t=[...e].sort((e,t)=>{const a=Number(e?.startEpoch||0),n=Number(t?.startEpoch||0);if(a&&n)return a-n;const i=String(e?.dateISO||e?.date||"")+" "+String(e?.time||""),l=String(t?.dateISO||t?.date||"")+" "+String(t?.time||"");return i.localeCompare(l)}),a=Date.now(),n={},i={};t.forEach(e=>{const t=String(e?.dateISO||e?.date||"Tarih Yok");n[t]||(n[t]=[]),n[t].push(e),i[t]||(i[t]=String(e?.dateLabelTr||""))});let l=`${"\n      <style>\n        .ba-wrap{ text-align:left; max-height:62vh; overflow:auto; padding-right:6px; }\n        .ba-day{ margin:14px 0 8px; font-weight:900; color:#0e1b42; display:flex; align-items:center; gap:10px; }\n\n        .ba-section{ margin:16px 0 8px; font-weight:900; color:#0e1b42; font-size:1rem; }\n        .ba-divider{ margin:14px 0; height:1px; background:#e9e9e9; }\n        .ba-empty{ padding:10px 12px; border:1px dashed #ddd; border-radius:12px; background:#fafafa; color:#666; margin:10px 0; font-weight:700; }\n        .ba-badge{ font-size:.75rem; padding:4px 8px; border-radius:999px; border:1px solid #e9e9e9; background:#f8f8f8; color:#444; }\n        .ba-grid{ display:grid; gap:8px; }\n        .ba-row{\n          border:1px solid #eee;\n          border-left:4px solid var(--secondary);\n          border-radius:12px;\n          padding:10px 12px;\n          background:#fff;\n        }\n        .ba-row.past{\n          border-left-color:#d9534f;\n          background:#fff5f5;\n        }\n        .ba-top{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }\n        .ba-title{ font-weight:900; color:#222; line-height:1.25; }\n        .ba-time{ font-weight:900; color:#0e1b42; white-space:nowrap; }\n        .ba-sub{ margin-top:6px; font-size:.86rem; color:#666; display:flex; gap:14px; flex-wrap:wrap; }\n        .ba-legend{ display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 10px; }\n        .ba-dot{ display:inline-flex; align-items:center; gap:6px; font-size:.8rem; color:#444; }\n        .ba-dot i{ width:10px; height:10px; border-radius:50%; display:inline-block; }\n        .ba-dot .up{ background:var(--secondary); }\n        .ba-dot .pa{ background:#d9534f; }\n      </style>\n    "}${""}<div class="ba-wrap">`;l+='\n      <div class="ba-legend">\n        <span class="ba-dot"><i class="up"></i> YaklaÅŸan / Gelecek</span>\n        <span class="ba-dot"><i class="pa"></i> Tarihi GeÃ§miÅŸ</span>\n      </div>\n    ';const r={},s={},o=Object.keys(n);o.forEach(e=>{(n[e]||[]).forEach(t=>{const n=Number(t?.startEpoch||0),i=!!n&&n<a?s:r;i[e]||(i[e]=[]),i[e].push(t)})});const d=(e,t,n)=>{const r=o.filter(e=>t[e]&&t[e].length);r.length?(l+=`<div class="ba-section">${escapeHtml(e)}</div>`,r.forEach(e=>{const n=i[e]||_formatBroadcastDateTr({dateISO:e});l+=`<div class="ba-day">${escapeHtml(n)}</div>`,l+='<div class="ba-grid">',t[e].forEach(e=>{const t=Number(e?.startEpoch||0),n=!!t&&t<a,i=String(e?.time||"").trim(),r=String(e?.event||"").trim(),s=String(e?.announcer||"").trim();l+=`\n            <div class="ba-row ${n?"past":""}">\n              <div class="ba-top">\n                <div class="ba-title">${escapeHtml(r||"-")}</div>\n                <div class="ba-time">${escapeHtml(i||"")}</div>\n              </div>\n              <div class="ba-sub">\n                <span><i class="fas fa-microphone"></i> ${escapeHtml(s||"-")}</span>\n                ${e.date?`<span><i class="far fa-calendar"></i> ${escapeHtml(e.date)}</span>`:""}\n              </div>\n            </div>`}),l+="</div>"})):l+=`<div class="ba-empty">${escapeHtml(n)}</div>`};d("YaklaÅŸan / Gelecek",r,"YaklaÅŸan yayÄ±n bulunamadÄ±."),l+='<div class="ba-divider"></div>',d("GeÃ§miÅŸ",s,"GeÃ§miÅŸ yayÄ±n bulunamadÄ±."),l+="</div>",Swal.fire({title:"YayÄ±n AkÄ±ÅŸÄ±",html:l,width:980,confirmButtonText:"Kapat"})}catch(e){Swal.fire("Hata",e?.message||"YayÄ±n akÄ±ÅŸÄ± alÄ±namadÄ±.","error")}}function _formatBroadcastDateTr(e){if(e&&e.dateLabelTr)return String(e.dateLabelTr);const t=String(e?.dateISO||e?.date||"").trim();if(!t)return"Tarih Yok";const a=t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);if(a){const e=new Date(Number(a[1]),Number(a[2])-1,Number(a[3]));return new Intl.DateTimeFormat("tr-TR",{day:"2-digit",month:"long",year:"numeric",weekday:"long"}).format(e)}const n=t.match(/^(\d{1,2})[\./-](\d{1,2})[\./-](\d{4})/);if(n){const e=new Date(Number(n[3]),Number(n[2])-1,Number(n[1]));return new Intl.DateTimeFormat("tr-TR",{day:"2-digit",month:"long",year:"numeric",weekday:"long"}).format(e)}return t}function escapeHtml(e){return String(e??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const __escapeHtml=escapeHtml,_escapeHtml=escapeHtml;function dlog(e,t){(isAdminMode||isLocAdmin)&&(t?console.log(`[Pusula Debug] ${e}`,t):console.log(`[Pusula Debug] ${e}`))}function safeLocalStorageSet(e,t,a=4194304){try{const n=JSON.stringify(t);if(2*n.length>a){try{Swal.fire("UyarÄ±","Veri Ã§ok bÃ¼yÃ¼k, kaydedilemedi","warning")}catch(e){}return!1}return localStorage.setItem(e,n),!0}catch(e){if(!e||"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name)dlog("[safeLocalStorageSet]",e);else try{Swal.fire("Hata","Depolama alanÄ± dolu","error")}catch(e){}return!1}}function safeLocalStorageGet(e,t=null){try{const a=localStorage.getItem(e);return null==a?t:JSON.parse(a)}catch(e){return t}}const storage={set:(e,t)=>safeLocalStorageSet(e,t),get:(e,t=null)=>safeLocalStorageGet(e,t),del:e=>{try{localStorage.removeItem(e)}catch(e){}}};function openGuide(){document.getElementById("guide-modal").style.display="flex";const e=document.getElementById("guide-grid");e.innerHTML="",sportsData.forEach((t,a)=>{let n=t.pronunciation?`<div class="pronunciation-badge"> ðŸ—£ï¸  ${t.pronunciation}</div>`:"",i=isAdminMode&&isEditingActive?`<i class="fas fa-pencil-alt edit-icon" style="top:5px; right:5px; z-index:50;" onclick="event.stopPropagation(); editSport('${escapeForJsString(t.title)}')"></i>`:"";e.innerHTML+=`<div class="guide-item" onclick="showSportDetail(${a})">${i}<i class="fas ${t.icon} guide-icon"></i><span class="guide-title">${t.title}</span>${n}<div class="guide-desc" style="white-space: pre-line">${t.desc}</div><div class="guide-tip"><i class="fas fa-lightbulb"></i> ${t.tip}</div><div style="font-size:0.8rem; color:#999; margin-top:5px;">(Detay iÃ§in tÄ±kla)</div></div>`})}function showSportDetail(e){const t=sportsData[e],a=t.detail?t.detail.replace(/\n/g,"<br>"):"Bu iÃ§erik iÃ§in henÃ¼z detay eklenmemiÅŸ.",n=t.pronunciation?`<div style="color:#e65100; font-weight:bold; margin-bottom:15px;"> ðŸ—£ï¸  OkunuÅŸu: ${t.pronunciation}</div>`:"";Swal.fire({title:`<i class="fas ${t.icon}" style="color:#0e1b42;"></i> ${t.title}`,html:`${n}<div style="text-align:left; font-size:1rem; line-height:1.6;">${a}</div>`,showCloseButton:!0,showConfirmButton:!1,width:"600px",background:"#f8f9fa"})}function openSales(){openTelesalesArea()}function toggleSales(e){const t=document.getElementById(`sales-${e}`),a=document.getElementById(`icon-${e}`);t.classList.toggle("active"),t.classList.contains("active")?a.classList.replace("fa-chevron-down","fa-chevron-up"):a.classList.replace("fa-chevron-up","fa-chevron-down")}window.addEventListener("error",function(e){try{(isAdminMode||isLocAdmin)&&dlog("[Global Error]",e&&(e.error||e.message)?e.error||e.message:e)}catch(e){}try{"function"==typeof showGlobalError&&showGlobalError("Beklenmeyen hata: "+(e&&e.message?e.message:"Bilinmeyen"))}catch(e){}}),window.addEventListener("unhandledrejection",function(e){try{(isAdminMode||isLocAdmin)&&dlog("[Unhandled Promise]",e&&e.reason?e.reason:e)}catch(e){}try{"function"==typeof showGlobalError&&showGlobalError("Beklenmeyen hata: "+(e&&e.reason&&e.reason.message?e.reason.message:"Bilinmeyen"))}catch(e){}});let pScore=0,pBalls=10,pCurrentQ=null,pQuestionQueue=[],pAskedCount=0,pCorrectCount=0,pWrongCount=0;function setDoubleIndicator(e){const t=document.getElementById("double-indicator");t&&(t.style.display=e?"inline-flex":"none")}function updateJokerButtons(){const e=document.getElementById("joker-call"),t=document.getElementById("joker-half"),a=document.getElementById("joker-double");e&&(e.disabled=0===jokers.call),t&&(t.disabled=0===jokers.half),a&&(a.disabled=0===jokers.double||-1!==firstAnswerIndex),-1!==firstAnswerIndex&&(e&&(e.disabled=!0),t&&(t.disabled=!0),a&&(a.disabled=!0))}function useJoker(e){if(!pCurrentQ)return;if(0===jokers[e])return;if(-1!==firstAnswerIndex&&"double"!==e)return;jokers[e]=0,updateJokerButtons();const t=pCurrentQ,a=t.a,n=document.querySelectorAll(".penalty-btn");if("call"===e){const e=["Umut Bey","DoÄŸuÅŸ Bey","Deniz Bey","Esra HanÄ±m"],n=e[Math.floor(Math.random()*e.length)];let i=a;if(Math.random()>.8&&t.opts.length>1){const e=t.opts.map((e,t)=>t).filter(e=>e!==a);i=e[Math.floor(Math.random()*e.length)]??a}Swal.fire({icon:"info",title:" ðŸ“ž Telefon Jokeri",html:`${n} soruyu cevaplÄ±yor...<br><br>"Benim tahminim **${String.fromCharCode(65+i)}** ÅŸÄ±kkÄ±. Bundan ${Math.random()<.8?"Ã§ok eminim":"emin deÄŸilim"}."`,confirmButtonText:"Kapat"})}else if("half"===e){const e=Array.isArray(t.opts)?t.opts.length:0;if(e<=2)return void Swal.fire({icon:"info",title:"âœ‚ï¸ 50:50",text:"Bu soruda 50:50 uygulanamaz.",toast:!0,position:"top",showConfirmButton:!1,timer:1800});const i=e>=4?2:1;t.opts.map((e,t)=>t).filter(e=>e!==a).sort(()=>Math.random()-.5).slice(0,i).forEach(e=>{const t=n[e];t&&(t.disabled=!0,t.style.textDecoration="line-through",t.style.opacity="0.4")}),Swal.fire({icon:"success",title:" âœ‚ï¸ 50:50",text:2===i?"Ä°ki yanlÄ±ÅŸ ÅŸÄ±k elendi!":"Bir yanlÄ±ÅŸ ÅŸÄ±k elendi!",toast:!0,position:"top",showConfirmButton:!1,timer:1400})}else"double"===e&&(doubleChanceUsed=!0,setDoubleIndicator(!0),Swal.fire({icon:"warning",title:"2ï¸ âƒ£ Ã‡ift Cevap",text:"Bir kez yanlÄ±ÅŸ cevap hakkÄ±n var.",toast:!0,position:"top",showConfirmButton:!1,timer:2200}))}function openGameHub(){document.getElementById("game-hub-modal").style.display="flex"}function openQuickDecisionGame(){try{closeModal("game-hub-modal")}catch(e){}document.getElementById("quick-modal").style.display="flex";const e=document.getElementById("qd-lobby"),t=document.getElementById("qd-game");e&&(e.style.display="block"),t&&(t.style.display="none");const a=document.getElementById("qd-time");a&&(a.innerText="30");const n=document.getElementById("qd-score");n&&(n.innerText="0");const i=document.getElementById("qd-step");i&&(i.innerText="0")}let qdTimer=null,qdTimeLeft=30,qdScore=0,qdStep=0,qdQueue=[];const QUICK_DECISION_BANK=[{q:'MÃ¼ÅŸteri: "Fiyat pahalÄ±, iptal edeceÄŸim." Ä°lk yaklaÅŸÄ±mÄ±n ne olmalÄ±?',opts:["Hemen iptal iÅŸlemini baÅŸlatalÄ±m.","HaklÄ±sÄ±nÄ±z, sizi anlÄ±yorum. Paket/avantajlara gÃ¶re alternatif sunayÄ±m mÄ±?","Kampanya yok, yapacak bir ÅŸey yok."],a:1,exp:"Empati + ihtiyaÃ§ analizi itirazÄ± yumuÅŸatÄ±r ve iknayÄ± artÄ±rÄ±r."},{q:'MÃ¼ÅŸteri: "Uygulama aÃ§Ä±lmÄ±yor." En hÄ±zlÄ± ilk kontrol ne?',opts:["Åžifreyi sÄ±fÄ±rlat.","Ä°nternet baÄŸlantÄ±sÄ± / VPN / DNS kontrolÃ¼ yaptÄ±r.","Hemen cihazÄ± fabrika ayarlarÄ±na dÃ¶ndÃ¼r."],a:1,exp:"Ã–nce kÃ¶k nedeni daralt: baÄŸlantÄ± mÄ± uygulama mÄ±? BÃ¼yÃ¼k adÄ±mlarÄ± sona bÄ±rak."},{q:'MÃ¼ÅŸteri: "YayÄ±n donuyor." Teknikte doÄŸru soru hangisi?',opts:["Hangi cihazda (TV/telefon) ve hangi aÄŸda (Wiâ€‘Fi/kablo) oluyor?","KaÃ§ gÃ¼ndÃ¼r bÃ¶yle?","Åžimdi kapatÄ±p aÃ§Ä±n."],a:0,exp:"Cihaz + aÄŸ bilgisi, sorunu hÄ±zlÄ± izole etmeyi saÄŸlar."},{q:'MÃ¼ÅŸteri: "Ä°ade istiyorum." En doÄŸru yÃ¶nlendirme?',opts:["Hemen kapatalÄ±m.","Ä°ade koÅŸullarÄ± ve adÄ±mlarÄ± net anlat, doÄŸru kanala yÃ¶nlendir (asistan/rehber).","Tekrar arayÄ±n."],a:1,exp:"Net sÃ¼reÃ§ + doÄŸru kanal = memnuniyet + tekrar aramayÄ± azaltÄ±r."},{q:'MÃ¼ÅŸteri: "Kampanyadan yararlanamÄ±yorum." Ä°lk adÄ±m?',opts:["Kampanya koÅŸullarÄ± (tarih/paket/cihaz) uygun mu kontrol et.","Direkt kampanyayÄ± tanÄ±mla.","Sorun yok deyip kapat."],a:0,exp:"Uygunluk kontrolÃ¼ yapÄ±lmadan iÅŸlem yapmak hataya sÃ¼rÃ¼kler."},{q:'MÃ¼ÅŸteri sinirli: "Kimse Ã§Ã¶zmedi!" Ne yaparsÄ±n?',opts:["SakinleÅŸtirici bir cÃ¼mle + Ã¶zet + net aksiyon planÄ±.","SÄ±raya alalÄ±m.","Ses yÃ¼kselt."],a:0,exp:"KontrolÃ¼ geri almak iÃ§in empati + Ã¶zet + plan Ã¼Ã§lÃ¼sÃ¼ Ã§alÄ±ÅŸÄ±r."}];function resetQuickDecision(){qdTimer&&(clearInterval(qdTimer),qdTimer=null),qdTimeLeft=30,qdScore=0,qdStep=0,qdQueue=[],openQuickDecisionGame()}function shuffleArray(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}function getGameQuestionQueue(e,t,a){if(!e||0===e.length)return[];let n=[];try{n=JSON.parse(localStorage.getItem(t)||"[]")}catch(e){n=[]}let i=e.map((e,t)=>t);e.length>2*a&&(i=i.filter(t=>{const a=e[t],i=a.q||a.title||t.toString();return!n.includes(i)})),i.length<a&&(i=e.map((e,t)=>t)),shuffleArray(i);const l=i.slice(0,a);return l.forEach(t=>{const a=e[t],i=a.q||a.title||t.toString();n.includes(i)||n.push(i)}),n.length>30&&(n=n.slice(-30)),localStorage.setItem(t,JSON.stringify(n)),l}function startQuickDecision(){const e=Array.isArray(quickDecisionQuestions)&&quickDecisionQuestions.length?quickDecisionQuestions:QUICK_DECISION_BANK;if(!e.length)return void Swal.fire("Hata","HÄ±zlÄ± Karar verisi yok.","warning");const t=document.getElementById("qd-lobby"),a=document.getElementById("qd-game");t&&(t.style.display="none"),a&&(a.style.display="block"),qdScore=0,qdStep=0,qdTimeLeft=30;const n=getGameQuestionQueue(e,"seenQuickQuestions",5);qdQueue=n.map(t=>e[t]),updateQuickHud(),qdTimer&&clearInterval(qdTimer),qdTimer=setInterval(()=>{qdTimeLeft--,qdTimeLeft<=0&&(qdTimeLeft=0,finishQuickDecision(!0))},1e3),renderQuickQuestion()}function updateQuickHud(){const e=document.getElementById("qd-time");e&&(e.innerText=String(Math.max(0,qdTimeLeft)));const t=document.getElementById("qd-score");t&&(t.innerText=String(qdScore));const a=document.getElementById("qd-step");a&&(a.innerText=String(qdStep))}function renderQuickQuestion(){const e=qdQueue[qdStep],t=document.getElementById("qd-question"),a=document.getElementById("qd-options");t&&a&&e&&(t.innerText=e.q,a.innerHTML="",e.opts.forEach((e,t)=>{const n=document.createElement("button");n.className="quick-opt",n.innerText=e,n.onclick=()=>answerQuick(t),a.appendChild(n)}))}function answerQuick(e){const t=qdQueue[qdStep],a=document.getElementById("qd-options");if(!t||!a)return;const n=Array.from(a.querySelectorAll("button"));n.forEach(e=>e.disabled=!0);const i=e===t.a;n[e]&&(n[e].style.borderColor=i?"#00f2ff":"#ff5252",n[e].style.background=i?"rgba(0, 242, 255, 0.2)":"rgba(255, 82, 82, 0.2)",n[e].style.boxShadow=i?"0 0 15px #00f2ff":"0 0 15px #ff5252"),!i&&n[t.a]&&(n[t.a].style.borderColor="#00f2ff",n[t.a].style.boxShadow="0 0 10px #00f2ff"),qdScore+=i?10:-5,qdScore<0&&(qdScore=0),updateQuickHud(),Swal.fire({toast:!0,position:"top",icon:i?"success":"warning",title:i?"DOÄžRU!":"YANLIÅž!",text:t.exp,showConfirmButton:!1,background:"#0a1428",color:"#fff",timer:1500}),setTimeout(()=>{qdStep+=1,updateQuickHud(),qdStep>=qdQueue.length?finishQuickDecision(!1):renderQuickQuestion()},1200)}function finishQuickDecision(e){qdTimer&&(clearInterval(qdTimer),qdTimer=null);const t=e?"SÃœRE BÄ°TTÄ°!":"TAMAMLANDI!",a=qdScore>=40?"#00f2ff":qdScore>=20?"#ffcc00":"#ff5252";Swal.fire({icon:"info",title:t,background:"#0a1428",color:"#fff",html:`\n            <div style="text-align:center; padding: 10px;">\n                <div style="font-size:1.2rem; color:#fff; margin-bottom:15px; font-weight:bold;">ðŸ§  HÄ±zlÄ± Karar Sonucu</div>\n                <div style="font-size:3rem; font-weight:900; color:${a}; text-shadow: 0 0 15px ${a}cc;">${qdScore}</div>\n                <div style="margin-top:10px; color:#fff; font-weight:600;">TOPLAM PUAN</div>\n                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:20px 0;">\n                <div style="color:#00f2ff; font-size:1rem; font-weight:600;">Daha hÄ±zlÄ± karar vererek rekorunu geliÅŸtirebilirsin!</div>\n            </div>`,confirmButtonText:'<i class="fas fa-redo"></i> Tekrar Oyna',confirmButtonColor:"#00f2ff",showCancelButton:!0,cancelButtonText:"Kapat",cancelButtonColor:"#444"}).then(e=>{e.isConfirmed?resetQuickDecision():closeModal("quick-modal")})}function openPenaltyGame(){try{closeModal("game-hub-modal")}catch(e){}document.getElementById("penalty-modal").style.display="flex",showLobby()}function showLobby(){document.getElementById("penalty-lobby").style.display="flex",document.getElementById("penalty-game-area").style.display="none",fetchLeaderboard()}function startGameFromLobby(){document.getElementById("penalty-lobby").style.display="none",document.getElementById("penalty-game-area").style.display="block",startPenaltySession()}async function fetchLeaderboard(e="leaderboard-body",t="leaderboard-loader",a="leaderboard-table"){const n=document.getElementById(e),i=document.getElementById(t),l=document.getElementById(a);if(n){i&&(i.style.display="block"),l&&(l.style.display="none"),n.innerHTML="";try{const{data:t,error:a}=await sb.from("QuizResults").select("*").order("Score",{ascending:!1}).limit(20);if(i&&(i.style.display="none"),a)throw a;l&&(l.style.display="table");let r="";if(t&&0!==t.length){const a=normalizeKeys(t),n={};a.forEach(e=>{const t=e.username||e.agent||e.name||"Anonim",a=parseInt(e.score||0);n[t]||(n[t]={maxScore:0,games:0,bestRate:"%0"}),n[t].games++,a>n[t].maxScore&&(n[t].maxScore=a,n[t].bestRate=e.average||e.successrate||"%0")});Object.keys(n).map(e=>({name:e,...n[e]})).sort((e,t)=>t.maxScore-e.maxScore).slice(0,"home-leaderboard-body"===e?5:10).forEach((t,a)=>{const n=0===a?"ðŸ¥‡":1===a?"ðŸ¥ˆ":2===a?"ðŸ¥‰":`<span class="rank-badge">${a+1}</span>`,i=t.name,l=(t.maxScore,t.games),s=t.bestRate,o=i===currentUser,d=o?"#fabb00":"home-leaderboard-body"===e?"#333":"#eee";r+=`<tr style="${o?"background:rgba(250, 187, 0, 0.15);":""} border-bottom:1px solid rgba(0,0,0,0.05);">\n                    <td style="padding:8px 5px; text-align:center;">${n}</td>\n                    <td style="padding:8px 5px; font-weight:${o?"800":"600"}; color:${d}">${escapeHtml(i)}</td>\n                    <td style="padding:8px 5px; text-align:center; color:${d}">${l}</td>\n                    <td style="padding:8px 5px; text-align:center; font-weight:800; color:${d}">${s}</td>\n                </tr>`})}else r='<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">HenÃ¼z maÃ§ yapÄ±lmadÄ±.</td></tr>';n.innerHTML=r}catch(e){console.warn("Leaderboard fetch error:",e),i&&(i.innerText="YÃ¼klenemedi.",i.style.display="block")}}}function renderHomeLeaderboard(){fetchLeaderboard("home-leaderboard-body","home-leaderboard-loader","home-leaderboard-table")}function buildQuestionQueue(){return getGameQuestionQueue(quizQuestions,"seenArenaQuestions",10)}function startPenaltySession(){pScore=0,pBalls=10,pAskedCount=0,pCorrectCount=0,pWrongCount=0,jokers={call:1,half:1,double:1},doubleChanceUsed=!1,firstAnswerIndex=-1,setDoubleIndicator(!1),pQuestionQueue=buildQuestionQueue(),updateJokerButtons(),document.getElementById("p-score").innerText=pScore,document.getElementById("p-balls").innerText=pBalls;const e=document.getElementById("p-restart-btn"),t=document.getElementById("p-options");e&&(e.style.display="none"),t&&(t.style.display="grid"),resetField(),loadPenaltyQuestion()}function pickNextQuestion(){if(0===quizQuestions.length)return null;if(pQuestionQueue.length>0){const e=pQuestionQueue.shift();return quizQuestions[e]}return quizQuestions[Math.floor(Math.random()*quizQuestions.length)]}function loadPenaltyQuestion(){if(pBalls<=0)return void finishPenaltyGame();if(!Array.isArray(quizQuestions)||0===quizQuestions.length)return void Swal.fire("Hata","Soru yok!","warning");if(pCurrentQ=pickNextQuestion(),(!pCurrentQ||!pCurrentQ.opts||pCurrentQ.opts.length<2)&&(Swal.fire("Hata","Bu soru hatalÄ± formatta (ÅŸÄ±k yok).","error"),pCurrentQ=pickNextQuestion(),!pCurrentQ))return;pAskedCount++,doubleChanceUsed=!1,firstAnswerIndex=-1,setDoubleIndicator(!1),updateJokerButtons();const e=document.getElementById("p-question-text");e&&(e.innerText=pCurrentQ.q||"Soru");let t="";pCurrentQ.opts.forEach((e,a)=>{const n=String.fromCharCode(65+a);t+=`<button class="penalty-btn" onclick="shootBall(${a})">${n}: ${e}</button>`});const a=document.getElementById("p-options");a&&(a.innerHTML=t)}function shootBall(e){const t=document.querySelectorAll(".penalty-btn"),a=e===pCurrentQ.a;if(!a&&doubleChanceUsed&&-1===firstAnswerIndex)return firstAnswerIndex=e,t[e]&&(t[e].classList.add("wrong-first-try"),t[e].disabled=!0),Swal.fire({toast:!0,position:"top",icon:"info",title:"Ä°lk Hata! Kalan HakkÄ±n: 1",showConfirmButton:!1,timer:1400,background:"#ffc107"}),void updateJokerButtons();t.forEach(e=>e.disabled=!0);const n=document.getElementById("ball-wrap"),i=document.getElementById("keeper-wrap"),l=document.getElementById("shooter-wrap"),r=document.getElementById("goal-msg"),s=Math.floor(4*Math.random());l&&l.classList.add("shooter-run"),setTimeout(()=>{if(i&&(a?0===s||2===s?i.classList.add("keeper-dive-right"):i.classList.add("keeper-dive-left"):0===s||2===s?i.classList.add("keeper-dive-left"):i.classList.add("keeper-dive-right")),a)n&&(0===s?n.classList.add("ball-shoot-left-top"):1===s?n.classList.add("ball-shoot-right-top"):2===s?n.classList.add("ball-shoot-left-low"):n.classList.add("ball-shoot-right-low")),setTimeout(()=>{r&&(r.innerText="GOOOOL!",r.style.color="#00f2ff",r.style.textShadow="0 0 20px #00f2ff",r.classList.add("show")),pScore+=doubleChanceUsed?2:1,pCorrectCount++,document.getElementById("p-score").innerText=pScore,Swal.fire({toast:!0,position:"top",icon:"success",title:"MÃœKEMMEL ÅžUT!",showConfirmButton:!1,timer:1200,background:"#0e1b42",color:"#00f2ff"})},500);else{pWrongCount++;const e=()=>{r&&(r.style.color="#ff5252",r.style.textShadow="0 0 20px #ff5252",r.classList.add("show")),Swal.fire({icon:"error",title:"KAÃ‡IRDIN!",text:`DoÄŸru Cevap: ${String.fromCharCode(65+pCurrentQ.a)}`,showConfirmButton:!0,background:"#0a1428",color:"#fff",confirmButtonColor:"#ff5252"})};Math.random()>.5?(n&&(n.style.bottom="160px",n.style.left=0===s||2===s?"40%":"60%",n.style.transform="scale(0.6)"),setTimeout(()=>{r&&(r.innerText="KURTARDI!"),e()},500)):(n&&n.classList.add(Math.random()>.5?"ball-miss-left":"ball-miss-right"),setTimeout(()=>{r&&(r.innerText="DIÅžARI!"),e()},500))}},400),pBalls--,document.getElementById("p-balls").innerText=pBalls,setTimeout(()=>{resetField(),loadPenaltyQuestion()},3200)}function resetField(){const e=document.getElementById("ball-wrap"),t=document.getElementById("keeper-wrap"),a=document.getElementById("shooter-wrap"),n=document.getElementById("goal-msg");e&&(e.className="ball-wrapper",e.style=""),t&&(t.className="keeper-wrapper"),a&&(a.className="shooter-wrapper"),n&&n.classList.remove("show"),document.querySelectorAll(".penalty-btn").forEach(e=>{e.classList.remove("wrong-first-try"),e.style.textDecoration="",e.style.opacity="",e.style.background="",e.style.color="",e.style.borderColor="",e.style.boxShadow="",e.disabled=!1})}function finishPenaltyGame(){const e=pScore>=8?"EFSANE! ðŸ†":pScore>=5?"Ä°yi MaÃ§tÄ±! ðŸ‘":"Antrenman LazÄ±m ðŸ¤•",t=Math.round(pCorrectCount/Math.max(1,pCorrectCount+pWrongCount)*100),a=pScore>=8?"#00f2ff":pScore>=5?"#ffcc00":"#ff5252",n=document.getElementById("p-question-text");n&&(n.innerHTML=`\n            <div style="text-align:center; padding:15px; background:rgba(0,0,0,0.3); border-radius:12px; border:1px solid #333;">\n                <div style="font-size:1.8rem; color:#00f2ff; font-weight:900; text-shadow:0 0 10px #00f2ff66;">MAÃ‡ BÄ°TTÄ°!</div>\n                <div style="margin-top:8px; font-size:1.2rem; color:#fff; font-weight:600;">${e}</div>\n                <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">\n                    <div style="text-align:center;">\n                        <div style="font-size:0.8rem; color:#888; text-transform:uppercase;">Skor</div>\n                        <div style="font-size:2rem; font-weight:900; color:${a};">${pScore}/10</div>\n                    </div>\n                    <div style="text-align:center; border-left:1px solid #333; padding-left:20px;">\n                        <div style="font-size:0.8rem; color:#888; text-transform:uppercase;">DoÄŸruluk</div>\n                        <div style="font-size:2rem; font-weight:900; color:#fff;">${t}%</div>\n                    </div>\n                </div>\n                <div style="margin-top:15px; font-size:0.9rem; color:#aaa;">\n                    DoÄŸru: <span style="color:#00f2ff">${pCorrectCount}</span> &nbsp; | &nbsp; YanlÄ±ÅŸ: <span style="color:#ff5252">${pWrongCount}</span>\n                </div>\n            </div>\n        `);const i=document.getElementById("p-options"),l=document.getElementById("p-restart-btn");i&&(i.style.display="none"),l&&(l.style.display="block"),apiCall("logQuiz",{username:currentUser,score:10*pScore,total:10,successRate:t+"%"}).finally(()=>{setTimeout(fetchLeaderboard,600)})}function openWizard(){document.getElementById("wizard-modal").style.display="flex",0===Object.keys(wizardStepsData).length?(Swal.fire({title:"Ä°ade AsistanÄ± Verisi YÃ¼kleniyor...",didOpen:()=>Swal.showLoading()}),loadWizardData().then(()=>{Swal.close(),wizardStepsData.start?renderStep("start"):document.getElementById("wizard-body").innerHTML='<h2 style="color:red;">Asistan verisi eksik.</h2>'}).catch(()=>{Swal.close(),document.getElementById("wizard-body").innerHTML='<h2 style="color:red;">Veri Ã§ekme hatasÄ±.</h2>'})):renderStep("start")}function renderStep(e){const t=wizardStepsData[e];if(!t)return void(document.getElementById("wizard-body").innerHTML=`<h2 style="color:red;">HATA: AdÄ±m ID (${e}) yok.</h2>`);const a=document.getElementById("wizard-body");let n=`${isAdminMode?`<button class="btn-edit-wizard" onclick="openWizardEditor('WizardSteps', '${e}')" style="float:right; background:none; border:none; color:#999; cursor:pointer;" title="Bu adÄ±mÄ± dÃ¼zenle"><i class="fas fa-edit"></i></button>`:""}<h2 style="color:var(--primary);">${t.title||""}</h2>`;if(t.result){let e="red"===t.result?" ðŸ›‘ ":"green"===t.result?" âœ… ":" âš ï¸ ",a="red"===t.result?"res-red":"green"===t.result?"res-green":"res-yellow";n+=`<div class="result-box ${a}"><div style="font-size:3rem;margin-bottom:10px;">${e}</div><h3>${t.title}</h3><p>${t.text}</p>${t.script?`<div class="script-box">${t.script}</div>`:""}</div><button class="restart-btn" onclick="renderStep('start')"><i class="fas fa-redo"></i> BaÅŸa DÃ¶n</button>`}else n+=`<p>${t.text}</p><div class="wizard-options">`,t.options.forEach(e=>{n+=`<button class="option-btn" onclick="renderStep('${e.next}')"><i class="fas fa-chevron-right"></i> ${e.text}</button>`}),n+="</div>","start"!==e&&(n+='<button class="restart-btn" onclick="renderStep(\'start\')" style="background:#eee;color:#333;margin-top:15px;">BaÅŸa DÃ¶n</button>');a.innerHTML=n}const twState={currentStep:"start",history:[]};function openTechWizard(){openTechArea("wizard")}function twRenderStep(){const e=document.getElementById("tech-wizard-content")||document.getElementById("x-wizard"),t=document.getElementById("tw-btn-back");if(!e)return;const a=techWizardData[twState.currentStep];if(twState.history.length>0?t.style.display="block":t.style.display="none",!a)return void(e.innerHTML=`<div class="alert" style="color:red;">Hata: AdÄ±m bulunamadÄ± (${twState.currentStep}).</div>`);let n=`${isAdminMode?`<button class="btn-edit-wizard" onclick="openWizardEditor('TechWizardSteps', '${twState.currentStep}')" style="float:right; background:none; border:none; color:#eee; cursor:pointer;" title="Bu adÄ±mÄ± dÃ¼zenle"><i class="fas fa-edit"></i></button>`:""}<div class="tech-step-title">${a.title||""}</div>`;if(a.text&&(n+=`<p style="font-size:1rem; margin-bottom:15px;">${a.text}</p>`),a.script){const e=encodeURIComponent(a.script);n+=`<div class="tech-script-box"><span class="tech-script-label">MÃ¼ÅŸteriye iletilecek:</span>"${a.script}"<div style="margin-top:10px; text-align:right;"><button class="btn btn-copy" style="font-size:0.8rem; padding:5px 10px;" onclick="copyScriptContent('${e}')"><i class="fas fa-copy"></i> Kopyala</button></div></div>`}a.alert&&(n+=`<div class="tech-alert">${a.alert}</div>`),a.buttons&&a.buttons.length>0&&(n+='<div class="tech-buttons-area">',a.buttons.forEach(e=>{let t="option"===e.style?"tech-btn-option":"tech-btn-primary";n+=`<button class="tech-btn ${t}" onclick="twChangeStep('${e.next}')">${e.text}</button>`}),n+="</div>"),e.innerHTML=n}function twChangeStep(e){twState.history.push(twState.currentStep),twState.currentStep=e,twRenderStep()}function twGoBack(){twState.history.length>0&&(twState.currentStep=twState.history.pop(),twRenderStep())}function twResetWizard(){twState.currentStep="start",twState.history=[],twRenderStep()}function populateFeedbackMonthFilter(){const e=document.getElementById("q-feedback-month");if(!e)return;const t=new Date,a=t.getMonth(),n=t.getFullYear();e.innerHTML="";for(let t=0;t<6;t++){let i=(a-t+12)%12,l=n-(a-t<0?1:0);const r=`${String(i+1).padStart(2,"0")}.${l}`,s=`${MONTH_NAMES[i]} ${l}`,o=document.createElement("option");o.value=r,o.textContent=s,0===t&&(o.selected=!0),e.appendChild(o)}}function populateMonthFilterFull(){const e=new Date,t=e.getMonth(),a=e.getFullYear();["q-dash-month","q-eval-month","q-feedback-month"].forEach(e=>{const n=document.getElementById(e);if(n){n.innerHTML="";for(let e=0;e<6;e++){let i=(t-e+12)%12,l=a-(t-e<0?1:0);const r=`${String(i+1).padStart(2,"0")}.${l}`,s=`${MONTH_NAMES[i]} ${l}`,o=document.createElement("option");o.value=r,o.textContent=s,0===e&&(o.selected=!0),n.appendChild(o)}}})}function populateAllAdminFilters(){if(populateMonthFilterFull(),!isAdminMode)return;populateDashboardFilters();const e=document.getElementById("q-admin-group");if(e&&adminUserList.length>0){const t=[...new Set(adminUserList.map(e=>e.group).filter(e=>e))].sort();e.innerHTML='<option value="all">TÃ¼m Gruplar</option>'+t.map(e=>`<option value="${e}">${e}</option>`).join(""),updateAgentListBasedOnGroup()}populateFeedbackFilters()}function populateDashboardFilters(){const e=document.getElementById("q-dash-group"),t=document.getElementById("q-dash-agent");document.getElementById("q-dash-channel");if(!isAdminMode)return e&&(e.style.display="none"),void(t&&(t.style.display="none"));if(e&&(e.style.display="block"),t&&(t.style.display="block"),!e)return;const a=["chat","istchat","satÄ±ÅŸ","satis"],n=[...new Set(adminUserList.map(e=>e.group).filter(e=>{if(!e)return!1;const t=e.toLowerCase();return a.some(e=>t.includes(e))}))].sort();e.innerHTML='<option value="all">TÃ¼m Gruplar</option>',n.forEach(t=>{const a=document.createElement("option");a.value=t,a.innerText=t,e.appendChild(a)}),updateDashAgentList()}function updateDashAgentList(){const e=document.getElementById("q-dash-group"),t=document.getElementById("q-dash-agent");if(!t)return;const a=e.value;t.innerHTML='<option value="all">TÃ¼m Temsilciler</option>';let n=adminUserList.filter(e=>"user"===String(e.role).toLowerCase());"all"!==a&&(n=n.filter(e=>e.group===a)),n.forEach(e=>{const a=document.createElement("option");a.value=e.name,a.innerText=e.name,t.appendChild(a)}),updateDashRingTitle(),refreshQualityData()}function updateDashRingTitle(){document.getElementById("q-dash-ring-title")||document.getElementById("q-dash-ring-title".replace("title","title"));const e=document.getElementById("q-dash-ring-title");if(!e)return;if(!isAdminMode)return void(e.textContent="Puan Durumu");const t=document.getElementById("q-dash-group"),a=document.getElementById("q-dash-agent"),n=t?t.value:"all",i=a?a.value:"all";e.textContent=i&&"all"!==i?`${i} Puan Durumu`:n&&"all"!==n?`${n} TakÄ±m OrtalamasÄ±`:"Genel Puan OrtalamasÄ±"}function renderDashAgentScores(e){const t=document.getElementById("q-dash-agent-scores");if(!t)return;if(!isAdminMode)return void(t.style.display="none");const a=document.getElementById("q-dash-group"),n=document.getElementById("q-dash-agent"),i=a?a.value:"all",l=n?n.value:"all";if(l&&"all"!==l)return void(t.style.display="none");const r={};(e||[]).forEach(e=>{const t=e.agent||"N/A",a=e.group||"",n=parseFloat(e.score)||0;r[t]||(r[t]={total:0,count:0,group:a}),r[t].total+=n,r[t].count+=1,!r[t].group&&a&&(r[t].group=a)});const s=Object.keys(r).map(e=>{const t=r[e];return{name:e,group:t.group||("all"!==i?i:""),avg:t.count?t.total/t.count:0,count:t.count}}),o=i&&"all"!==i?s.filter(e=>(e.group||"")===i):s;if(o.sort((e,t)=>e.avg-t.avg),0===o.length)return void(t.style.display="none");const d=o;t.innerHTML=d.map(e=>`\n        <div class="das-item">\n            <div class="das-left">\n                <span class="das-name">${escapeHtml(e.name)}</span>\n                ${e.group?`<span class="das-group">${escapeHtml(e.group)}</span>`:""}\n            </div>\n            <div class="das-score">${(e.avg||0).toFixed(1)}</div>\n        </div>\n    `).join(""),t.style.display="grid"}function deriveChannelFromGroup(e){const t=String(e||"").toLowerCase();return t?t.includes("telesat")||t.includes("telesatÄ±ÅŸ")||"telesales"===t?"sales":t.includes("chat")?"chat":"other":"other"}function safeParseDetails(e){if(!e)return null;if(Array.isArray(e))return e;if("object"==typeof e)return e;if("string"==typeof e){const t=e.trim();if(!t)return null;const a=[t,t.replace(/\"/g,'"'),t.replace(/'/g,'"')];for(const e of a)try{const t=JSON.parse(e);if(Array.isArray(t))return t}catch(e){}}return null}function populateFeedbackFilters(){const e=document.getElementById("q-feedback-group"),t=document.getElementById("q-feedback-agent");if(!e||!t)return;if(!isAdminMode)return e.style.display="none",void(t.style.display="none");e.style.display="block",t.style.display="block";const a=[...new Set(adminUserList.map(e=>e.group).filter(e=>e))].sort();e.innerHTML='<option value="all">TÃ¼m Gruplar</option>',a.forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)}),updateFeedbackAgentList(!1)}function updateFeedbackAgentList(e=!0){const t=document.getElementById("q-feedback-group"),a=document.getElementById("q-feedback-agent");if(!t||!a)return;const n=t.value,i=adminUserList.filter(e=>!(!e||!e.username)&&("user"===String(e.role).toLowerCase()&&("all"===n||e.group===n))).map(e=>e.username).filter(e=>e).sort((e,t)=>e.localeCompare(t,"tr"));a.innerHTML='<option value="all">TÃ¼m Temsilciler</option>',i.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)}),e&&refreshFeedbackData()}async function fetchEvaluationsForFeedback(){const e=document.getElementById("q-feedback-group"),t=document.getElementById("q-feedback-agent");let a=currentUser,n="all";isAdminMode&&(a=t?t.value:"all",n=e?e.value:"all");try{const e=await apiCall("fetchEvaluations",{targetAgent:a,targetGroup:n});allEvaluationsData="success"===e.result&&e.evaluations||[]}catch(e){allEvaluationsData=[]}}async function refreshFeedbackData(){await fetchEvaluationsForFeedback(),await fetchFeedbackLogs(),loadFeedbackList()}function refreshQualityData(){loadQualityDashboard()}async function fetchEvaluationsForDashboard(){const e=document.getElementById("q-dash-group"),t=document.getElementById("q-dash-agent");let a=currentUser,n="all";isAdminMode&&(a=t?t.value:"all",n=e?e.value:"all");try{console.log("[Pusula] Fetching evaluations from Supabase...");const e=await apiCall("fetchEvaluations",{targetAgent:a,targetGroup:n});if("success"!==e.result)throw new Error(e.message);allEvaluationsData=e.evaluations||[],console.log(`[Pusula] ${allEvaluationsData.length} evaluations loaded.`)}catch(e){console.error("[Pusula] Evaluations Fetch Error:",e),allEvaluationsData=[]}}function loadQualityDashboard(){fetchEvaluationsForDashboard().then(()=>{const e=document.getElementById("q-dash-month"),t=document.getElementById("q-dash-group"),a=document.getElementById("q-dash-agent"),n=e?e.value:"",i=t?t.value:"all",l=a?a.value:"all";let r=allEvaluationsData.filter(e=>{const t=e.callDate&&"N/A"!==e.callDate?e.callDate:e.date;if(!t||"string"!=typeof t)return!1;const a=t.substring(3)===n;let r=!0,s=!0;if(isAdminMode){if("all"!==i)if(e.group)r=e.group===i;else{const t=adminUserList.find(t=>t.name===e.agent);r=t&&t.group===i}"all"!==l&&e.agent!==l&&(s=!1)}else e.agent!==currentUser&&(s=!1);const o=e.callId&&String(e.callId).toUpperCase().startsWith("MANUEL-");return a&&r&&s&&!o});const s=r.reduce((e,t)=>e+(parseInt(t.score)||0),0),o=r.length,d=o>0?(s/o).toFixed(1):0,c=r.filter(e=>e.score>=90).length,u=o>0?Math.round(c/o*100):0;let m="-";try{const e={};r.forEach(t=>{const a=safeParseDetails(t.details);Array.isArray(a)&&a.forEach(t=>{const a=String(t.q||"").trim();if(!a)return;const n=parseFloat(t.score||0)||0,i=parseFloat(t.max||0)||0;e[a]||(e[a]={earned:0,max:0}),e[a].earned+=n,e[a].max+=i})});const t=Object.keys(e).map(t=>{const a=e[t];return{k:t,pct:a.max>0?a.earned/a.max*100:100}}).sort((e,t)=>e.pct-t.pct);if(t.length){const e=t[0].k;m=e.length>28?e.substring(0,28)+"â€¦":e}}catch(e){}const p=document.getElementById("q-dash-worst");p&&(p.innerText=m),document.getElementById("q-dash-score").innerText=d,document.getElementById("q-dash-count").innerText=o,document.getElementById("q-dash-target").innerText=`%${u}`;const g=document.getElementById("q-dash-ring");let y="#2e7d32";d<70?y="#d32f2f":d<85&&(y="#ed6c02");const f=d/100*100;g&&(g.style.background=`conic-gradient(${y} ${f}%, #eee ${f}%)`),document.getElementById("q-dash-ring-text")&&(document.getElementById("q-dash-ring-text").innerText=Math.round(d)),updateDashRingTitle(),renderDashAgentScores(r),renderDashboardCharts(r)})}function renderDashboardChart(e){const t=document.getElementById("q-breakdown-chart");if(!t)return;dashboardChart&&dashboardChart.destroy();let a={};e.length>0&&e.forEach(e=>{try{let t=safeParseDetails(e.details);Array.isArray(t)&&t.forEach(e=>{let t=e.q,n=t.length>25?t.substring(0,25)+"...":t;a[n]||(a[n]={earned:0,max:0,fullText:t}),a[n].earned+=parseInt(e.score||0),a[n].max+=parseInt(e.max||0)})}catch(e){console.log("Detay verisi iÅŸlenemedi",e)}});let n=Object.keys(a).map(e=>{let t=a[e],n=t.max>0?t.earned/t.max*100:0;return{label:e,fullLabel:t.fullText,value:n}});if(n.sort((e,t)=>e.value-t.value),0===n.length){const a={};e.forEach(e=>{const t=e.agent||"N/A",n=parseFloat(e.score)||0;a[t]||(a[t]={total:0,count:0}),a[t].total+=n,a[t].count+=1});const n=Object.keys(a).map(e=>({label:e.length>25?e.substring(0,25)+"...":e,fullLabel:e,value:a[e].count?a[e].total/a[e].count:0}));n.sort((e,t)=>e.value-t.value);let i=n.slice(0,6),l=i.map(e=>e.label),r=i.map(e=>e.value.toFixed(1));return void(dashboardChart=new Chart(t,{type:"bar",plugins:[valueLabelPlugin],data:{labels:l,datasets:[{label:"Ortalama Puan",data:r,backgroundColor:e=>{const t=e.raw;return t<70?"rgba(231, 76, 60, 0.8)":t<85?"rgba(241, 196, 15, 0.8)":"rgba(46, 204, 113, 0.8)"},borderRadius:6,borderWidth:0,barThickness:24}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",layout:{padding:{top:45,right:45,bottom:10,left:10}},scales:{x:{beginAtZero:!0,max:100,grid:{color:"rgba(0,0,0,0.03)"},ticks:{font:{size:10}}},y:{grid:{display:!1},ticks:{font:{weight:"600",size:11}}}},plugins:{legend:{display:!1},valueLabelPlugin:{formatter:e=>`${Number(e).toFixed(1)}`},tooltip:{backgroundColor:"rgba(14, 27, 66, 0.95)",padding:12,titleFont:{size:13,weight:"bold"},bodyFont:{size:12},cornerRadius:8,callbacks:{title:e=>i[e[0].dataIndex].fullLabel,label:e=>`Ortalama: ${e.parsed.x} Puan`}}}}}))}let i=n.slice(0,6),l=i.map(e=>e.label),r=i.map(e=>e.value.toFixed(1));dashboardChart=new Chart(t,{type:"bar",plugins:[valueLabelPlugin],data:{labels:l,datasets:[{label:"BaÅŸarÄ± OranÄ± (%)",data:r,backgroundColor:e=>{const t=e.raw;return t<70?"rgba(231, 76, 60, 0.85)":t<90?"rgba(241, 196, 15, 0.85)":"rgba(46, 204, 113, 0.85)"},borderRadius:8,barThickness:26}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",layout:{padding:{top:45,right:75,bottom:10,left:10}},scales:{x:{beginAtZero:!0,max:135,grid:{color:"rgba(0,0,0,0.04)"},ticks:{display:!1}},y:{grid:{display:!1},ticks:{font:{weight:"700",size:12}}}},plugins:{legend:{display:!1},valueLabelPlugin:{formatter:e=>`${Number(e).toFixed(1)}%`},tooltip:{backgroundColor:"rgba(14, 27, 66, 0.95)",callbacks:{title:e=>i[e[0].dataIndex].fullLabel,label:e=>`BaÅŸarÄ±: ${e.parsed.x}%`}}}}})}function destroyIfExists(e){try{e&&e.destroy()}catch(e){}}const valueLabelPlugin={id:"valueLabelPlugin",afterDatasetsDraw(e,t,a){const n=a||{};if(!1===n.display)return;const i=e.ctx,l=e.config.type,r=e.data&&e.data.datasets?e.data.datasets:[];i.save(),i.font=n.font||'700 13px "Inter", sans-serif',i.fillStyle=n.color||"#0f172a",i.textAlign="center",i.textBaseline="middle";const s="function"==typeof n.formatter?n.formatter:e=>null==e?"":String(e);if("doughnut"===l||"pie"===l){const t=r[0]&&Array.isArray(r[0].data)?r[0].data.reduce((e,t)=>e+(parseFloat(t)||0),0):0;return e.getDatasetMeta(0).data.forEach((a,l)=>{const o=(r[0].data||[])[l],d=parseFloat(o)||0;if(!d||!t)return;const c=d/t*100;if(c<(n.minPercentToShow||4))return;const u=a.tooltipPosition();i.fillText(n.showPercent?`${c.toFixed(0)}%`:s(o,l,e),u.x,u.y)}),void i.restore()}r.forEach((t,a)=>{const n=e.getDatasetMeta(a);n.hidden||n.data.forEach((a,n)=>{const r=Array.isArray(t.data)?t.data[n]:null,o=s(r,n,e);if(!o)return;const d=a.tooltipPosition();if("y"===e.config.options.indexAxis&&"bar"===l)i.textAlign="right",i.fillText(o,d.x-10,d.y);else{const e="bar"===l?-10:-12;i.fillText(o,d.x,d.y+e)}})}),i.restore()}};function renderDashboardCharts(e){renderDashboardChart(e),renderDashboardTrendChart(e),renderDashboardChannelChart(e),renderDashboardScoreDistributionChart(e),renderDashboardGroupAvgChart(e)}function renderDashboardTrendChart(e){const t=document.getElementById("q-trend-chart");if(!t)return;destroyIfExists(dashTrendChart);const a={};(e||[]).forEach(e=>{const t=String(e.callDate||e.date||"").trim();if(!t)return;const n=parseFloat(e.score)||0;a[t]||(a[t]={total:0,count:0}),a[t].total+=n,a[t].count+=1});const n=Object.keys(a).sort((e,t)=>{const a=e.split("."),n=t.split(".");return new Date(Number(a[2]),Number(a[1])-1,Number(a[0]))-new Date(Number(n[2]),Number(n[1])-1,Number(n[0]))}),i=n.map(e=>e.substring(0,5)),l=n.map(e=>(a[e].count?a[e].total/a[e].count:0).toFixed(1)),r=document.getElementById("q-trend-sub");r&&(r.textContent=n.length?`${n.length} gÃ¼n â€¢ gÃ¼nlÃ¼k ortalama`:"Veri yok"),dashTrendChart=new Chart(t,{type:"line",plugins:[valueLabelPlugin],data:{labels:i,datasets:[{label:"GÃ¼nlÃ¼k Ortalama",data:l,borderColor:"#3498db",backgroundColor:"rgba(52, 152, 219, 0.1)",tension:.4,fill:!0,pointRadius:4,pointBackgroundColor:"#fff",pointBorderColor:"#3498db",pointBorderWidth:2,borderWidth:3}]},options:{layout:{padding:{top:45,right:25,left:10}},responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,max:120,grid:{color:"rgba(0,0,0,0.03)"}},x:{grid:{display:!1}}},plugins:{legend:{display:!1},valueLabelPlugin:{formatter:e=>`${Number(e).toFixed(1)}`},tooltip:{backgroundColor:"rgba(14, 27, 66, 0.95)",callbacks:{label:e=>`Ortalama: ${e.parsed.y}`}}}}})}function renderDashboardChannelChart(e){const t=document.getElementById("q-channel-chart");if(!t)return;destroyIfExists(dashChannelChart);const a=document.getElementById("q-dash-group"),n=document.getElementById("q-dash-agent"),i=document.getElementById("q-dash-channel"),l=(a&&a.value,n?n.value:"all"),r=i?i.value:"all";let s="channel";("all"!==r||l&&"all"!==l)&&(s="feedbackType");const o={};(e||[]).forEach(e=>{const t="channel"===s?deriveChannelFromGroup(e.group):String(e.feedbackType||"Yok");o[t]||(o[t]=0),o[t]+=1});const d=Object.keys(o),c=d.map(e=>o[e]),u=document.getElementById("q-channel-sub");u&&(u.textContent="channel"===s?"SatÄ±ÅŸ / Chat / DiÄŸer":"Feedback Type daÄŸÄ±lÄ±mÄ±"),dashChannelChart=new Chart(t,{type:"doughnut",plugins:[valueLabelPlugin],data:{labels:d,datasets:[{data:c,backgroundColor:["#3498db","#9b59b6","#2ecc71","#f1c40f","#e67e22","#e74c3c"],borderWidth:2,borderColor:"#fff",hoverOffset:12}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"65%",plugins:{legend:{position:"bottom",labels:{usePointStyle:!0,boxWidth:8,font:{size:11}}},valueLabelPlugin:{showPercent:!0,minPercentToShow:5,color:"#fff"},tooltip:{backgroundColor:"rgba(14, 27, 66, 0.95)",callbacks:{label:e=>`${e.label}: ${e.formattedValue} Adet`}}}}})}function renderDashboardScoreDistributionChart(e){const t=document.getElementById("q-score-dist-chart");if(!t)return;destroyIfExists(dashScoreDistChart);const a=[{label:"0-59",min:0,max:59},{label:"60-69",min:60,max:69},{label:"70-79",min:70,max:79},{label:"80-89",min:80,max:89},{label:"90-100",min:90,max:100}],n=a.map(()=>0);(e||[]).forEach(e=>{const t=Math.round(parseFloat(e.score)||0);for(let e=0;e<a.length;e++)if(t>=a[e].min&&t<=a[e].max){n[e]++;break}}),dashScoreDistChart=new Chart(t,{type:"bar",plugins:[valueLabelPlugin],data:{labels:a.map(e=>e.label),datasets:[{label:"Adet",data:n,backgroundColor:["#e74c3c","#e67e22","#f1c40f","#3498db","#2ecc71"],borderWidth:0,borderRadius:4,barThickness:30}]},options:{layout:{padding:{top:45}},responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,max:120,grid:{color:"rgba(0,0,0,0.03)"},ticks:{precision:0}},x:{grid:{display:!1}}},plugins:{legend:{display:!1},valueLabelPlugin:{formatter:e=>`${e}`},tooltip:{backgroundColor:"rgba(14, 27, 66, 0.95)",callbacks:{label:e=>`${e.parsed.y} KayÄ±t`}}}}})}function renderDashboardGroupAvgChart(e){const t=document.getElementById("q-group-avg-chart");if(!t)return;destroyIfExists(dashGroupAvgChart);const a={};(e||[]).forEach(e=>{const t=String(e.group||"Genel"),n=parseFloat(e.score)||0;a[t]||(a[t]={total:0,count:0}),a[t].total+=n,a[t].count+=1});const n=Object.keys(a).map(e=>({g:e,avg:a[e].count?a[e].total/a[e].count:0,count:a[e].count})).sort((e,t)=>e.avg-t.avg),i=n.map(e=>e.g.length>22?e.g.substring(0,22)+"â€¦":e.g),l=n.map(e=>e.avg.toFixed(1)),r=document.getElementById("q-group-sub");r&&(r.textContent=n.length?`${n.length} takÄ±m â€¢ en dÃ¼ÅŸÃ¼kten en yÃ¼kseÄŸe`:"Veri yok"),dashGroupAvgChart=new Chart(t,{type:"bar",plugins:[valueLabelPlugin],data:{labels:i,datasets:[{label:"Ortalama",data:l,backgroundColor:"#1e293b",hoverBackgroundColor:"#CF0A2C",borderRadius:4,barThickness:18}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",layout:{padding:{top:35,right:90,bottom:5,left:10}},scales:{x:{beginAtZero:!0,max:140,grid:{display:!1},ticks:{display:!1}},y:{grid:{display:!1},ticks:{font:{weight:"800",size:13,family:'"Inter", sans-serif'},color:"#1e293b"}}},plugins:{legend:{display:!1},valueLabelPlugin:{formatter:e=>`${Number(e).toFixed(1)}`,color:"#ffffff",font:'900 13px "Inter", sans-serif'},tooltip:{backgroundColor:"rgba(14, 27, 66, 0.95)",callbacks:{title:e=>n[e[0].dataIndex].g,label:e=>`Ortalama: ${e.parsed.x} (${n[e.dataIndex].count} KayÄ±t)`}}}}})}let allTrainingsData=[];function loadTrainingData(){const e=document.getElementById("training-list");e.innerHTML='<div style="grid-column:1/-1; text-align:center;">YÃ¼kleniyor...</div>',apiCall("getTrainings",{asAdmin:isAdminMode}).then(t=>{"success"===t.result?(allTrainingsData=t.trainings||[],renderTrainingList(allTrainingsData)):e.innerHTML='<div style="grid-column:1/-1; text-align:center; padding:20px; color:#888;">Hata oluÅŸtu veya veri yok.</div>'})}function renderTrainingList(e){const t=document.getElementById("training-list");t.innerHTML="",e&&0!==e.length?e.forEach(e=>{let a=e.isCompleted?'<button class="t-btn t-btn-done"><i class="fas fa-check"></i> TamamlandÄ±</button>':`<button class="t-btn t-btn-start" onclick="openTrainingLink('${e.id}', '${e.link}')">EÄŸitime Git</button>`,n=e.docLink&&"N/A"!==e.docLink?`<a href="${e.docLink}" target="_blank" class="t-doc-link"><i class="fas fa-file-download"></i> DÃ¶kÃ¼manÄ± Ä°ndir</a>`:"";t.innerHTML+=`\n        <div class="t-card">\n            <div class="t-card-header">\n                <span>${e.title}${isAdminMode?` <span style="font-weight:600; opacity:.8; font-size:.75rem">(${e.target}${"Individual"===e.target&&e.targetUser?" â€¢ "+e.targetUser:""})</span>`:""}</span>\n                <span class="t-status-badge">Atanma: ${e.date}</span>\n            </div>\n            <div class="t-card-body">\n                ${e.desc}\n                ${n}\n                <div style="margin-top:10px; display:flex; justify-content:space-between; font-size:0.8rem; color:#666; padding-top:10px; border-top:1px dashed #eee;">\n                    <div><strong>SÃ¼re:</strong> ${e.duration||"Belirtilmedi"}</div>\n                    <div><strong>BaÅŸlangÄ±Ã§:</strong> ${e.startDate||"N/A"} - <strong>BitiÅŸ:</strong> ${e.endDate||"N/A"}</div>\n                </div>\n                <div style="font-size:0.8rem; color:#999; margin-top:5px;">Atayan: ${e.creator}</div>\n            </div>\n            <div class="t-card-footer">\n                ${a}\n            </div>\n        </div>`}):t.innerHTML='<div style="grid-column:1/-1; text-align:center; padding:20px; color:#888;">GÃ¶rÃ¼ntÃ¼lenecek eÄŸitim bulunmuyor.</div>'}function filterTrainingList(){const e=(document.getElementById("q-training-search").value||"").toLowerCase().trim(),t=document.getElementById("q-training-filter-type").value;renderTrainingList(allTrainingsData.filter(a=>{const n="all"===t||a.target===t,i=!e||a.title&&a.title.toLowerCase().includes(e)||a.desc&&a.desc.toLowerCase().includes(e)||a.targetUser&&a.targetUser.toLowerCase().includes(e);return n&&i}))}function startTraining(e){apiCall("startTraining",{trainingId:e})}function openTrainingLink(e,t){startTraining(e),t&&"N/A"!==t?window.open(t,"_blank"):Swal.fire("UyarÄ±","Bu eÄŸitim iÃ§in geÃ§erli bir link bulunmamaktadÄ±r.","warning"),Swal.fire({title:"EÄŸitimi TamamladÄ±n mÄ±?",text:"EÄŸitim iÃ§eriÄŸini inceleyip anladÄ±ysan onayla.",icon:"question",showCancelButton:!0,confirmButtonText:"Evet, TamamladÄ±m",cancelButtonText:"Daha Sonra"}).then(t=>{t.isConfirmed&&completeTraining(e)})}function completeTraining(e){apiCall("completeTraining",{trainingId:e}).then(e=>{"success"===e.result?(Swal.fire("Harika!","EÄŸitim tamamlandÄ± olarak iÅŸaretlendi.","success"),loadTrainingData()):Swal.fire("Hata",e.message,"error")})}async function assignTrainingPopup(){const{value:e}=await Swal.fire({title:"Yeni EÄŸitim & DÃ¶kÃ¼man Ata",html:`\n            <div class="t-modal-grid">\n                <input id="swal-t-title" class="swal2-input" placeholder="EÄŸitim BaÅŸlÄ±ÄŸÄ±" style="grid-column: 1 / 4;">\n                <textarea id="swal-t-desc" class="swal2-textarea" style="height:100px; grid-column: 1 / 4;" placeholder="EÄŸitim aÃ§Ä±klamasÄ± veya talimatlar..."></textarea>\n                <input id="swal-t-link" class="swal2-input" placeholder="Video/EÄŸitim Linki (URL)" style="grid-column: 1 / 4;">\n                <input id="swal-t-doc" class="swal2-input" placeholder="DÃ¶kÃ¼man Linki (PDF/URL) (Ä°steÄŸe BaÄŸlÄ±)" style="grid-column: 1 / 4;">\n                <input id="swal-t-file" type="file" class="swal2-file" style="grid-column: 1 / 4; margin-top:6px;" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.png,.jpg,.jpeg">\n                <div style="grid-column:1/4; font-size:0.78rem; color:#6b7280; margin-top:-4px;">\n                  Ä°stersen dosyayÄ± buradan yÃ¼kle (PDF/Word/PowerPoint...). YÃ¼klenen dosya eÄŸitim kartÄ±nda â€œDÃ¶kÃ¼manÄ± Ä°ndirâ€ olarak gÃ¶rÃ¼nÃ¼r.\n                </div>\n                <input type="date" id="swal-t-start" class="swal2-input" value="${(new Date).toISOString().substring(0,10)}">\n                <input type="date" id="swal-t-end" class="swal2-input">\n                <input id="swal-t-duration" class="swal2-input" placeholder="SÃ¼re (Ã–rn: 20dk)">\n            </div>\n            <select id="swal-t-target" class="swal2-input" onchange="updateTrainingTarget(this.value)" style="margin-top:10px;">\n                <option value="Genel">Herkese (TÃ¼m Ekip)</option>\n                <option value="TelesatÄ±ÅŸ">TelesatÄ±ÅŸ Ekibi</option>\n                <option value="Chat">Chat Ekibi</option>\n                <option value="Individual">KiÅŸiye Ã–zel</option>\n            </select>\n            <select id="swal-t-agent" class="swal2-input" style="display:none; width:100%;"></select>\n        `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Ata",didOpen:()=>{window.__trainingUpload={name:"",mime:"",b64:""};const e=document.getElementById("swal-t-file");e&&e.addEventListener("change",e=>{const t=e.target.files&&e.target.files[0];if(!t)return void(window.__trainingUpload={name:"",mime:"",b64:""});const a=new FileReader;a.onload=()=>{const e=String(a.result||""),n=e.includes(",")?e.split(",")[1]:"";window.__trainingUpload={name:t.name,mime:t.type||"application/octet-stream",b64:n}},a.readAsDataURL(t)}),window.updateTrainingTarget=function(e){const t=document.getElementById("swal-t-agent");t.style.display="Individual"===e?"block":"none","Individual"===e&&(t.innerHTML=adminUserList.map(e=>`<option value="${e.name}">${e.name}</option>`).join(""))},updateTrainingTarget("Genel")},preConfirm:()=>{const e=document.getElementById("swal-t-target").value,t="Individual"===e?document.getElementById("swal-t-agent").value:"";return document.getElementById("swal-t-title").value&&(e||t)?{title:document.getElementById("swal-t-title").value,desc:document.getElementById("swal-t-desc").value,link:document.getElementById("swal-t-link").value,docLink:document.getElementById("swal-t-doc").value||"N/A",docFile:window.__trainingUpload&&window.__trainingUpload.b64?window.__trainingUpload:null,target:e,targetAgent:t,creator:currentUser,startDate:document.getElementById("swal-t-start").value,endDate:document.getElementById("swal-t-end").value,duration:document.getElementById("swal-t-duration").value}:(Swal.showValidationMessage("BaÅŸlÄ±k ve Atama AlanÄ± boÅŸ bÄ±rakÄ±lamaz"),!1)}});if(e)try{if(Swal.fire({title:"AtanÄ±yor...",didOpen:()=>Swal.showLoading()}),e.docFile){const t=await apiCall("uploadTrainingDoc",{fileName:e.docFile.name,mimeType:e.docFile.mime,base64:e.docFile.b64});e.docLink=t&&t.url?t.url:e.docLink}const t=await apiCall("assignTraining",{...e});t&&"success"===t.result?(Swal.fire("BaÅŸarÄ±lÄ±","EÄŸitim atandÄ±.","success"),loadTrainingData()):Swal.fire("Hata",t&&t.message||"Ä°ÅŸlem baÅŸarÄ±sÄ±z","error")}catch(e){Swal.fire("Hata",e.message||"Ä°ÅŸlem baÅŸarÄ±sÄ±z","error")}}async function fetchFeedbackLogs(){try{const e=await apiCall("fetchFeedbackLogs",{});feedbackLogsData="success"===e.result&&e.feedbackLogs||[]}catch(e){console.error("Feedback Logs Ã§ekilirken hata oluÅŸtu:",e),feedbackLogsData=[]}}function formatPeriod(e){if(!e||"N/A"===e)return"N/A";if(e.match(/^\d{2}\.\d{4}$/))return e;try{const t=new Date(e);if(!isNaN(t.getTime())){const e=String(t.getMonth()+1).padStart(2,"0");return`${e}.${t.getFullYear()}`}}catch(e){console.error("DÃ¶nem formatlama hatasÄ±:",e)}return e}function loadFeedbackList(){const e=document.getElementById("feedback-list");e.innerHTML="";const t=document.getElementById("manual-feedback-admin-btn");t&&(t.style.display=isAdminMode?"flex":"none");const a=document.getElementById("q-feedback-month"),n=a?a.value:null,i=allEvaluationsData.filter(e=>{const t=e.feedbackType&&"mail"===e.feedbackType.toLowerCase(),a=e.callId&&String(e.callId).toUpperCase().startsWith("MANUEL-");if(!t&&!a)return!1;if(n){const t=e.callDate&&"N/A"!==e.callDate?e.callDate:e.date;if(!t)return!1;const a=t.split(".");if(a.length<3)return!1;return`${a[1].padStart(2,"0")}.${a[2]}`===n}return!0});0!==i.length?i.forEach(t=>{const a="SÃ¶zlÃ¼"===t.feedbackType?"#2196f3":"Mail"===t.feedbackType?"#e65100":"Bilgilendirme"===t.feedbackType?"#0288d1":"Feedback"===t.feedbackType?"#2e7d32":"#10b981",n=String(t.callId).toUpperCase().startsWith("MANUEL-")?String(t.callId).substring(7):t.callId,i=String(t.details).startsWith("[")?"DeÄŸerlendirme Konusu":t.details||"BelirtilmemiÅŸ",l=String(t.callId).toUpperCase().startsWith("MANUEL-");let r=t.period||t.date.substring(3),s=t.channel&&String(t.channel).trim()?String(t.channel).trim():"Yok";const o=t.feedbackType||"Yok";if(l){const e=feedbackLogsData.find(e=>String(e.callId)===String(n));e&&(r=formatPeriod(e.period)||r,s=e.channel&&"N/A"!==e.channel?e.channel:"Yok")}e.innerHTML+=`\n            <div class="feedback-card" style="border-left-color: ${a};">\n                <div class="feedback-header">\n                    <div style="font-weight:bold; color:#0e1b42; font-size:1.1rem;">${t.agent}</div>\n                    <div class="feedback-info-right">\n                        <span><i class="fas fa-user-check"></i> DeÄŸerleyen: ${t.evaluator}</span>\n                        <span><i class="fas fa-id-badge"></i> Ã‡aÄŸrÄ± ID: ${n}</span>\n                        <span><i class="fas fa-calendar-alt"></i> Tarih: ${t.callDate}</span>\n                    </div>\n                </div>\n                <div class="feedback-body">\n                    <div style="font-weight:bold; color:#333; margin-bottom:5px;">Konu/AÃ§Ä±klama: ${i}</div>\n                    <div style="color:#555; line-height:1.5; font-size:0.95rem;">${t.feedback}</div>\n                </div>\n                <div class="feedback-footer">\n                     <div style="display:flex; gap:10px; font-size:0.7rem; color:#666; font-weight:600; margin-right:10px;">\n                        <span><i class="fas fa-calendar-week"></i> DÃ¶nem: ${r}</span>\n                        <span><i class="fas fa-comment-alt"></i> Kanal: ${s}</span>\n                        <span><i class="fas fa-tag"></i> Tip: ${o}</span>\n                     </div>\n                     \n            </div>`}):e.innerHTML='<div style="padding:20px; text-align:center; color:#888;">GÃ¶rÃ¼ntÃ¼lenecek filtrelenmiÅŸ geri bildirim yok (Sadece Mail veya Manuel).</div>'}async function addManualFeedbackPopup(){if(!isAdminMode)return;0===adminUserList.length&&(Swal.fire({title:"KullanÄ±cÄ± Listesi YÃ¼kleniyor...",didOpen:()=>Swal.showLoading()}),await fetchUserListForAdmin(),Swal.close());const e=new Date,t=e.getMonth(),a=e.getFullYear();let n="";for(let e=0;e<6;e++){let i=(t-e+12)%12,l=a-(t-e<0?1:0);const r=`${MONTH_NAMES[i]} ${l}`;n+=`<option value="${`${String(i+1).padStart(2,"0")}.${l}`}" ${0===e?"selected":""}>${r}</option>`}const i=`\n        <div class="manual-feedback-form">\n            <div class="form-group">\n                <label for="manual-q-agent">Temsilci AdÄ± <span class="required">*</span></label>\n                <select id="manual-q-agent" class="swal2-input"></select>\n            </div>\n            <div class="form-group">\n                <label for="manual-q-topic">Konu / BaÅŸlÄ±k <span class="required">*</span></label>\n                <input id="manual-q-topic" class="swal2-input" placeholder="Geri bildirim konusu (Ã–rn: Yeni Kampanya Bilgilendirmesi)">\n            </div>\n            \n            <div class="grid-2-cols">\n                <div class="form-group">\n                    <label for="manual-q-callid">Ã‡aÄŸrÄ±/EtkileÅŸim ID <span class="required">*</span></label>\n                    <input id="manual-q-callid" class="swal2-input" placeholder="ID (Ã–rn: 123456)">\n                </div>\n                <div class="form-group">\n                    <label for="manual-q-date">Tarih <span class="required">*</span></label>\n                    <input type="date" id="manual-q-date" class="swal2-input" value="${(new Date).toISOString().substring(0,10)}">\n                </div>\n            </div>\n            <div class="grid-3-cols">\n                <div class="form-group">\n                    <label for="manual-q-channel">Kanal</label>\n                    <select id="manual-q-channel" class="swal2-input">\n                        <option value="Telefon">Telefon</option>\n                        <option value="CanlÄ± Destek">CanlÄ± Destek</option>\n                        <option value="E-posta">E-posta</option>\n                        <option value="Sosyal Medya">Sosyal Medya</option>\n                        <option value="Yok">Yok/DiÄŸer</option>\n                    </select>\n                </div>\n                <div class="form-group">\n                    <label for="manual-q-period">DÃ¶nem</label>\n                    <select id="manual-q-period" class="swal2-input">${n}</select>\n                </div>\n                <div class="form-group">\n                    <label for="manual-q-type">Tip</label>\n                    <select id="manual-q-type" class="swal2-input">\n                        <option value="Feedback">Feedback</option>\n                        <option value="Bilgilendirme">Bilgilendirme</option>\n                        <option value="SÃ¶zlÃ¼">SÃ¶zlÃ¼</option>\n                        <option value="Mail">Mail</option>\n                        <option value="Ã–zel">Ã–zel Konu</option>\n                    </select>\n                </div>\n            </div>\n            \n            <div class="form-group">\n                <label for="manual-q-feedback">Geri Bildirim DetaylarÄ± <span class="required">*</span></label>\n                <textarea id="manual-q-feedback" class="swal2-textarea" placeholder="Buraya geri bildirimin detaylÄ± metnini giriniz..."></textarea>\n            </div>\n        </div>\n        <style>\n            /* Manuel Geri Bildirim Formu Stil Ä°yileÅŸtirmeleri */\n            .manual-feedback-form {\n                text-align: left;\n                padding: 10px;\n                background: #fcfcfc;\n                border-radius: 8px;\n                border: 1px solid #eee;\n            }\n            .form-group {\n                margin-bottom: 12px;\n            }\n            .form-group label {\n                font-size: 0.85rem;\n                font-weight: 600;\n                color: var(--primary);\n                display: block;\n                margin-bottom: 4px;\n            }\n            .grid-2-cols {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 15px;\n            }\n            .grid-3-cols {\n                display: grid;\n                grid-template-columns: 1fr 1fr 1fr;\n                gap: 15px;\n            }\n            .required {\n                color: var(--accent);\n                font-size: 0.9rem;\n            }\n            /* Input/Select/Textarea stillerini genel swal2-input stilinden devraldÄ±k */\n            .manual-feedback-form .swal2-input, .manual-feedback-form .swal2-textarea {\n                width: 100% !important;\n                box-sizing: border-box !important;\n                margin: 0 !important;\n                padding: 10px 12px !important;\n                border: 1px solid #dcdcdc !important;\n                border-radius: 6px !important;\n                font-size: 0.95rem !important;\n                transition: border-color 0.2s, box-shadow 0.2s;\n            }\n            .manual-feedback-form .swal2-input:focus, .manual-feedback-form .swal2-textarea:focus {\n                border-color: var(--secondary) !important;\n                box-shadow: 0 0 0 2px rgba(250, 187, 0, 0.2) !important;\n            }\n            .manual-feedback-form .swal2-textarea {\n                min-height: 100px;\n                resize: vertical;\n            }\n        </style>\n    `,{value:l}=await Swal.fire({title:"Manuel Geri Bildirim Yaz",html:i,width:"600px",showCancelButton:!0,confirmButtonText:'<i class="fas fa-save"></i> Kaydet',didOpen:()=>{const e=document.getElementById("manual-q-agent");adminUserList.forEach(t=>e.innerHTML+=`<option value="${t.name}">${t.name}</option>`)},preConfirm:()=>{const e=document.getElementById("manual-q-agent").value,t=document.getElementById("manual-q-topic").value,a=document.getElementById("manual-q-feedback").value,n=document.getElementById("manual-q-type").value,i=document.getElementById("manual-q-channel").value,l=document.getElementById("manual-q-period").value,r=document.getElementById("manual-q-callid").value.trim(),s=document.getElementById("manual-q-date").value,o=formatDateToDDMMYYYY(s);return e&&a&&r&&s&&t?{agentName:e,callId:"MANUEL-"+r,callDate:o,score:100,details:t,feedback:a,feedbackType:n,agentGroup:"Genel",channel:i,period:l}:(Swal.showValidationMessage("TÃ¼m (*) iÅŸaretli alanlar zorunludur!"),!1)}});if(l){try{const e=String(l.agentName||"").trim().toLowerCase(),t=String(l.callId||"").trim();if(Array.isArray(allEvaluationsData)&&allEvaluationsData.some(a=>String(a.agent||a.agentName||"").trim().toLowerCase()===e&&String(a.callId||"").trim()===t)){if(!(await Swal.fire({icon:"warning",title:"MÃ¼kerrer Dinleme",html:`<div style="text-align:left; line-height:1.4;">\n                            <b>${l.agentName}</b> iÃ§in <b>Call ID: ${escapeHtml(l.callId)}</b> daha Ã¶nce kaydedilmiÅŸ gÃ¶rÃ¼nÃ¼yor.<br>\n                            <span style="color:#666; font-size:0.9rem;">Yine de yeni kayÄ±t oluÅŸturmak istiyor musun?</span>\n                           </div>`,showCancelButton:!0,confirmButtonText:"Evet, kaydet",cancelButtonText:"VazgeÃ§",reverseButtons:!0})).isConfirmed)return}}catch(e){console.warn("Duplicate check failed",e)}Swal.fire({title:"Kaydediliyor...",didOpen:()=>Swal.showLoading()}),apiCall("logEvaluation",{...l}).then(async e=>{"success"===e.result?(Swal.fire({icon:"success",title:"Kaydedildi",timer:1500,showConfirmButton:!1}),fetchEvaluationsForAgent(l.agentName),fetchFeedbackLogs().then(()=>{loadFeedbackList()})):Swal.fire("Hata",e.message,"error")})}}async function fetchEvaluationsForAgent(e,t=!1){const a=document.getElementById("evaluations-list");t||(a.innerHTML="YÃ¼kleniyor...");const n=document.getElementById("q-admin-group"),i=document.getElementById("q-admin-agent");let l=e||currentUser,r="all";isAdminMode&&i&&(l=e||i.value,r=n?n.value:"all");try{const e=document.getElementById("q-eval-month"),n=e?e.value:null,i=await apiCall("fetchEvaluations",{targetAgent:l,targetGroup:r,period:n});if("success"===i.result){if(allEvaluationsData=i.evaluations,t)return;a.innerHTML="";const e=allEvaluationsData.filter(e=>!String(e.callId).toUpperCase().startsWith("MANUEL-"));let n=e;const s=document.getElementById("q-eval-month"),o=s?s.value:null;o&&(n=e.filter(e=>{const t=e.callDate||e.date;if(!t)return!1;const a=String(t).split(".");if(a.length<3){const e=new Date(t);if(!isNaN(e)){return`${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`===o}return!1}return`${a[1].padStart(2,"0")}.${a[2].split(" ")[0]}`===o}));const d=e=>{const t=(e.date||e.callDate||"").toString().trim();if(!t)return 0;const a=t.match(/^(\d{2})\.(\d{2})\.(\d{4})/);if(a)return new Date(`${a[3]}-${a[2]}-${a[1]}T00:00:00`).getTime();const n=new Date(t);return isNaN(n)?0:n.getTime()};if(n.sort((e,t)=>d(t)-d(e)),0===n.length)return void(a.innerHTML='<p style="padding:20px; text-align:center; color:#666;">KayÄ±t yok.</p>');let c="";n.forEach((e,t)=>{e.score>=90||e.score,e.score>=90||e.score;const a=e.score>=90?"#48bb78":e.score>=70?"#ed8936":"#f56565";let n=isAdminMode?`<i class="fas fa-pen" style="font-size:0.9rem; color:#718096; cursor:pointer; transition:0.2s;" onmouseover="this.style.color='#3182ce'" onmouseout="this.style.color='#718096'" onclick="event.stopPropagation(); editEvaluation('${e.callId}')"></i>`:"";const i=escapeHtml(e.agent||""),s=null!=e.agentName?String(e.agentName).trim():"",o=s&&s!==String(e.agent||"").trim();let d="all"!==l&&l!==r||!o?"":`<span style="font-size:0.75rem; font-weight:700; color:#4a5568; background:#edf2f7; padding:2px 8px; border-radius:12px; margin-left:8px;">${escapeHtml(s)}</span>`,u="";try{let t=e.details;"string"==typeof t&&(t=JSON.parse(t)),Array.isArray(t)?(u='<div class="eval-row-grid-v2">',t.forEach(e=>{let t=e.score<e.max,a=e.note?`<div class="eval-note-v2" style="margin-top:4px; font-size:0.75rem;"><i class="fas fa-sticky-note"></i> ${e.note}</div>`:"";u+=`\n                            <div class="eval-crit-card-v2 ${t?"failed":"success"}">\n                                <div class="eval-crit-text-v2">\n                                    ${escapeHtml(e.q)}\n                                    ${a}\n                                </div>\n                                <div class="eval-crit-val-v2" style="color: ${t?"#ef4444":"#10b981"}">\n                                    ${e.score} / ${e.max}\n                                </div>\n                            </div>`}),u+="</div>"):u=`<div class="eval-feedback-box-v2">${"object"==typeof e.details?escapeHtml(JSON.stringify(e.details)):escapeHtml(String(e.details))}</div>`}catch(t){console.error("Detail parse error:",t),u=`<div class="eval-feedback-box-v2">${"object"==typeof e.details?escapeHtml(JSON.stringify(e.details)):escapeHtml(String(e.details))}</div>`}const m=e.callDate&&"N/A"!==e.callDate?e.callDate:"N/A",p=e.date||e.callDate||"N/A",g=e.isSeen,y=e.agentNote||"",f=e.managerReply||"",h=e.status||"TamamlandÄ±";let b="";isAdminMode?y&&"KapatÄ±ldÄ±"!==h&&(b+=`\n                         <div style="margin-top:20px; display:flex; justify-content:flex-end;">\n                            <button class="eval-action-btn-v2 btn-primary-v2" \n                              onclick="event.stopPropagation(); openAdminReplyPopup('${e.callId}', '${escapeHtml(e.agent)}', '${escapeHtml(y)}')">\n                              <i class="fas fa-reply"></i> YanÄ±tla / Kapat\n                            </button>\n                         </div>`):"KapatÄ±ldÄ±"!==h&&(b+=`\n                         <div style="margin-top:20px; display:flex; justify-content:flex-end;">\n                            <button class="eval-action-btn-v2 btn-warning-v2" \n                              onclick="event.stopPropagation(); openAgentNotePopup('${e.callId}', '${a}', true)">\n                              <i class="fas fa-comment-dots"></i> GÃ¶rÃ¼ÅŸ / Not Ekle\n                            </button>\n                         </div>`);let v="";(y||f)&&(v+='<div class="eval-section-v2">\n                        <div class="eval-section-title-v2"><i class="fas fa-comments"></i> MesajlaÅŸma</div>\n                        <div class="eval-interaction-pane">',y&&(v+=`<div class="eval-interaction-bubble bubble-agent">\n                            <div class="bubble-header"><i class="fas fa-user-edit"></i> Temsilci Notu</div>\n                            ${escapeHtml(y)}\n                        </div>`),f&&(v+=`<div class="eval-interaction-bubble bubble-manager" style="align-self: flex-end; border-bottom-left-radius: 12px;">\n                            <div class="bubble-header"><i class="fas fa-user-shield"></i> YÃ¶netici CevabÄ±</div>\n                            ${escapeHtml(f)}\n                        </div>`),v+="</div></div>");const k=g?"seen":"unseen",w=g?'<i class="fas fa-check-double"></i>':'<i class="fas fa-eye-slash"></i>',x=g?"GÃ¶rÃ¼ldÃ¼":"HenÃ¼z GÃ¶rÃ¼lmedi",S="Bekliyor"===h?`<span style="background:#fff3e0; color:#e65100; font-size:0.7rem; font-weight:800; padding:2px 8px; border-radius:10px; margin-left:8px; border:1px solid #ffe0b2;">${h}</span>`:"";c+=`\n                <div class="eval-card-v2" id="eval-card-${t}" onclick="newToggleEvaluationDetail(${t}, '${e.callId}', ${g}, this)">\n                    <div class="eval-card-main">\n                        <div class="eval-card-left">\n                            <div class="eval-score-orb" style="background:${a}">\n                                <span class="score-val">${e.score}</span>\n                                <span class="score-label">Puan</span>\n                            </div>\n                            <div class="eval-info-block">\n                                <div class="eval-agent-name">\n                                    ${i} ${d} ${S}\n                                </div>\n                                <div class="eval-meta-row">\n                                    <div class="eval-meta-item"><i class="fas fa-phone"></i> ${m}</div>\n                                    <div class="eval-meta-item"><i class="fas fa-headphones"></i> ${p}</div>\n                                    <div class="eval-id-pill" onclick="event.stopPropagation(); copyText('${escapeHtml(e.callId||"")}')" title="Kopyala">\n                                        <i class="fas fa-hashtag"></i> ${escapeHtml(e.callId||"")}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="eval-card-right">\n                             ${n}\n                             <div class="eval-status-icon ${k}" title="${x}">\n                                ${w}\n                             </div>\n                        </div>\n                    </div>\n                    <div class="eval-details-pane-v2" id="eval-details-${t}">\n                        <div class="eval-details-inner">\n                            <div class="eval-grid-v2">\n                                <div class="eval-left-col">\n                                    <div class="eval-section-v2">\n                                        <div class="eval-section-title-v2"><i class="fas fa-tasks"></i> DeÄŸerlendirme Kriterleri</div>\n                                        ${u}\n                                    </div>\n                                </div>\n                                <div class="eval-right-col">\n                                    <div class="eval-section-v2">\n                                        <div class="eval-section-title-v2"><i class="fas fa-bullhorn"></i> Feedback</div>\n                                        <div class="eval-feedback-box-v2">\n                                            ${e.feedback||"Geri bildirim belirtilmemiÅŸ."}\n                                        </div>\n                                    </div>\n                                    ${v}\n                                    ${b}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>`}),a.innerHTML=c}}catch(e){console.error(e),t||(a.innerHTML='\n            <div style="text-align:center; padding:40px; color:#666;">\n                <i class="fas fa-exclamation-triangle" style="font-size:2rem; color:#e53e3e; margin-bottom:15px;"></i>\n                <p style="font-weight:600;">BaÄŸlantÄ± Sorunu</p>\n                <p style="font-size:0.9rem; margin-bottom:15px;">Veriler alÄ±nÄ±rken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.</p>\n                <button onclick="fetchEvaluationsForAgent()" class="q-btn-v2" style="background:var(--primary); color:white; border:none; padding:8px 20px; border-radius:6px; cursor:pointer;">\n                    <i class="fas fa-sync"></i> Yeniden Dene\n                </button>\n            </div>')}}function newToggleEvaluationDetail(e,t,a,n){const i=document.getElementById(`eval-details-${e}`),l=document.getElementById(`eval-card-${e}`);if(!l.classList.contains("expanded")){if(l.classList.add("expanded"),i.style.maxHeight=i.scrollHeight+"px",!a&&t&&!isAdminMode){apiCall("markEvaluationSeen",{callId:t});const e=l.querySelector(".eval-status-icon");e&&(e.classList.remove("unseen"),e.classList.add("seen"),e.innerHTML='<i class="fas fa-check-double"></i>',e.title="GÃ¶rÃ¼ldÃ¼")}}else l.classList.remove("expanded"),i.style.maxHeight="0px"}function updateAgentListBasedOnGroup(){const e=document.getElementById("q-admin-group"),t=document.getElementById("q-admin-agent");if(!e||!t)return;const a=e.value;t.innerHTML="";let n=adminUserList.filter(e=>"user"===String(e.role).toLowerCase()),i=n;"all"!==a?(i=n.filter(e=>e.group===a),t.innerHTML=`<option value="all">-- TÃ¼m ${a} Ekibi --</option>`):t.innerHTML='<option value="all">-- TÃ¼m Temsilciler --</option>',i.forEach(e=>{t.innerHTML+=`<option value="${e.name}">${e.name}</option>`}),fetchEvaluationsForAgent()}function fetchUserListForAdmin(){return new Promise(e=>{apiCall("getUserList",{}).then(t=>{if("success"===t.result){const a=["chat","istchat","satÄ±ÅŸ","satis","telesatis","telesatÄ±ÅŸ"];adminUserList=t.users.filter(e=>{if(!e.group)return!1;const t=String(e.role||"").toLowerCase().trim(),n=String(e.group).toLowerCase().trim(),i="user"===t,l=a.some(e=>n.includes(e));return i&&l}),e(adminUserList)}else e([])}).catch(t=>e([]))})}function fetchCriteria(e){return new Promise(t=>{apiCall("getCriteria",{group:e}).then(e=>{"success"===e.result?t(e.criteria||[]):t([])}).catch(e=>t([]))})}function toggleEvaluationDetail(e,t,a,n){const i=document.getElementById(`eval-details-${e}`);if(i.style.maxHeight&&"0px"!==i.style.maxHeight)i.style.maxHeight="0px",i.style.marginTop="0";else if(i.style.maxHeight=i.scrollHeight+500+"px",i.style.marginTop="10px",!a&&t&&!isAdminMode){apiCall("markEvaluationSeen",{callId:t});const a=document.getElementById(`badge-new-${e}`);a&&(a.style.display="none")}}async function exportEvaluations(){if(!isAdminMode)return;let e='<option value="all">TÃ¼m Zamanlar</option>';const t=new Date;for(let a=0;a<12;a++){let a=t.toLocaleDateString("tr-TR",{month:"long",year:"numeric"});e+=`<option value="${(t.getMonth()+1).toString().padStart(2,"0")+"-"+t.getFullYear()}">${a}</option>`,t.setMonth(t.getMonth()-1)}const{value:a}=await Swal.fire({title:"Rapor Ä°ndir",html:`\n            <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">Hangi dÃ¶nem iÃ§in rapor almak istersiniz?</p>\n            <select id="swal-export-period" class="swal2-input" style="width:80%; margin:0 auto;">\n                ${e}\n            </select>\n        `,showCancelButton:!0,confirmButtonText:"Ä°ndir",cancelButtonText:"VazgeÃ§",preConfirm:()=>document.getElementById("swal-export-period").value});if(!a)return;const n=document.getElementById("q-admin-group"),i=document.getElementById("q-admin-agent");Swal.fire({title:"Rapor HazÄ±rlanÄ±yor...",html:"Veriler iÅŸleniyor, lÃ¼tfen bekleyin.<br>Bu iÅŸlem veri yoÄŸunluÄŸuna gÃ¶re biraz sÃ¼rebilir.",didOpen:()=>Swal.showLoading()}),Swal.fire({title:"Rapor HazÄ±rlanÄ±yor...",html:"Veriler iÅŸleniyor, lÃ¼tfen bekleyin.<br>Bu iÅŸlem veri yoÄŸunluÄŸuna gÃ¶re biraz sÃ¼rebilir.",didOpen:()=>Swal.showLoading()}),apiCall("exportEvaluations",{targetAgent:i?i.value:"all",targetGroup:n?n.value:"all",targetPeriod:a}).then(e=>{if("success"===e.result&&e.data){const t=e.headers,a=e.data;let n=0,i=a.length,l=0,r=100;a.forEach(e=>{let t=parseFloat(e[5])||0;n+=t,t>l&&(l=t),t<r&&(r=t)});let s=i>0?(n/i).toFixed(2):0,o=`\n            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">\n            <head><meta charset="utf-8"></head>\n            <body>\n            <h2 style="font-family:Arial">Kalite DeÄŸerlendirme Raporu</h2>\n            <table border="1" style="border-collapse:collapse; font-family:Arial; font-size:12px; margin-bottom:20px;">\n                <tr style="background-color:#E0E0E0; font-weight:bold;">\n                    <td colspan="2" style="padding:10px; font-size:14px;">YÃ¶netici Ã–zeti</td>\n                </tr>\n                <tr><td><strong>Rapor Tarihi:</strong></td><td>${(new Date).toLocaleDateString()}</td></tr>\n                <tr><td><strong>Toplam KayÄ±t:</strong></td><td>${i}</td></tr>\n                <tr><td><strong>Genel Ortalama:</strong></td><td style="font-size:14px; font-weight:bold; color:${s>=85?"green":s<70?"red":"orange"}">${s}</td></tr>\n                <tr><td><strong>En YÃ¼ksek Puan:</strong></td><td>${l}</td></tr>\n                <tr><td><strong>En DÃ¼ÅŸÃ¼k Puan:</strong></td><td>${r}</td></tr>\n            </table>\n\n            <br>\n\n            <table border="1" style="border-collapse:collapse; font-family:Arial; font-size:11px;">\n                <thead>\n                    <tr style="background-color:#2c3e50; color:white; height:30px;">\n                        ${t.map(e=>`<th style="padding:5px; white-space:nowrap;">${e}</th>`).join("")}\n                    </tr>\n                </thead>\n                <tbody>\n            `;a.forEach(e=>{let t=e[5],a="";a=t>=90?"background-color:#C6EFCE; color:#006100; font-weight:bold;":t<70?"background-color:#FFC7CE; color:#9C0006; font-weight:bold;":"background-color:#FFEB9C; color:#9C6500;";let n=e[7],i="";"Ä°ncelemede"===n&&(i="background-color:#FFF2CC; font-weight:bold;"),o+="<tr>",e.forEach((e,t)=>{let n="padding:5px; vertical-align:top;";5===t&&(n+=a),7===t&&(n+=i);let l=null==e?"":String(e);o+=`<td style="${n} mso-number-format:'@';">${l}</td>`}),o+="</tr>"}),o+="</tbody></table></body></html>";const d=new Blob([o],{type:"application/vnd.ms-excel"}),c=document.createElement("a"),u=URL.createObjectURL(d);c.setAttribute("href",u),c.setAttribute("download",e.fileName||"Rapor.xls"),document.body.appendChild(c),c.click(),document.body.removeChild(c),Swal.fire({icon:"success",title:"Rapor Ä°ndirildi",text:"Excel dosyasÄ± hazÄ±rlandÄ±.",timer:1500,showConfirmButton:!1})}else Swal.fire("Hata",e.message||"Veri alÄ±namadÄ±.","error")}).catch(e=>{console.error(e),Swal.fire("Hata","Sunucu hatasÄ± oluÅŸtu.","error")})}async function logEvaluationPopup(){const e=document.getElementById("q-admin-agent"),t=e?e.value:"";if(!t||"all"===t)return void Swal.fire("UyarÄ±","LÃ¼tfen listeden bir temsilci seÃ§iniz.","warning");let a="Genel";const n=adminUserList.find(e=>e.name.toLowerCase()===t.toLowerCase());n&&n.group&&(a=n.group);const i=a.toLowerCase().replace(/iÌ‡/g,"i").replace(/Ä±/g,"i").replace(/ÅŸ/g,"s").replace(/ÄŸ/g,"g").replace(/Ã¼/g,"u").replace(/Ã¶/g,"o").replace(/Ã§/g,"c").trim(),l=i.includes("chat")||"ob"===i||i.includes("canli"),r=i.includes("telesat")||i.includes("satis")||i.includes("sales");let s=a;l?s="Chat":r&&(s="TelesatÄ±ÅŸ"),Swal.fire({title:"HazÄ±rlanÄ±yor...",didOpen:()=>Swal.showLoading()});let o=[];s&&"Genel"!==s&&(o=await fetchCriteria(s)),Swal.close();const d=o.length>0;let c="";d&&(c+='<div class="criteria-list-v2">',o.forEach((e,t)=>{let a=parseInt(e.points)||0;if(0===a)return;const n=escapeForJsString(e.text);if(l){let i=parseInt(e.mediumScore)||0,l=parseInt(e.badScore)||0;c+=`\n                    <div class="criteria-item-v2" id="criteria-${t}" data-max-score="${a}" data-current-score="${a}">\n                        <div class="criteria-top">\n                            <span class="criteria-name" title="${n}">${t+1}. ${e.text}</span>\n                            <span class="criteria-max">Maks: ${a} Puan</span>\n                        </div>\n                        <div class="criteria-actions">\n                            <div class="eval-btn-group-v2">\n                                <button class="eval-btn-v2 active good" data-score="${a}" onclick="v2_setScore(${t}, ${a}, ${a}, 'good')">Ä°yi</button>\n                                ${i>0?`<button class="eval-btn-v2 medium" data-score="${i}" onclick="v2_setScore(${t}, ${i}, ${a}, 'medium')">Orta</button>`:""}\n                                <button class="eval-btn-v2 bad" data-score="${l}" onclick="v2_setScore(${t}, ${l}, ${a}, 'bad')">KÃ¶tÃ¼</button>\n                            </div>\n                        </div>\n                        <div class="criteria-note-row" id="note-row-${t}" style="display:none; margin-top:8px;">\n                            <input type="text" id="note-${t}" class="eval-input-v2" placeholder="Durum notu ekleyin..." style="width:100%; height:34px; font-size:0.85rem;">\n                        </div>\n                    </div>`}else r&&(c+=`\n                    <div class="criteria-item-v2" id="criteria-${t}" data-max-score="${a}" data-current-score="${a}">\n                        <div class="criteria-top">\n                            <span class="criteria-name" title="${n}">${t+1}. ${e.text}</span>\n                            <span class="criteria-max" id="val-${t}">${a} / ${a}</span>\n                        </div>\n                        <div class="criteria-actions">\n                            <input type="range" class="custom-range" id="slider-${t}" min="0" max="${a}" value="${a}" \n                                   oninput="v2_updateSlider(${t}, ${a})" style="width:100%;">\n                        </div>\n                        <div class="criteria-note-row" id="note-row-${t}" style="display:none; margin-top:8px;">\n                            <input type="text" id="note-${t}" class="eval-input-v2" placeholder="Eksik/GeliÅŸim notu..." style="width:100%; height:34px; font-size:0.85rem;">\n                        </div>\n                    </div>`)}),c+="</div>");const u=`\n        <div class="eval-modal-v2">\n            <div class="eval-form-header">\n                <div class="eval-form-user">\n                    <div class="eval-form-avatar">${t.charAt(0).toUpperCase()}</div>\n                    <div>\n                        <div style="font-size:0.8rem; color:#718096; font-weight:700;">DEÄžERLENDÄ°RÄ°LEN</div>\n                        <div style="font-size:1.1rem; font-weight:800; color:#2d3748;">${t}</div>\n                    </div>\n                </div>\n                <div class="eval-form-score-box">\n                    <div class="eval-form-score-val" id="v2-live-score">100</div>\n                    <div class="eval-form-score-label">TOPLAM PUAN</div>\n                </div>\n            </div>\n\n            <div class="eval-form-grid">\n                <div class="eval-input-group">\n                    <label>Call ID <span style="color:#e53e3e">*</span></label>\n                    <input id="eval-callid" class="eval-input-v2" placeholder="Ã–rn: 123456">\n                </div>\n                <div class="eval-input-group">\n                    <label>Ã‡aÄŸrÄ± Tarihi</label>\n                    <input type="date" id="eval-calldate" class="eval-input-v2" value="${(new Date).toISOString().substring(0,10)}">\n                </div>\n            </div>\n\n            ${d?c:'\n                <div style="padding:20px; background:#f8fafc; border:1px dashed #cbd5e0; border-radius:12px; text-align:center; margin-bottom:20px;">\n                    <label style="display:block; margin-bottom:8px; font-weight:700;">Manuel Puan</label>\n                    <input id="eval-manual-score" type="number" class="eval-input-v2" value="100" min="0" max="100" style="width:80px; text-align:center; font-size:1.2rem; font-weight:800;">\n                </div>\n                <div class="eval-input-group" style="margin-bottom:20px;">\n                    <label>DeÄŸerlendirme DetaylarÄ±</label>\n                    <textarea id="eval-details" class="eval-input-v2" style="height:100px;" placeholder="DetaylÄ± analizlerinizi buraya yazÄ±n..."></textarea>\n                </div>\n            '}\n\n            <div class="eval-form-grid" style="margin-bottom:15px;">\n                <div class="eval-input-group">\n                    <label>Geri Bildirim Tipi</label>\n                    <select id="feedback-type" class="eval-input-v2">\n                        <option value="Yok" selected>Yok</option>\n                        <option value="SÃ¶zlÃ¼">SÃ¶zlÃ¼</option>\n                        <option value="Mail">Mail</option>\n                    </select>\n                </div>\n            </div>\n\n            <div class="eval-input-group">\n                <label>Genel Geri Bildirim / KoÃ§luk Notu</label>\n                <textarea id="eval-feedback" class="eval-input-v2" style="height:80px;" placeholder="Temsilciye iletilecek geliÅŸim mesajÄ±..."></textarea>\n            </div>\n        </div>`,{value:m}=await Swal.fire({html:u,width:"600px",showCancelButton:!0,confirmButtonText:" ðŸ’¾  Kaydet",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>{r?window.recalcTotalSliderScore():l&&window.recalcTotalScore()},preConfirm:()=>{const e=document.getElementById("eval-callid").value.trim();if(!e)return Swal.showValidationMessage("Call ID alanÄ± boÅŸ bÄ±rakÄ±lamaz!"),!1;const n=document.getElementById("eval-calldate").value,i=n?`${n}T00:00:00`:(new Date).toISOString();if(d){let n=0,s=[];for(let e=0;e<o.length;e++){const t=o[e];if(0===parseInt(t.points))continue;let a=0,i=document.getElementById(`note-${e}`).value;const d=document.getElementById(`criteria-${e}`);if(l){const e=d.querySelector(".eval-btn-v2.active");a=e?parseInt(e.getAttribute("data-score")):0}else r&&(a=parseInt(document.getElementById(`slider-${e}`).value)||0);n+=a,s.push({q:t.text,max:parseInt(t.points),score:a,note:i})}return{agentName:t,agentGroup:a,callId:e,callDate:i,score:n,details:JSON.stringify(s),feedback:document.getElementById("eval-feedback").value,feedbackType:document.getElementById("feedback-type").value,status:"TamamlandÄ±"}}return{agentName:t,agentGroup:a,callId:e,callDate:i,score:parseInt(document.getElementById("eval-manual-score").value),details:document.getElementById("eval-details").value,feedback:document.getElementById("eval-feedback").value,feedbackType:document.getElementById("feedback-type").value,status:"TamamlandÄ±"}}});m&&(Swal.fire({title:"Kaydediliyor...",didOpen:()=>Swal.showLoading()}),apiCall("logEvaluation",{...m}).then(e=>{"success"===e.result?(Swal.fire({icon:"success",title:"Kaydedildi",timer:1500,showConfirmButton:!1}),fetchEvaluationsForAgent(m.agentName),fetchFeedbackLogs().then(()=>{loadFeedbackList()})):Swal.fire("Hata",e.message,"error")}))}async function editEvaluation(e){const t=allEvaluationsData.find(t=>String(t.callId).trim()===String(e).trim());if(!t)return void Swal.fire("Hata","KayÄ±t bulunamadÄ±.","error");const a=t.agent,n=t.group||"Genel",i=n.toLowerCase().replace(/iÌ‡/g,"i").replace(/Ä±/g,"i").replace(/ÅŸ/g,"s").replace(/ÄŸ/g,"g").replace(/Ã¼/g,"u").replace(/Ã¶/g,"o").replace(/Ã§/g,"c").trim(),l=i.includes("chat")||"ob"===i,r=i.includes("telesat");let s=n;l?s="Chat":r&&(s="TelesatÄ±ÅŸ"),Swal.fire({title:"Ä°nceleniyor...",didOpen:()=>Swal.showLoading()});let o=[];s&&"Genel"!==s&&(o=await fetchCriteria(s)),Swal.close();const d=o.length>0;let c=t.details;if("string"==typeof c)try{c=JSON.parse(c||"[]")}catch(e){c=[]}Array.isArray(c)||(c=[]);let u="";if(t.callDate)if(String(t.callDate).includes("T"))u=t.callDate.split("T")[0];else if(String(t.callDate).includes(".")){let e=t.callDate.split(".");3===e.length&&(u=`${e[2]}-${e[1]}-${e[0]}`)}else u=t.callDate;let m="";d&&(m+='<div class="criteria-list-v2">',o.forEach((e,t)=>{let a=parseInt(e.points)||0;if(0===a)return;const n=escapeForJsString(e.text),i=String(e.text||"").trim().toLowerCase();let s=c.find(e=>String(e.q||e.text||"").trim().toLowerCase()===i)||(c[t]?c[t]:{score:a,note:""}),o=void 0!==s.score?s.score:void 0!==s.points?s.points:a,d=parseInt(o);isNaN(d)&&(d=a);let u=s.note||"";if(l){let i=parseInt(e.mediumScore)||0,l=parseInt(e.badScore)||0,r=d===a?"active":"",s=d===i&&0!==i?"active":"",o=d===l||0===d&&0===l?"active":"";m+=`\n                    <div class="criteria-item-v2 ${d<a?"failed":""}" id="criteria-${t}" data-max-score="${a}">\n                        <div class="criteria-top"><span class="criteria-name" title="${n}">${t+1}. ${e.text}</span><span class="criteria-max">Maks: ${a} Puan</span></div>\n                        <div class="criteria-actions">\n                            <div class="eval-btn-group-v2">\n                                <button type="button" class="eval-btn-v2 ${r} good" data-score="${a}" onclick="v2_setScore(${t}, ${a}, ${a}, 'good')">Ä°yi</button>\n                                ${i>0?`<button type="button" class="eval-btn-v2 ${s} medium" data-score="${i}" onclick="v2_setScore(${t}, ${i}, ${a}, 'medium')">Orta</button>`:""}\n                                <button type="button" class="eval-btn-v2 ${o} bad" data-score="${l}" onclick="v2_setScore(${t}, ${l}, ${a}, 'bad')">KÃ¶tÃ¼</button>\n                            </div>\n                        </div>\n                        <div class="criteria-note-row" id="note-row-${t}" style="display:${d<a?"block":"none"}; margin-top:8px;">\n                             <input type="text" id="note-${t}" class="eval-input-v2" value="${u}" placeholder="Not ekle..." style="width:100%; height:32px; padding:4px 10px; font-size:0.8rem;">\n                        </div>\n                    </div>`}else r&&(m+=`\n                    <div class="criteria-item-v2 ${d<a?"failed":""}" id="criteria-${t}" data-max-score="${a}">\n                        <div class="criteria-top"><span class="criteria-name" title="${n}">${t+1}. ${e.text}</span><span class="criteria-max" id="val-${t}">${d} / ${a}</span></div>\n                        <div class="criteria-actions" style="flex-wrap: wrap;">\n                            <input type="range" class="custom-range" id="slider-${t}" min="0" max="${a}" value="${d}" oninput="v2_updateSlider(${t}, ${a})" style="width:100%;">\n                        </div>\n                        <div class="criteria-note-row" id="note-row-${t}" style="display:${d<a?"block":"none"}; margin-top:8px; width: 100%;">\n                            <input type="text" id="note-${t}" class="eval-input-v2" value="${u}" placeholder="Not..." style="width:100%; height:32px; padding:4px 10px; font-size:0.8rem;">\n                        </div>\n                    </div>`)}),m+="</div>");const p=`\n        <div class="eval-modal-v2">\n            <div class="eval-form-header" style="border-bottom-color:#1976d2;"><div class="eval-form-user"><div class="eval-form-avatar" style="background:#1976d2;">${a.charAt(0).toUpperCase()}</div><div><div style="font-size:0.8rem; color:#718096; font-weight:700;">DÃœZENLENEN</div><div style="font-size:1.1rem; font-weight:800; color:#1976d2;">${a}</div></div></div><div class="eval-form-score-box"><div class="eval-form-score-val" id="v2-live-score">${t.score}</div><div class="eval-form-score-label">MEVCUT PUAN</div></div></div>\n            <div class="eval-form-grid" style="background:#f0f7ff; border:1px solid #cde4ff;"><div class="eval-input-group"><label>Call ID</label><input id="eval-callid" class="eval-input-v2" value="${t.callId}" readonly style="background:#e1efff; cursor:not-allowed;"></div><div class="eval-input-group"><label>Ã‡aÄŸrÄ± Tarihi</label><input type="date" id="eval-calldate" class="eval-input-v2" value="${u}"></div></div>\n            <div style="margin:15px 0; font-weight:800; font-size:0.9rem; color:#4a5568;"><i class="fas fa-edit" style="color:#1976d2;"></i> KRÄ°TERLERÄ° GÃœNCELLE</div>\n            ${d?m:`<div style="padding:20px; background:#f8fafc; border:1px dashed #cbd5e0; border-radius:12px; text-align:center; margin-bottom:20px;"><label style="display:block; margin-bottom:8px; font-weight:700;">Manuel Puan</label><input id="eval-manual-score" type="number" class="eval-input-v2" value="${t.score}" min="0" max="100" style="width:80px; text-align:center;"></div><textarea id="eval-details" class="eval-input-v2" style="height:100px;">${"string"==typeof t.details?t.details:""}</textarea>`}\n            <div class="eval-input-group"><label>Revize Feedback / Notlar</label><textarea id="eval-feedback" class="eval-input-v2" style="height:100px;">${t.feedback||""}</textarea></div>\n        </div>`,{value:g}=await Swal.fire({html:p,width:"600px",showCancelButton:!0,confirmButtonText:" ðŸ’¾  DeÄŸiÅŸiklikleri Kaydet",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>{window.v2_recalc()},preConfirm:()=>{const e=document.getElementById("eval-callid").value;let n=document.getElementById("eval-calldate").value;if(n&&n.match(/^\d{4}-\d{2}-\d{2}$/))n=`${n}T00:00:00`;else if(n&&n.match(/^\d{2}\.\d{2}\.\d{4}$/)){const e=n.split(".");n=`${e[2]}-${e[0]}-${e[1]}T00:00:00`}const i=document.getElementById("eval-feedback").value;if(d){let l=0,r=[];for(let e=0;e<o.length;e++){const t=o[e];if(0===parseInt(t.points))continue;let a=0,n=document.getElementById(`note-${e}`).value;const i=document.getElementById(`criteria-${e}`),s=i.querySelector('input[type="range"]');if(s)a=parseInt(s.value)||0;else{const e=i.querySelector(".eval-btn-v2.active");a=e?parseInt(e.getAttribute("data-score")):0}l+=a,r.push({q:t.text,max:parseInt(t.points),score:a,note:n})}return{agentName:a,callId:e,callDate:n,score:l,details:JSON.stringify(r),feedback:i,status:t.status||"TamamlandÄ±"}}return{agentName:a,callId:e,callDate:n,score:parseInt(document.getElementById("eval-manual-score").value),details:document.getElementById("eval-details").value,feedback:i,status:t.status||"TamamlandÄ±"}}});g&&(Swal.fire({title:"GÃ¼ncelleniyor...",didOpen:()=>Swal.showLoading()}),apiCall("updateEvaluation",{...g}).then(e=>{"success"===e.result?(Swal.fire({icon:"success",title:"GÃ¼ncellendi",timer:1500,showConfirmButton:!1}),fetchEvaluationsForAgent(a),fetchFeedbackLogs().then(()=>{loadFeedbackList()})):Swal.fire("Hata",e.message,"error")}))}const TELESales_OFFERS_FALLBACK=[{offer:"YILLIK - 1299 TL",segment:"WÄ°NBACK",description:"KullanÄ±cÄ± daha Ã¶nce aylÄ±k ya da yÄ±llÄ±k herhangi bir paket kullanmÄ±ÅŸ, ardÄ±ndan paket sonlanmÄ±ÅŸ ve ÅŸu anda aktif paketi olmayan kullanÄ±cÄ±larÄ± aradÄ±ÄŸÄ±mÄ±z bir data",note:"KullanÄ±cÄ±nÄ±n izleme geÃ§miÅŸi olabilir."},{offer:"AYLIK  - 6 AY 109 TL",segment:"WÄ°NBACK",description:"KullanÄ±cÄ± daha Ã¶nce aylÄ±k ya da yÄ±llÄ±k herhangi bir paket kullanmÄ±ÅŸ, ardÄ±ndan paket sonlanmÄ±ÅŸ ve ÅŸu anda aktif paketi olmayan kullanÄ±cÄ±larÄ± aradÄ±ÄŸÄ±mÄ±z bir data",note:"KullanÄ±cÄ±nÄ±n izleme geÃ§miÅŸi olabilir."},{offer:"YILLIK - 1399 TL",segment:"CANCELLÄ°NG",description:"AboneliÄŸinde iptal talebinde bulunmuÅŸ, paket sÃ¼resi bitimine kadar eriÅŸime devam eden, geri kazanÄ±m iÃ§in aradÄ±ÄŸÄ±mÄ±z bir data",note:"KullanÄ±cÄ±nÄ±n izleme geÃ§miÅŸi olabilir. Ä°ndirim oranÄ± yÃ¼ksek + KullanÄ±cÄ±nÄ±n bir iptal nedeni olabilir"},{offer:"AYLIK  - 6 AY 119 TL",segment:"CANCELLÄ°NG",description:"AboneliÄŸinde iptal talebinde bulunmuÅŸ, paket sÃ¼resi bitimine kadar eriÅŸime devam eden, geri kazanÄ±m iÃ§in aradÄ±ÄŸÄ±mÄ±z bir data",note:"KullanÄ±cÄ±nÄ±n izleme geÃ§miÅŸi olabilir. Ä°ndirim oranÄ± yÃ¼ksek + KullanÄ±cÄ±nÄ±n bir iptal nedeni olabilir"},{offer:"YILLIK - 1499 TL",segment:"ACTÄ°VE GRACE",description:"Paket yenileme sÃ¼recine giren fakat Ã¼cret alÄ±namadÄ±ÄŸÄ± iÃ§in paketi yenilenemeyen kullanÄ±cÄ±larÄ± aradÄ±ÄŸÄ±mÄ±z bir data",note:"Paket yenileme sÃ¼recinden bir Ã¶deme sorunu oluÅŸtuÄŸunu bu nedenle aboneliÄŸinin yenilenmediÄŸini, kullanÄ±cÄ±ya hem bu sorunu Ã§Ã¶zmek hem de indirimli fiyatlar Ã¼zerinden yardÄ±mcÄ± olmak +Ä°Ã§erik"},{offer:"AYLIK  - 6 AY 109 TL",segment:"ACTÄ°VE GRACE",description:"Paket yenileme sÃ¼recine giren fakat Ã¼cret alÄ±namadÄ±ÄŸÄ± iÃ§in paketi yenilenemeyen kullanÄ±cÄ±larÄ± aradÄ±ÄŸÄ±mÄ±z bir data",note:"Paket yenileme sÃ¼recinden bir Ã¶deme sorunu oluÅŸtuÄŸunu bu nedenle aboneliÄŸinin yenilenmediÄŸini, kullanÄ±cÄ±ya hem bu sorunu Ã§Ã¶zmek hem de indirimli fiyatlar Ã¼zerinden yardÄ±mcÄ± olmak +Ä°Ã§erik"},{offer:"YILLIK - 1499 TL",segment:"INBOUND",description:"Inbound Ã¼zerinden gelen satÄ±n alma talepleri ya da satÄ±ÅŸa ikna edilen kullanÄ±cÄ±lar iÃ§in sunulan teklif",note:""},{offer:"AYLIK - 6 AY 139,5 TL",segment:"INBOUND",description:"Inbound Ã¼zerinden gelen satÄ±n alma talepleri ya da satÄ±ÅŸa ikna edilen kullanÄ±cÄ±lar iÃ§in sunulan teklif",note:""}],SPORTS_RIGHTS_FALLBACK=[{item:"Euroleague maÃ§larÄ± ve stÃ¼dyo programlarÄ±",period:"2025-2026 / 2026- 2027 / 2027-2028 / 2028-2029",note:""},{item:"Bundesliga",period:"2025-2026 / 2026- 2027 / 2027-2028 / 2028-2029",note:""},{item:"Bundesliga 2",period:"2025-2026 / 2026- 2027 / 2027-2028 / 2028-2029",note:""},{item:"Ä°spanya LaLiga Ã¶nemli maÃ§larÄ±",period:"2025 - 2026 / 2026 - 2027",note:""},{item:"LaLiga 2 Ã¶nemli maÃ§larÄ±",period:"2025 - 2026 / 2026 - 2027",note:""},{item:"Ä°talya Serie A Ã¶nemli maÃ§larÄ±",period:"2025 - 2026 / 2026 - 2027",note:""},{item:"Portekiz Liga Portugal Ã¶nemli maÃ§larÄ±",period:"2025 - 2026",note:""},{item:"Suudi Arabistan Pro Lig Ã¶nemli maÃ§larÄ±",period:"2025-2026 / 2026- 2027 / 2027-2028 / 2028-2029",note:""},{item:"Hollanda Ligi",period:"2025-2026 / 2026- 2027 / 2027-2028 / 2028-2029",note:""},{item:"Ä°skoÃ§ya Premiership Ã¶nemli maÃ§larÄ±",period:"2025 - 2026 / 2026 - 2027",note:""},{item:"NCAA Amerikan Futbol",period:"2025 - 2026 / 2026 - 2027",note:""},{item:"NCAA Basketbol",period:"2025 - 2026 / 2026 - 2027",note:""},{item:"NFL",period:"2025 - 2026",note:""},{item:"NBA",period:"2025-2026 / 2026- 2027 / 2027-2028 / 2028-2029",note:""},{item:"EuroCup",period:"2025-2026 / 2026- 2027 / 2027-2028 / 2028-2029",note:""},{item:"Yunanistan Basketbol Ligi Ã¶nemli maÃ§larÄ±",period:"2025 - 2026 Sezon belirsiz",note:""},{item:"NCAA",period:"2025 - 2026 / 2026 - 2027",note:""},{item:"Libertadores KupasÄ±",period:"2027, 2028, 2029, 2030 (4 seasons)",note:""},{item:"Copa Sudamericana",period:"2027, 2028, 2029, 2030 (4 seasons)",note:""},{item:"WRC",period:"2025",note:"2026 da alÄ±nabilir net deÄŸil"},{item:"Nascar",period:"2025 - 2026 - 2027 - 2028 ve 2029",note:""},{item:"IndyCar",period:"2025 - 2026 - 2027",note:""},{item:"MotoGP - Moto2 - Moto3",period:"2025 - 2026 - 2027",note:""},{item:"ATP Tenis TurnuvalarÄ± Ã¶nemli maÃ§lar",period:"2025 - 2026 - 2027 and 2028",note:""},{item:"Wimbledon Tenis Ã¶nemli maÃ§lar",period:"2025 - 2026 - 2027",note:""},{item:"UFC DÃ¶vÃ¼ÅŸ Gecesi yayÄ±nlarÄ±",period:"2027 sonuna kadar bizde",note:""},{item:"Oktagon",period:"2025",note:""},{item:"PFL MMA",period:"2025",note:""},{item:"Cage Warriors Boks MaÃ§larÄ±",period:"2025",note:""},{item:"BKFC",period:"KaldÄ±rÄ±ldÄ±",note:""}];function setActiveFilterButton(e){try{document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e&&e.classList.add("active")}catch(e){}}function showHomeScreen(){const e=document.getElementById("home-screen"),t=document.getElementById("cardGrid"),a=document.getElementById("emptyMessage");e&&(e.style.display="block"),t&&(t.style.display="none"),a&&(a.style.display="none"),renderHomePanels()}function hideHomeScreen(){const e=document.getElementById("home-screen");e&&(e.style.display="none");const t=document.getElementById("cardGrid");t&&(t.style.display="grid")}function renderHomePanels(){const e=document.getElementById("home-today");e&&(e.innerHTML='<div class="home-mini-item">YayÄ±n akÄ±ÅŸÄ± yÃ¼kleniyor...</div>',(async()=>{try{const t=await fetchBroadcastFlow(),a=new Date,n=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`,i=e=>{const t=String(e||"").trim();if(!t)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const a=t.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);return a?`${a[3]}-${a[2]}-${a[1]}`:""},l=(t||[]).filter(e=>{if(i(e.dateISO||e.date)!==n)return!1;const t=Date.now(),a=Number(e.startEpoch||0);if(a)return a>t;const l=String(e.time||"").trim().match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);if(!l)return!0;const r=parseInt(l[1],10),s=parseInt(l[2],10),o=parseInt(l[3]||"0",10),d=new Date;return d.setHours(r,s,o,0),d.getTime()>t});if(l.length){const t=l.slice(0,4);e.innerHTML=t.map(e=>{const t=escapeHtml(e.time||""),a=escapeHtml(e.match||e.title||e.event||""),n=escapeHtml(e.channel||e.platform||""),i=escapeHtml(e.league||e.category||""),l=escapeHtml(e.spiker||e.spikers||e.commentator||e.commentators||"");return`\n                          <div class="home-mini-item">\n                            <div class="home-mini-date">${t}${i?` â€¢ ${i}`:""}${n?` â€¢ ${n}`:""}</div>\n                            <div class="home-mini-title">${a||"MaÃ§"}</div>\n                            ${l?`<div class="home-mini-desc" style="margin-top:4px;color:#555">ðŸŽ™ ${l}</div>`:""}\n                          </div>\n                        `}).join("")+(l.length>t.length?`<div style="color:#666;font-size:.9rem;margin-top:6px">+${l.length-t.length} maÃ§ dahaâ€¦</div>`:"")}else e.innerHTML='<div class="home-mini-item">BugÃ¼n iÃ§in yayÄ±n akÄ±ÅŸÄ± kaydÄ± bulunamadÄ±.</div>';const r=e.closest(".home-card");r&&(r.classList.add("clickable"),r.onclick=()=>openBroadcastFlow())}catch(t){e.innerHTML='<div class="home-mini-item">YayÄ±n akÄ±ÅŸÄ± alÄ±namadÄ±.</div>'}})());const t=document.getElementById("home-ann");if(t){const e=(newsData||[]).slice(0,3);0===e.length?t.innerHTML='<div class="home-mini-item">HenÃ¼z duyuru yok.</div>':t.innerHTML=e.map(e=>`\n                <div class="home-mini-item">\n                  <div class="home-mini-date">${escapeHtml(e.date||"")}</div>\n                  <div class="home-mini-title">${escapeHtml(e.title||"")}</div>\n                  <div class="home-mini-desc" style="white-space: pre-line">${escapeHtml(String(e.desc||"")).slice(0,160)}${(e.desc||"").length>160?"...":""}</div>\n                </div>\n            `).join("");const a=t.closest(".home-card");a&&(a.classList.add("clickable"),a.onclick=()=>openNews())}const a=document.getElementById("home-quote");if(a){const e=homeBlocks.quote,t=(e?.content||e?.text||localStorage.getItem("homeQuote")||"").trim(),n=e?.title||e?.head||"";if(t)a.innerHTML=`\n                <div class="home-quote-content">\n                    <i class="fas fa-quote-left quote-icon-start"></i>\n                    <p class="quote-text">${escapeHtml(t)}</p>\n                    ${n?`<p class="quote-author">â€” ${escapeHtml(n)}</p>`:""}\n                </div>\n            `,a.style.display="";else{a.innerHTML='<span style="color:#999">BugÃ¼n iÃ§in bir sÃ¶z eklenmemiÅŸ.</span>';try{sb&&sb.from("HomeBlocks").select("*").eq("Key","quote").single().then(({data:e,error:t})=>{if(!t&&e){const t=normalizeKeys(e);homeBlocks=homeBlocks||{},homeBlocks.quote=t;try{localStorage.setItem("homeBlocksCache",JSON.stringify(homeBlocks||{}))}catch(e){}try{renderHomePanels()}catch(e){}}})}catch(e){}}}try{renderHomeLeaderboard()}catch(e){}try{const e=document.getElementById("home-edit-today"),t=document.getElementById("home-edit-ann"),a=document.getElementById("home-edit-quote");e&&(e.style.display="none"),t&&(t.style.display="none"),a&&(a.style.display=isAdminMode&&isEditingActive?"inline-flex":"none")}catch(e){}}function editHomeBlock(e){if(!isAdminMode)return void Swal.fire("Yetkisiz","Bu iÅŸlem iÃ§in admin yetkisi gerekli.","warning");if(!isEditingActive)return void Swal.fire("KapalÄ±","DÃ¼zenleme modu kapalÄ±. Ã–nce 'DÃ¼zenlemeyi AÃ§' demelisin.","info");const t=String(homeBlocks&&homeBlocks.quote&&homeBlocks.quote.content?homeBlocks.quote.content:localStorage.getItem("homeQuote")||"").trim(),a=String(homeBlocks&&homeBlocks.quote&&homeBlocks.quote.title?homeBlocks.quote.title:"").trim();Swal.fire({title:"GÃ¼nÃ¼n SÃ¶zÃ¼ DÃ¼zenle",html:`\n            <div style="text-align:left; margin-bottom:10px;">\n                <label style="font-weight:bold; display:block; margin-bottom:5px;">SÃ¶z Ä°Ã§eriÄŸi:</label>\n                <textarea id="edit-quote-content" class="swal2-textarea" style="margin:0; width:100%; height:100px;">${escapeHtml(t)}</textarea>\n            </div>\n            <div style="text-align:left;">\n                <label style="font-weight:bold; display:block; margin-bottom:5px;">Yazar / Kaynak:</label>\n                <input id="edit-quote-author" class="swal2-input" style="margin:0; width:100%;" value="${escapeHtml(a)}">\n            </div>\n        `,showCancelButton:!0,confirmButtonText:"Kaydet",cancelButtonText:"VazgeÃ§",preConfirm:()=>({content:(document.getElementById("edit-quote-content").value||"").trim(),author:(document.getElementById("edit-quote-author").value||"").trim()})}).then(e=>{if(!e.isConfirmed)return;const{content:t,author:a}=e.value;apiCall("updateHomeBlock",{key:"quote",title:a,content:t,visibleGroups:""}).then(()=>{homeBlocks=homeBlocks||{},homeBlocks.quote={key:"quote",title:a,content:t,visibleGroups:""};try{localStorage.setItem("homeBlocksCache",JSON.stringify(homeBlocks||{}))}catch(e){}renderHomePanels(),Swal.fire("Kaydedildi","GÃ¼nÃ¼n sÃ¶zÃ¼ gÃ¼ncellendi.","success")}).catch(e=>{console.error("Home block update error:",e),Swal.fire("Hata","VeritabanÄ± gÃ¼ncellenemedi.","error")})})}function openCardDetail(e){const t=(database||[]).find(t=>String(t.id)===String(e));t?showCardDetail(t):Swal.fire("Hata","Kart bulunamadÄ±.","error")}let telesalesOffers=[],telesalesScriptsLoaded=!1;function safeGetToken(){try{return"function"==typeof getToken?getToken():""}catch(e){return""}}async function fetchSheetObjects(e){const t=await apiCall(e);return t.data||t.items||[]}async function maybeLoadTelesalesScriptsFromSheet(){if(!telesalesScriptsLoaded){telesalesScriptsLoaded=!0;try{const e=JSON.parse(localStorage.getItem("telesalesScriptsOverride")||"[]");if(Array.isArray(e)&&e.length)return}catch(e){}try{const e=await fetchSheetObjects("getTelesalesScripts");Array.isArray(e)&&e.length&&(window.salesScripts=e.map(e=>({id:e.id||e.ID||e.Id||"",title:e.title||e.BaÅŸlÄ±k||e.Baslik||e.Script||e["Script BaÅŸlÄ±ÄŸÄ±"]||"Script",text:e.text||e.Metin||e["Script Metni"]||e.content||""})).filter(e=>e.text))}catch(e){}}}async function syncTelesalesScriptsToSheet(e){try{await apiCall("saveTelesalesScripts",{scripts:e||[]})}catch(e){}}async function openQualityArea(){const e=document.getElementById("quality-fullscreen");if(!e)return;try{const e="undefined"!=typeof menuPermissions&&menuPermissions?menuPermissions.quality:null;if(e&&!isAllowedByPerm(e))return void Swal.fire("Yetkisiz","Kalite ekranÄ±na eriÅŸimin yok.","warning")}catch(e){}e.style.display="flex",document.body.classList.add("fs-open"),document.body.style.overflow="hidden";const t=document.getElementById("q-side-avatar"),a=document.getElementById("q-side-name"),n=document.getElementById("q-side-role");t&&(t.innerText=(currentUser||"U").trim().slice(0,1).toUpperCase()),a&&(a.innerText=currentUser||"KullanÄ±cÄ±"),n&&(n.innerText=isAdminMode?"YÃ¶netici":"Temsilci");const i=document.getElementById("q-admin-filters"),l=document.getElementById("assign-training-btn"),r=document.getElementById("manual-feedback-admin-btn");if(isAdminMode){if(i){i.style.display="flex";const e=i.querySelector(".admin-btn");e&&(isLocAdmin||hasPerm("Reports")?e.style.display="":e.style.display="none");const t=i.querySelector(".add-btn");t&&(isLocAdmin||hasPerm("AddContent")?t.style.display="":t.style.display="none")}if(l&&(l.style.display="block"),r&&(r.style.display="flex"),adminUserList.length){const e=document.getElementById("q-admin-group");if(e){const t=["chat","istchat","satÄ±ÅŸ","satis"],a=[...new Set(adminUserList.map(e=>e.group).filter(e=>{if(!e)return!1;const a=e.toLowerCase();return t.some(e=>a.includes(e))}))].sort();e.innerHTML='<option value="all">TÃ¼m Gruplar</option>'+a.map(e=>`<option value="${e}">${e}</option>`).join("");try{updateAgentListBasedOnGroup()}catch(e){}}}}else i&&(i.style.display="none"),l&&(l.style.display="none"),r&&(r.style.display="none");0===adminUserList.length&&(Swal.fire({title:"Temsilci Listesi YÃ¼kleniyor...",didOpen:()=>Swal.showLoading(),showConfirmButton:!1}),await fetchUserListForAdmin(),Swal.close()),populateDashboardFilters(),populateFeedbackFilters(),populateFeedbackMonthFilter(),populateMonthFilterFull(),switchQualityTab("dashboard")}function closeFullQuality(){document.getElementById("quality-fullscreen").style.display="none",document.body.classList.remove("fs-open"),document.body.style.overflow="","qusers"===localStorage.getItem("sSportRole")&&logout()}function switchQualityTab(e,t){if(document.querySelectorAll("#quality-fullscreen .q-nav-item").forEach(e=>e.classList.remove("active")),t)t.classList.add("active");else{const t=document.querySelector(`#quality-fullscreen .q-nav-item[onclick*="${e}"]`);t&&t.classList.add("active")}document.querySelectorAll("#quality-fullscreen .q-view-section").forEach(e=>e.classList.remove("active"));const a=document.getElementById(`view-${e}`);a&&a.classList.add("active"),"dashboard"===e?loadQualityDashboard():"evaluations"===e?fetchEvaluationsForAgent():"feedback"===e?(populateFeedbackFilters(),populateFeedbackMonthFilter(),refreshFeedbackData()):"training"===e&&loadTrainingData()}async function openTelesalesArea(){try{const e="undefined"!=typeof menuPermissions&&menuPermissions?menuPermissions.telesales:null;if(e&&!isAllowedByPerm(e))return void Swal.fire("Yetkisiz","TeleSatÄ±ÅŸ ekranÄ±na eriÅŸimin yok.","warning")}catch(e){}const e=document.getElementById("telesales-fullscreen");if(!e)return;e.style.display="flex",document.body.classList.add("fs-open"),document.body.style.overflow="hidden";const t=document.getElementById("t-side-avatar"),a=document.getElementById("t-side-name"),n=document.getElementById("t-side-role");if(t&&(t.innerText=(currentUser||"U").trim().slice(0,1).toUpperCase()),a&&(a.innerText=currentUser||"KullanÄ±cÄ±"),n&&(n.innerText=isAdminMode?"Admin":"Temsilci"),0===telesalesOffers.length){let e=[];try{e=await fetchSheetObjects("getTelesalesOffers")}catch(e){}telesalesOffers=Array.isArray(e)&&e.length?e.map(e=>({segment:e.segment||e.Segment||e.SEGMENT||"",title:e.title||e.BaÅŸlÄ±k||e.Baslik||e.Teklif||e["Teklif AdÄ±"]||e["Teklif Adi"]||"",desc:e.desc||e.AÃ§Ä±klama||e.Aciklama||e.Detay||e["Detay/Not"]||"",note:e.note||e.Not||e.Note||"",image:e.image||e.Image||e.GÃ¶rsel||e.Gorsel||"",example:e.example||e.Ã–rnek||e.Ornek||"",tips:e.tips||e.Ä°pucu||e.Ipucu||"",objection:e.objection||e.Itiraz||"",reply:e.reply||e.Cevap||""})):Array.isArray(window.telesalesOffersFromSheet)&&window.telesalesOffersFromSheet.length?window.telesalesOffersFromSheet:TELESales_OFFERS_FALLBACK}renderTelesalesDataOffers(),await maybeLoadTelesalesScriptsFromSheet(),renderTelesalesScripts(),switchTelesalesTab("data")}function closeFullTelesales(){const e=document.getElementById("telesales-fullscreen");e&&(e.style.display="none"),document.body.classList.remove("fs-open"),document.body.style.overflow=""}function switchTelesalesTab(e){document.querySelectorAll("#telesales-fullscreen .q-nav-item").forEach(e=>e.classList.remove("active")),document.querySelectorAll("#telesales-fullscreen .q-nav-item").forEach(t=>{(t.getAttribute("onclick")||"").includes(`"${e}"`)&&t.classList.add("active")}),document.querySelectorAll("#telesales-fullscreen .q-view-section").forEach(e=>e.classList.remove("active"));const t=document.getElementById(`t-view-${e}`);t&&t.classList.add("active")}function hydrateTelesalesSegmentFilter(){const e=document.getElementById("t-data-seg");if(!e)return;const t=Array.from(new Set((telesalesOffers||[]).map(e=>e.segment).filter(Boolean))).sort();e.innerHTML='<option value="all">TÃ¼m Segmentler</option>'+t.map(e=>`<option value="${escapeHtml(e)}">${escapeHtml(e)}</option>`).join("")}function renderTelesalesDataOffers(){const e=document.getElementById("t-data-grid");if(!e)return;const t=(document.getElementById("t-data-search")?.value||"").toLowerCase(),a=(telesalesOffers||[]).filter(e=>{const a=`${e.title||""} ${e.desc||""} ${e.segment||""} ${e.tag||""}`.toLowerCase();return!t||a.includes(t)}),n=isAdminMode&&isEditingActive?'\n        <div style="grid-column:1/-1;display:flex;gap:10px;align-items:center;margin:6px 0 12px;">\n          <button class="x-btn x-btn-admin" onclick="addTelesalesOffer()"><i class="fas fa-plus"></i> Teklif Ekle</button>\n        </div>\n    ':"";if(0===a.length){e.innerHTML=n+'<div style="opacity:.7;padding:20px;grid-column:1/-1">SonuÃ§ bulunamadÄ±.</div>';const t=document.getElementById("t-data-count");return void(t&&(t.innerText="0 kayÄ±t"))}const i=document.getElementById("t-data-count");i&&(i.innerText=`${a.length} kayÄ±t`),e.innerHTML=n+a.map((e,t)=>`\n        <div class="q-training-card" onclick="showTelesalesOfferDetail(${t})" style="cursor:pointer">\n          ${e.image?`<div style="height:120px;overflow:hidden;border-radius:6px;margin-bottom:8px;"><img src="${processImageUrl(e.image)}" style="width:100%;height:100%;object-fit:cover;"></div>`:""}\n          <div class="t-training-head">\n            <div style="min-width:0">\n              <div class="q-item-title" style="font-size:1.02rem">${escapeHtml(e.title||"Teklif")}</div>\n            </div>\n            <div class="t-training-badge">${escapeHtml(e.segment||e.tag||"")}</div>\n          </div>\n          <div class="t-training-desc" style="white-space: pre-line">${escapeHtml((e.desc||"").slice(0,140))}${(e.desc||"").length>140?"...":""}</div>\n          <div style="margin-top:10px;color:#999;font-size:.8rem">(Detay iÃ§in tÄ±kla)</div>\n          ${isAdminMode&&isEditingActive?`\n            <div style="margin-top:12px;display:flex;gap:10px">\n              <button class="x-btn x-btn-admin" onclick="event.stopPropagation(); editTelesalesOffer(${t});"><i class="fas fa-pen"></i> DÃ¼zenle</button>\n              <button class="x-btn x-btn-admin" onclick="event.stopPropagation(); deleteTelesalesOffer(${t});"><i class="fas fa-trash"></i> Sil</button>\n            </div>\n          `:""}\n        </div>\n    `).join("")}function addTelesalesOffer(){Swal.fire({title:"TeleSatÄ±ÅŸ Teklifi Ekle",html:'\n          <input id="to-title" class="swal2-input" placeholder="BaÅŸlÄ±k*" style="margin-bottom:10px">\n          <input id="to-seg" class="swal2-input" placeholder="Segment" style="margin-bottom:10px">\n           <input id="to-img" class="swal2-input" placeholder="GÃ¶rsel URL (Ä°steÄŸe baÄŸlÄ±)" style="margin-bottom:10px">\n          <textarea id="to-desc" class="swal2-textarea" placeholder="AÃ§Ä±klama" style="margin-bottom:10px"></textarea>\n          <textarea id="to-note" class="swal2-textarea" placeholder="Not (Kritik Bilgi)"></textarea>\n         <textarea id="to-detail" class="swal2-textarea" placeholder="DiÄŸer Detay"></textarea>\n        ',showCancelButton:!0,confirmButtonText:"Ekle",cancelButtonText:"VazgeÃ§",preConfirm:()=>{const e=(document.getElementById("to-title").value||"").trim();return e?{title:e,segment:(document.getElementById("to-seg").value||"").trim(),image:(document.getElementById("to-img").value||"").trim(),desc:(document.getElementById("to-desc").value||"").trim(),note:(document.getElementById("to-note").value||"").trim(),detail:(document.getElementById("to-detail").value||"").trim(),pk:Date.now().toString()}:Swal.showValidationMessage("BaÅŸlÄ±k zorunlu")}}).then(async e=>{if(!e.isConfirmed)return;const t=e.value;Swal.fire({title:"Ekleniyor...",didOpen:()=>Swal.showLoading(),showConfirmButton:!1});try{telesalesOffers.unshift(t);const e=await apiCall("saveAllTelesalesOffers",{offers:telesalesOffers});"success"===e.result?(Swal.fire({icon:"success",title:"Eklendi",timer:1200,showConfirmButton:!1}),renderTelesalesDataOffers()):(telesalesOffers.shift(),Swal.fire("Hata",e.message||"Eklenemedi","error"))}catch(e){Swal.fire("Hata","Sunucu hatasÄ±.","error")}})}async function editTelesalesOffer(e){const t=(telesalesOffers||[])[e];if(!t)return;const{value:a}=await Swal.fire({title:"Teklifi DÃ¼zenle",html:`\n          <label>BaÅŸlÄ±k</label><input id="to-title" class="swal2-input" value="${escapeHtml(t.title||"")}">\n          <label>Segment</label><input id="to-seg" class="swal2-input" value="${escapeHtml(t.segment||"")}">\n          <label>GÃ¶rsel</label><input id="to-img" class="swal2-input" value="${escapeHtml(t.image||"")}">\n          <label>AÃ§Ä±klama</label><textarea id="to-desc" class="swal2-textarea">${escapeHtml(t.desc||"")}</textarea>\n           <label>Not</label><textarea id="to-note" class="swal2-textarea">${escapeHtml(t.note||"")}</textarea>\n          <label>Detay</label><textarea id="to-detail" class="swal2-textarea">${escapeHtml(t.detail||"")}</textarea>\n        `,showCancelButton:!0,confirmButtonText:"Kaydet",preConfirm:()=>{const e=(document.getElementById("to-title").value||"").trim();return e?{title:e,segment:(document.getElementById("to-seg").value||"").trim(),image:(document.getElementById("to-img").value||"").trim(),desc:(document.getElementById("to-desc").value||"").trim(),note:(document.getElementById("to-note").value||"").trim(),detail:(document.getElementById("to-detail").value||"").trim()}:Swal.showValidationMessage("BaÅŸlÄ±k zorunlu")}});if(!a)return;Swal.fire({title:"Kaydediliyor...",didOpen:()=>Swal.showLoading(),showConfirmButton:!1});const n=telesalesOffers[e];telesalesOffers[e]={...n,...a};try{const t=await apiCall("saveAllTelesalesOffers",{offers:telesalesOffers});"success"===t.result?(Swal.fire({icon:"success",title:"Kaydedildi",timer:1200,showConfirmButton:!1}),renderTelesalesDataOffers()):(telesalesOffers[e]=n,Swal.fire("Hata",t.message||"Kaydedilemedi","error"))}catch(t){telesalesOffers[e]=n,Swal.fire("Hata","Sunucu hatasÄ±.","error")}}function deleteTelesalesOffer(e){Swal.fire({title:"Silinsin mi?",text:"Bu teklif kalÄ±cÄ± olarak silinecek.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sil"}).then(async t=>{if(!t.isConfirmed)return;const a=telesalesOffers[e];telesalesOffers.splice(e,1);try{const t=await apiCall("saveAllTelesalesOffers",{offers:telesalesOffers});"success"===t.result?(renderTelesalesDataOffers(),Swal.fire({icon:"success",title:"Silindi",timer:1e3,showConfirmButton:!1})):(telesalesOffers.splice(e,0,a),Swal.fire("Hata",t.message||"Silinemedi","error"))}catch(t){telesalesOffers.splice(e,0,a),Swal.fire("Hata","Sunucu hatasÄ±.","error")}})}function showTelesalesOfferDetail(e){const t=(telesalesOffers||[])[e];if(!t)return;const a=t.image?`<img src="${processImageUrl(t.image)}" style="max-width:100%;border-radius:6px;margin-bottom:15px;">`:"";Swal.fire({title:escapeHtml(t.title||""),html:`<div style="text-align:left;line-height:1.6">\n                ${a}\n                <div style="margin-bottom:10px"><b>Segment:</b> ${escapeHtml(t.segment||"-")}</div>\n                 ${t.note?`<div style="margin-bottom:10px;background:#fff3cd;padding:8px;border-radius:4px;border-left:4px solid #ffc107;white-space: pre-line"><b>Not:</b> ${escapeHtml(t.note)}</div>`:""}\n                 <div style="white-space: pre-line">${escapeHtml(t.desc||"Detay yok.")}</div>\n                 ${t.detail?`<hr><div style="font-size:0.9rem;color:#666;white-space: pre-line">${escapeHtml(t.detail)}</div>`:""}\n              </div>`,showCloseButton:!0,showConfirmButton:!1,width:"720px",background:"#f8f9fa"})}function renderTelesalesScripts(){const e=document.getElementById("t-scripts-grid");if(!e)return;let t=salesScripts||[];try{const e=JSON.parse(localStorage.getItem("telesalesScriptsOverride")||"[]");Array.isArray(e)&&e.length&&(t=e)}catch(e){}const a=isAdminMode&&isEditingActive?'\n        <div style="display:flex;gap:10px;align-items:center;margin:6px 0 12px;">\n          <button class="x-btn x-btn-admin" onclick="addTelesalesScript()"><i class="fas fa-plus"></i> Script Ekle</button>\n        </div>\n    ':"";0!==t.length?e.innerHTML=a+t.map((e,t)=>`\n      <div class="news-item" style="border-left-color:#10b981;cursor:pointer" onclick="copyText('${escapeForJsString(e.text||"")}')">\n        <span class="news-title">${escapeHtml(e.title||"Script")}</span>\n        <div class="news-desc" style="white-space:pre-line">${escapeHtml(e.text||"")}</div>\n        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px">\n          <div class="news-tag" style="background:rgba(16,185,129,.08);color:#10b981;border:1px solid rgba(16,185,129,.25)">TÄ±kla & Kopyala</div>\n          ${isAdminMode&&isEditingActive?`\n            <div style="display:flex;gap:8px">\n              <button class="x-btn x-btn-admin" onclick="event.stopPropagation(); editTelesalesScript(${t});"><i class="fas fa-pen"></i></button>\n              <button class="x-btn x-btn-admin" onclick="event.stopPropagation(); deleteTelesalesScript(${t});"><i class="fas fa-trash"></i></button>\n            </div>\n          `:""}\n        </div>\n      </div>\n    `).join(""):e.innerHTML=a+'<div style="padding:16px;opacity:.7">Script bulunamadÄ±.</div>'}function getTelesalesScriptsStore(){try{const e=JSON.parse(localStorage.getItem("telesalesScriptsOverride")||"[]");if(Array.isArray(e)&&e.length)return e}catch(e){}return salesScripts||[]}function saveTelesalesScriptsStore(e){localStorage.setItem("telesalesScriptsOverride",JSON.stringify(e||[]))}function addTelesalesScript(){Swal.fire({title:"Script Ekle",html:'\n          <input id="ts-title" class="swal2-input" placeholder="BaÅŸlÄ±k">\n          <textarea id="ts-text" class="swal2-textarea" placeholder="Script metni"></textarea>\n        ',showCancelButton:!0,confirmButtonText:"Ekle",cancelButtonText:"VazgeÃ§",preConfirm:()=>{const e=(document.getElementById("ts-title").value||"").trim(),t=(document.getElementById("ts-text").value||"").trim();return t?{id:"local_"+Date.now(),title:e||"Script",text:t}:Swal.showValidationMessage("Script metni zorunlu")}}).then(e=>{if(!e.isConfirmed)return;const t=getTelesalesScriptsStore();t.unshift(e.value),saveTelesalesScriptsStore(t),syncTelesalesScriptsToSheet(t),renderTelesalesScripts()})}function editTelesalesScript(e){const t=getTelesalesScriptsStore(),a=t[e];a&&Swal.fire({title:"Script DÃ¼zenle",html:`\n          <input id="ts-title" class="swal2-input" placeholder="BaÅŸlÄ±k" value="${escapeHtml(a.title||"")}">\n          <textarea id="ts-text" class="swal2-textarea" placeholder="Script metni">${escapeHtml(a.text||"")}</textarea>\n        `,showCancelButton:!0,confirmButtonText:"Kaydet",cancelButtonText:"VazgeÃ§",preConfirm:()=>{const e=(document.getElementById("ts-title").value||"").trim(),t=(document.getElementById("ts-text").value||"").trim();return t?{...a,title:e||"Script",text:t}:Swal.showValidationMessage("Script metni zorunlu")}}).then(a=>{a.isConfirmed&&(t[e]=a.value,saveTelesalesScriptsStore(t),syncTelesalesScriptsToSheet(t),renderTelesalesScripts())})}function deleteTelesalesScript(e){Swal.fire({title:"Silinsin mi?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sil",cancelButtonText:"VazgeÃ§"}).then(t=>{if(!t.isConfirmed)return;const a=getTelesalesScriptsStore().filter((t,a)=>a!==e);saveTelesalesScriptsStore(a),syncTelesalesScriptsToSheet(a),renderTelesalesScripts()})}function renderTelesalesDocs(){const e=document.getElementById("t-docs");if(!e)return;const t=(trainingData||[]).filter(e=>"TelesatÄ±ÅŸ"===(e.target||"")||(e.title||"").toLowerCase().includes("telesatÄ±ÅŸ"));0!==t.length?e.innerHTML=t.map(e=>`\n      <div class="news-item" style="border-left-color:var(--secondary)">\n        <span class="news-date">${escapeHtml((e.startDate||"")+(e.endDate?" â†’ "+e.endDate:""))}</span>\n        <span class="news-title">${escapeHtml(e.title||"")}</span>\n        <div class="news-desc">${escapeHtml(e.desc||"")}</div>\n        ${e.link&&"N/A"!==e.link?`<a class="btn btn-link" href="${escapeHtml(e.link)}" target="_blank">Link</a>`:""}\n        ${e.docLink&&"N/A"!==e.docLink?`<a class="btn btn-link" href="${escapeHtml(e.docLink)}" target="_blank">DÃ¶kÃ¼man</a>`:""}\n      </div>\n    `).join(""):e.innerHTML='<div style="opacity:.7;padding:10px">Bu ekibe atanmÄ±ÅŸ dÃ¶kÃ¼man/eÄŸitim gÃ¶rÃ¼nmÃ¼yor.</div>'}async function openTechArea(e){const t=document.getElementById("tech-fullscreen");if(!t)return;t.style.display="flex",document.body.classList.add("fs-open"),document.body.style.overflow="hidden";const a=document.getElementById("x-side-avatar"),n=document.getElementById("x-side-name"),i=document.getElementById("x-side-role");a&&(a.innerText=(currentUser||"U").trim().slice(0,1).toUpperCase()),n&&(n.innerText=currentUser||"KullanÄ±cÄ±"),i&&(i.innerText=isAdminMode?"Admin":"Temsilci");try{if((!database||0===database.length)&&window.__dataLoadedPromise){["x-broadcast-list","x-access-list","x-app-list","x-activation-list","x-cards"].forEach(e=>{const t=document.getElementById(e);t&&(t.innerHTML='<div class="home-mini-item">YÃ¼kleniyor...</div>')}),await window.__dataLoadedPromise}}catch(e){}try{renderTechSections()}catch(e){}switchTechTab(e||"broadcast")}function closeFullTech(){const e=document.getElementById("tech-fullscreen");e&&(e.style.display="none"),document.body.classList.remove("fs-open"),document.body.style.overflow=""}function switchTechTab(e){document.querySelectorAll("#tech-fullscreen .q-nav-item").forEach(e=>e.classList.remove("active"));const t=document.querySelector(`#tech-fullscreen .q-nav-item[data-tech-tab="${e}"]`);t?t.classList.add("active"):document.querySelectorAll("#tech-fullscreen .q-nav-item").forEach(t=>{const a=t.getAttribute("onclick")||"";(a.includes(`'${e}'`)||a.includes(`"${e}"`))&&t.classList.add("active")}),document.querySelectorAll("#tech-fullscreen .q-view-section").forEach(e=>e.classList.remove("active"));let a=e;"broadcast"===e&&(a="wizard",renderTechWizardInto("x-wizard"));const n=document.getElementById(`x-view-${a}`);n&&n.classList.add("active")}async function openShiftArea(e){const t=document.getElementById("shift-fullscreen");if(!t)return;t.style.display="flex",document.body.classList.add("fs-open"),document.body.style.overflow="hidden";const a=document.getElementById("shift-side-avatar"),n=document.getElementById("shift-side-name"),i=document.getElementById("shift-side-role");a&&(a.innerText=(currentUser||"U").trim().slice(0,1).toUpperCase()),n&&(n.innerText=currentUser||"KullanÄ±cÄ±"),i&&(i.innerText=isAdminMode?"YÃ¶netici":"Temsilci");const l=document.getElementById("shift-admin-filters");isAdminMode?l&&(l.style.display="flex"):l&&(l.style.display="none"),await loadShiftData(),switchShiftTab(e||"plan")}function closeFullShift(){const e=document.getElementById("shift-fullscreen");e&&(e.style.display="none"),document.body.classList.remove("fs-open"),document.body.style.overflow=""}function switchShiftTab(e){document.querySelectorAll("#shift-fullscreen .q-nav-item").forEach(e=>e.classList.remove("active"));const t=document.querySelector(`#shift-fullscreen .q-nav-item[data-shift-tab="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll("#shift-fullscreen .q-view-section").forEach(e=>e.classList.remove("active"));const a=document.getElementById(`shift-view-${e}`);a&&a.classList.add("active")}async function loadShiftData(){try{renderShiftData((await apiCall("getShiftData")).shifts||{})}catch(e){console.error(e),Swal.fire("Hata",e.message||"Vardiya verileri alÄ±nÄ±rken bir hata oluÅŸtu.","error")}}function renderShiftData(e){const t=document.getElementById("shift-week-label");t&&(t.textContent=formatWeekLabel(e.weekLabel||""));const a=document.getElementById("shift-plan-my");if(a){const t=e.myRow,n=e.headers||[];if(t&&n.length){const e=n.map((e,a)=>{const n=(t.cells||[])[a]||"";return`<div class="shift-day"><div class="shift-day-date">${formatShiftDate(e)}</div><div class="shift-day-slot">${escapeHtml(n)}</div></div>`}).join("");a.innerHTML=`\n                <div class="shift-card-header">Benim Vardiyam</div>\n                <div class="shift-card-body">${e}</div>\n            `}else a.innerHTML='<p style="color:#666;">Vardiya tablosunda adÄ±nÄ±z bulunamadÄ±.</p>'}const n=document.getElementById("shift-plan-table");if(n){const t=e.headers||[],a=e.rows||[];if(t.length&&a.length){let e='<table class="shift-table"><thead><tr><th>Temsilci</th>';t.forEach(t=>{e+=`<th>${formatShiftDate(t)}</th>`}),e+="</tr></thead><tbody>",a.forEach(a=>{e+="<tr>",e+=`<td>${escapeHtml(a.name)}</td>`,t.forEach((t,n)=>{const i=(a.cells||[])[n]||"";e+=`<td>${escapeHtml(i)}</td>`}),e+="</tr>"}),e+="</tbody></table>",n.innerHTML=e}else n.innerHTML='<p style="color:#666;">Vardiya tablosu henÃ¼z hazÄ±rlanmadÄ±.</p>'}const i=document.getElementById("shift-requests-list");if(i){const t=e.myRequests||[];t.length?i.innerHTML=t.map(e=>`\n                <div class="shift-request-item">\n                    <div class="shift-request-top">\n                        <span class="shift-request-date">${escapeHtml(e.date||"")}</span>\n                        <span class="shift-request-status">${escapeHtml(e.status||"AÃ§Ä±k")}</span>\n                    </div>\n                    <div class="shift-request-body">\n                        <div><strong>TÃ¼r:</strong> ${escapeHtml(e.type||"")}</div>\n                        <div><strong>Mevcut:</strong> ${escapeHtml(e.current||"")}</div>\n                        <div><strong>Talep Edilen:</strong> ${escapeHtml(e.requested||"")}</div>\n                        ${e.friend?`<div><strong>ArkadaÅŸ:</strong> ${escapeHtml(e.friend||"")}</div>`:""}\n                        ${e.friendShift?`<div><strong>ArkadaÅŸ VardiyasÄ±:</strong> ${escapeHtml(e.friendShift||"")}</div>`:""}\n                        ${e.note?`<div><strong>Not:</strong> ${escapeHtml(e.note||"")}</div>`:""}\n                    </div>\n                    <div class="shift-request-footer">${escapeHtml(e.timestamp||"")}</div>\n                </div>\n            `).join(""):i.innerHTML='<p style="color:#666;">HenÃ¼z oluÅŸturulmuÅŸ vardiya talebin yok.</p>'}}async function submitShiftRequest(e){e&&e.preventDefault();const t=document.getElementById("shift-req-date").value,a=document.getElementById("shift-req-type").value,n=document.getElementById("shift-req-current").value,i=document.getElementById("shift-req-requested").value,l=document.getElementById("shift-req-friend").value,r=document.getElementById("shift-req-friend-shift").value,s=document.getElementById("shift-req-note").value;if(t&&i)try{await apiCall("submitShiftRequest",{date:t,type:a,current:n,requested:i,friend:l,friendShift:r,note:s,week:document.getElementById("shift-week-label")?document.getElementById("shift-week-label").textContent:""});Swal.fire({icon:"success",title:"Kaydedildi",text:"Vardiya talebin kaydedildi.",timer:1500,showConfirmButton:!1});const e=document.getElementById("shift-request-form");e&&e.reset(),await loadShiftData()}catch(e){console.error(e),Swal.fire("Hata",e.message||"Talep kaydedilemedi.","error")}else Swal.fire("UyarÄ±","Tarih ve talep edilen vardiya alanlarÄ± zorunludur.","warning")}const TECH_DOC_CONTENT={broadcast:[{title:"Smart TV â€“ CanlÄ± YayÄ±nda Donma Problemi YaÅŸÄ±yorum",body:"MÃ¼ÅŸterinin sorun yaÅŸadÄ±ÄŸÄ± yayÄ±n ya da yayÄ±nlarda genel bir sorun var mÄ± kontrol edilir? Genel bir sorun var ise teknik ekibin incelediÄŸi yÃ¶nÃ¼nde bilgi verilir.\nMÃ¼ÅŸterinin kullandÄ±ÄŸÄ± cihaz TVmanager â€˜da loglardan kontrol edilir. ArÃ§elik/Beko/Grundig/Altus marka Android TV olmayan Smart TVâ€™lerden ise genel sorun hakkÄ±nda bilgi verilir.\nYukarÄ±daki durumlar dÄ±ÅŸÄ±nda yaÅŸanan bir sorun ise TV ve modemin elektrik baÄŸlantÄ±sÄ±nÄ± kesilip tekrar verilmesi istenir. Â« YaÅŸadÄ±ÄŸÄ±nÄ±z sorunu kontrol ederken TV ve modeminizin elektrik baÄŸlantÄ±sÄ±nÄ± kesip 10 sn sonra yeniden aÃ§abilir misiniz? ArdÄ±ndan yeniden yayÄ±nÄ± aÃ§Ä±p kontrol edebilir misiniz? (AyrÄ±ca Ã¶neri olarak modemi kapatÄ±p tekrar aÃ§tÄ±ktan sonra, sadece izleme yaptÄ±ÄŸÄ± cihaz modeme baÄŸlÄ± olursa daha iyi bir baÄŸlantÄ± olacaÄŸÄ± bilgisi verilebilir)\nSorun devam eder ise Smart TV tarayÄ±cÄ±sÄ±ndan https://www.hiztesti.com.tr/ bir hÄ±z testi yapmasÄ± sonucu bizimle paylaÅŸmasÄ± istenir.\nHÄ±z testi sonucu 8 Mbps altÄ±nda ise internet baÄŸlantÄ± hÄ±zÄ±nÄ±n dÃ¼ÅŸÃ¼k olduÄŸunu internet servis saÄŸlayÄ±cÄ±sÄ± iletiÅŸime geÃ§mesi istenir.\n8 Mbps Ã¼zerinde ise mÃ¼ÅŸteriden sorunu gÃ¶steren kÄ±sa bir video talep edilir.\nVideo kaydÄ± ve hÄ±z testinin sonuÃ§larÄ± gÃ¶steren bilgiler alÄ±ndÄ±ktan sonra mÃ¼ÅŸteriye incelenmesi iÃ§in teknik ekibimize iletildiÄŸi inceleme tamamlandÄ±ÄŸÄ±nda eposta ile bilgi verileceÄŸi yÃ¶nÃ¼nde bilgi verilir.\nSorun aynÄ± gÃ¼n iÃ§inde benzer cihazlarda farklÄ± mÃ¼ÅŸterilerde yaÅŸÄ±yor ise tÃ¼m bilgilerle Erlabâ€™a arÄ±za kaydÄ± aÃ§Ä±lÄ±r. Sorun birkaÃ§ mÃ¼ÅŸteri ile sÄ±nÄ±rlÄ± ise 17:00 â€“ 01:00 vardiyasÄ±ndaki ekip arkadaÅŸÄ±nda sistemsel bir sorun olmadÄ±ÄŸÄ±na dair eposta gÃ¶nderilmesi iÃ§in bilgileri paylaÅŸÄ±lÄ±r."},{title:"Mobil Uygulama â€“ CanlÄ± YayÄ±nda Donma Sorunu YaÅŸÄ±yorum",body:"MÃ¼ÅŸterinin sorun yaÅŸadÄ±ÄŸÄ± yayÄ±n ya da yayÄ±nlarda genel bir sorun var mÄ± kontrol edilir? Genel bir sorun var ise teknik ekibin incelediÄŸi yÃ¶nÃ¼nde bilgi verilir.(MÃ¼ÅŸteri Ä°OS veya Android iÅŸletim sistemli hangi cihazdan izliyorsa, mÃ¼mkÃ¼nse aynÄ± iÅŸletim sistemli mobil cihazdan kontrol edilebilir, gerekirse ekip arkadaÅŸlarÄ±ndan kontrol etmeleri istenebilir)\nGenel bir sorun yok ise, www.hiztesti.com.tr link Ã¼zerinden hÄ±z testi yapmasÄ± sonucu bizimle paylaÅŸmasÄ± istenir.\nHÄ±z testi sonucu 8 mbps altÄ±nda ise internet baÄŸlantÄ± hÄ±zÄ±nÄ±n dÃ¼ÅŸÃ¼k olduÄŸu internet servisi saÄŸlayÄ±cÄ±sÄ± ile iletiÅŸime geÃ§mesi istenir. (Ã–neri olarak modemi kapatÄ±p tekrar aÃ§tÄ±ktan sonra sadece izleme yaptÄ±ÄŸÄ± cihaz modeme baÄŸlÄ± olursa daha iyi bir baÄŸlantÄ± olacaÄŸÄ± bilgisi verilebilir)\n8 mbps Ã¼zerinde ise, uygulama verilerin temizlenmesi veya uygulamanÄ±n silip tekrar yÃ¼klenmesi istenilir, sorun devam etmesi durumunda sorunu gÃ¶steren video kaydÄ± istenir.\n 4. HÄ±z testi, cihaz marka model ve sÃ¼rÃ¼m bilgileri alÄ±ndÄ±ktan sonra, incelenmesi iÃ§in teknik ekibe iletildiÄŸi, inceleme tamamlandÄ±ÄŸÄ±nda e-posta  ile bilgi verileceÄŸi yÃ¶nÃ¼nde bilgi verilir.\n 5. Sorun aynÄ± gÃ¼n iÃ§erinde benzer cihazlarda farklÄ± mÃ¼ÅŸterilerde yaÅŸÄ±yor ise tÃ¼m bilgilerle Erlabâ€™a arÄ±za kaydÄ± aÃ§Ä±lÄ±r. Sorun birkaÃ§ mÃ¼ÅŸteri ile sÄ±nÄ±rlÄ±  ise 17:00 â€“ 01:00 vardiyasÄ±ndaki ekip arkadaÅŸÄ±nda sistemsel bir sorun olmadÄ±ÄŸÄ±na dair eposta gÃ¶nderilmesi iÃ§in bilgileri paylaÅŸÄ±lÄ±r."},{title:"Bilgisayar â€“ CanlÄ± YayÄ±nda Donma Sorunu YaÅŸÄ±yorum",body:"MÃ¼ÅŸterinin sorun yaÅŸadÄ±ÄŸÄ± yayÄ±n ya da yayÄ±nlarda genel bir sorun var mÄ± kontrol edilir? Genel bir sorun var ise teknik ekibin incelediÄŸi yÃ¶nÃ¼nde bilgi verilir.\nGenel bir sorun deÄŸilse, Ã¶ncelikle https://www.hiztesti.com.tr/ bir hÄ±z testi yapmasÄ± sonucu bizimle paylaÅŸmasÄ± istenir.\nHÄ±z testi sonucu 8 mbps altÄ±nda ise internet baÄŸlantÄ± hÄ±zÄ±nÄ±n dÃ¼ÅŸÃ¼k olduÄŸunu internet servis saÄŸlayÄ±cÄ±sÄ± iletiÅŸime geÃ§mesi istenir.\n8 mbps Ã¼zerinde ise mÃ¼ÅŸteriden aÅŸaÄŸÄ±daki adÄ±mlarÄ± uygulamasÄ± istenir.\n3. BilgisayarÄ±n iÅŸletim sitemi Ã¶ÄŸrenilip, gÃ¶rÃ¼ÅŸme Ã¼zerinden â€˜â€™pingWindows7â€™â€™ veya â€˜â€™pingwindows10â€™â€™ kÄ±sayollarÄ±ndan mÃ¼ÅŸteri sunucularÄ± kontrol edilir.\n(Windows 10 Ã¼zeri iÅŸletim sistemi cihazlara pingwindows10 kÄ±sayolu gÃ¶nderilebilir.)\n4. Sunucu kontrol ekranÄ±nda kontrol edilmesi gereken, ok ile gÃ¶sterilen yerden, sunucu ile kayÄ±p olup olmadÄ±ÄŸÄ± ve kÄ±rmÄ±zÄ± alan iÃ§erisinde sunucu ile web sitemize kaÃ§ saniyede iÅŸlem saÄŸladÄ±ÄŸÄ± kontrol edilir.\n5. 1 â€“ 35 arasÄ± normal sayÄ±labilir, bu saniye aralÄ±ÄŸÄ±nda sorun yaÅŸanÄ±yorsa, web sitemize daha hÄ±zlÄ± tepsi sÃ¼resi veren ve genellikle sorunsuz bir ÅŸekilde izleme saÄŸlanabilen 193.192.103.249, 185.11.14.27 veya 195.175.178.8 sunucularÄ± kontrol edilmelidir.\n6. Uygun sunucuyu tespit ettikten sonra canlÄ± destek ekranÄ±nda â€˜â€™Hostâ€™â€™ â€˜â€™host2â€™â€™ kÄ±sa yollarÄ± kullanarak, kÄ±sa yoldaki adÄ±mlar ile mÃ¼ÅŸterinin sadece bizim sitemize baÄŸlandÄ±ÄŸÄ± sunucusunu, en uygun sunucu ile deÄŸiÅŸtirip tarayÄ±cÄ± aÃ§Ä±p kapattÄ±rdÄ±ktan sonra tekrar yayÄ±nÄ± kontrol etmesini iletebiliriz. (AyrÄ±ca mÃ¼ÅŸteri yayÄ±nlarÄ± auto deÄŸil, manuel olarak 720 veya 1080p seÃ§ip kontrol edilmesi Ã¶nerilir)\n7. Sorun aynÄ± gÃ¼n iÃ§erinde benzer iÅŸletim sistemi veya sunucuda farklÄ± mÃ¼ÅŸterilerde yaÅŸÄ±yor ise tÃ¼m bilgilerle Erlabâ€™a arÄ±za kaydÄ± aÃ§Ä±lÄ±r. Sorun birkaÃ§ mÃ¼ÅŸteri ile sÄ±nÄ±rlÄ± ise 17:00 â€“ 01:00 vardiyasÄ±ndaki ekip arkadaÅŸÄ±nda sistemsel bir sorun olmadÄ±ÄŸÄ±na dair eposta gÃ¶nderilmesi iÃ§in bilgileri paylaÅŸÄ±lÄ±r"},{title:"YAYIN SORUNLARI",body:"35 sn arasÄ± normal sayÄ±labilir, bu saniye aralÄ±ÄŸÄ±nda sorun yaÅŸanÄ±yorsa, web sitemize daha hÄ±zlÄ± tepsi sÃ¼resi veren ve genellikle sorunsuz bir ÅŸekilde izleme saÄŸlanabilen 193.192.103.249, 185.11.14.27 veya 195.175.178.8 sunucularÄ± kontrol edilmelidir."},{title:"MacOS â€“ CanlÄ± YayÄ±nda Donma Sorunu YaÅŸÄ±yorum",body:"MÃ¼ÅŸterinin sorun yaÅŸadÄ±ÄŸÄ± yayÄ±n ya da yayÄ±nlarda genel bir sorun var mÄ± kontrol edilir? Genel bir sorun var ise teknik ekibin incelediÄŸi yÃ¶nÃ¼nde bilgi verilir.\nGenel bir sorun deÄŸilse, Ã¶ncelikle https://www.hiztesti.com.tr/ bir hÄ±z testi yapmasÄ± sonucu bizimle paylaÅŸmasÄ± istenir.\nHÄ±z testi sonucu 8 mbps altÄ±nda ise internet baÄŸlantÄ± hÄ±zÄ±nÄ±n dÃ¼ÅŸÃ¼k olduÄŸunu internet servis saÄŸlayÄ±cÄ±sÄ± iletiÅŸime geÃ§mesi istenir.\n8 mbps Ã¼zerinde ise mÃ¼ÅŸteriden aÅŸaÄŸÄ±daki adÄ±mlarÄ± uygulamasÄ± istenir.\nMindbehind Ã¼zerinden â€˜â€™pingmacOSâ€™â€™ kÄ±sayolundan mÃ¼ÅŸteri sunucularÄ± kontrol edilir.\nSunucu kontrol ekranÄ±nda kontrol edilmesi gereken, â€˜â€™packet lossâ€™â€™ kÄ±smÄ±nda kayÄ±p olup olmadÄ±ÄŸÄ±,  alan iÃ§erisinde sunucu ile web sitemize kaÃ§ saniyede iÅŸlem saÄŸladÄ±ÄŸÄ± kontrol edilir.\n1 â€“ 35 arasÄ± normal sayÄ±labilir, bu saniye aralÄ±ÄŸÄ±nda sorun yaÅŸanÄ±yorsa, web sitemize daha hÄ±zlÄ± tepsi sÃ¼resi veren ve genellikle sorunsuz bir ÅŸekilde izleme saÄŸlanabilen 193.192.103.249, 185.11.14.27 veya 195.175.178.8 sunucularÄ± kontrol edilmelidir.\nUygun sunucuyu tespit ettikten sonra canlÄ± destek ekranÄ±nda â€˜â€™macOShostâ€™â€™ kÄ±sa yolunu kullanarak, kÄ±sa yoldaki adÄ±mlar ile mÃ¼ÅŸterinin sadece bizim sitemize baÄŸlandÄ±ÄŸÄ± sunucuyu, en uygun sunucu ile deÄŸiÅŸtirip tarayÄ±cÄ± aÃ§Ä±p kapattÄ±rdÄ±ktan sonra tekrar yayÄ±nÄ± kontrol etmesini iletebiliriz. (AyrÄ±ca mÃ¼ÅŸteri yayÄ±nlarÄ± auto deÄŸil, manuel olarak 720 veya 1080p seÃ§ip kontrol edilmesi Ã¶nerilir)\nSorun aynÄ± gÃ¼n iÃ§erinde benzer iÅŸletim sistemi veya sunucuda farklÄ± mÃ¼ÅŸterilerde yaÅŸÄ±yor ise tÃ¼m bilgilerle Erlabâ€™a arÄ±za kaydÄ± aÃ§Ä±lÄ±r. Sorun birkaÃ§ mÃ¼ÅŸteri ile sÄ±nÄ±rlÄ± ise 17:00 â€“ 01:00 vardiyasÄ±ndaki ekip arkadaÅŸÄ±nda sistemsel bir sorun olmadÄ±ÄŸÄ±na dair eposta gÃ¶nderilmesi iÃ§in bilgileri paylaÅŸÄ±lÄ±r."},{title:"â€˜â€™YayÄ±nda beklenmedik bir kesinti oluÅŸtuâ€™â€™ UyarÄ±sÄ±",body:"Bu uyarÄ± genel bir yayÄ±n sorunu olduÄŸunda ya da kullanÄ±cÄ± TÃ¼rkiye sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda bir yerden eriÅŸim saÄŸladÄ±ÄŸÄ±nda karÅŸÄ±mÄ±za Ã§Ä±kmaktadÄ±r.\nKullanÄ±cÄ±nÄ±n sorun yaÅŸadÄ±ÄŸÄ± yayÄ±n kontrol edilir ve genel bir yayÄ±n sorunu olup olmadÄ±ÄŸÄ± teyit edilir.\nTvmanagerâ€™da SubscriberLog ekranÄ±ndan ip adresi alÄ±nÄ±r ve yurtdÄ±ÅŸÄ± bir konum olup olmadÄ±ÄŸÄ± teyit edilir.\nKullanÄ±cÄ± yurtdÄ±ÅŸÄ±nda ise eriÅŸim saÄŸlayamayacaÄŸÄ± bilgisi verilir, VPN kullanÄ±yor ise kapatmasÄ± istenir.\nTVmanager Devices kÄ±smÄ±nda oturumlar sonlandÄ±rÄ±lÄ±r ve kullanÄ±cÄ±dan tekrar giriÅŸ yaparak kontrol etmesi rica edilir.\nMobil veri veya farklÄ± bir aÄŸda bu hata mesajÄ±nÄ±n alÄ±nÄ±p alÄ±nmadÄ±ÄŸÄ± teyit edilir.\nCihaz ve modem kapama ve aÃ§ma iÅŸlemi uygulanÄ±r.\nSorun devam eder ise inceleme iÃ§in cihaz ve diÄŸer bilgilerle teknik ekibimize bilgi verileceÄŸi iletilir. Excel de kullanÄ±cÄ±dan alÄ±nan bilgiler not edilir."}],access:[{title:"ERÄ°ÅžÄ°M SORUNLARI",body:"â€˜â€™Lisans haklarÄ± sebebiyle TÃ¼rkiye sÄ±nÄ±rlarÄ± dÄ±ÅŸÄ±nda hizmet verilememektedir.â€™â€™ UyarÄ±sÄ±\nAlÄ±nan hata mÃ¼ÅŸterinin yurt dÄ±ÅŸÄ±nda olmasÄ± ve yurt iÃ§inde ise VPN ya da benzeri bir uygulamanÄ±n cihazÄ±nda aktif olmasÄ±ndan kaynaklanmaktadÄ±r.\n\nMÃ¼ÅŸteriye yurt dÄ±ÅŸÄ±nda olup olmadÄ±ÄŸÄ± sorulur, yurt dÄ±ÅŸÄ±nda ise â€˜â€™lisans haklarÄ± sebebiyle yayÄ±nlarÄ±n yurt dÄ±ÅŸÄ±ndan izlenemediÄŸiâ€™â€™ yÃ¶nÃ¼nde bilgi verilir.\nYurt iÃ§inde ise VPN ya da benzeri bir uygulamanÄ±n cihazÄ±nda aktif olup ya da olmadÄ±ÄŸÄ± sorulur. Aktif ise devre dÄ±ÅŸÄ± bÄ±rakÄ±lÄ±p tekrar denemesi Ã¶nerilir.\nVPN ya da benzeri bir uygulama kullanmÄ±yor ise mÃ¼ÅŸterinin ip adresi Ã¶ÄŸrenilir ve https://tr.wizcase.com/tools/whats-my-ip/ ip adresi kontrol edilir.  AynÄ± zamanda adresin vpn Ã¼zerinden alÄ±nÄ±p alÄ±nmadÄ±ÄŸÄ±nÄ±n kontrolÃ¼ iÃ§in https://vpnapi.io adresine girilip kontrol edilir.\nIp adresi yurt dÄ±ÅŸÄ± ya da ISP bilgisi bilinen bir servis saÄŸlayÄ±cÄ±sÄ± deÄŸilse mÃ¼ÅŸteriye bulunduÄŸu lokasyonun otel, yurt vb. bir yer olup olmadÄ±ÄŸÄ± ya da cihazÄ±nÄ±n ÅŸirket cihazÄ± olup olmadÄ±ÄŸÄ± sorulur."},{title:"â€˜â€™IP Karantinaâ€™â€™ UyarÄ±sÄ±",body:"Ä°p Karantina sorunu genel bir sorun yok ise, eposta veya ÅŸifre bir Ã§ok defa hatalÄ± girilmesinden dolayÄ± alÄ±nÄ±r.\nKullanÄ±cÄ±nÄ±n ip adresi karantina da olup ya da olmadÄ±ÄŸÄ±, TVmanager â€“ CMS â€“ Admission Gate menÃ¼sÃ¼ Ã¼zerinden kontrol edilerek Ã§Ä±karÄ±labilir. Ä°kinci bir seÃ§enek olarak modem kapama ve aÃ§ma iÅŸlemi yaptÄ±rÄ±labilir."}],app:[{title:"Teknik Sorun Analizi NasÄ±l YapÄ±lÄ±r?",body:"App KaynaklÄ± Nedenler\nCihaz KaynaklÄ± Nedenler\nApp hatalarÄ± baÅŸlÄ±ÄŸÄ±nda uygulamanÄ±n aÃ§Ä±lmamasÄ± ya da kendi kendine kapanmasÄ± ÅŸeklinde teknik sorunlar ile karÅŸÄ±laÅŸabiliriz. Bu tip sorunlar, kullanÄ±cÄ± deneyimini doÄŸrudan etkileyerek uygulamaya eriÅŸilememesine neden olur.\nUygulamanÄ±n eski sÃ¼rÃ¼mÃ¼\nÃ–nbellek sorunlarÄ±\nUyumsuz cihazlar\nDolu RAM/Arka planda Ã§alÄ±ÅŸan fazla uygulama\nCihazÄ±n gÃ¼ncel olmamasÄ± (Eski sistemi sÃ¼rÃ¼mleri)\nKullanÄ±cÄ±ya Sorulabilecek Sorular:\nUygulama aÃ§Ä±lÄ±yor mu, yoksa aÃ§Ä±lmadan kapanÄ±yor mu?\nUygulama sÃ¼rÃ¼mÃ¼, cihaz iÅŸletim sistemi sÃ¼rÃ¼mÃ¼ nedir? (TVmanager kontrolÃ¼)\nCihazda yeterli depolama alanÄ± var mÄ±?"}],activation:[{title:"â€˜â€™Promosyon Kodu BulunamadÄ±â€™â€™ UyarÄ±sÄ±",body:"GÃ¶rselde ki Ã¶rnekte doÄŸrusu â€˜â€™YILLIKLOCAâ€™â€™ olan kampanya kodu, kÃ¼Ã§Ã¼k harf ile yazÄ±ldÄ±ÄŸÄ±nda â€˜â€™Promosyon Kodu BulunamadÄ±â€™â€™ hatasÄ± alÄ±nmÄ±ÅŸtÄ±r. Bu hata ile karÅŸÄ±laÅŸÄ±ldÄ±ÄŸÄ±nda kampanya kodunun yanlÄ±ÅŸ, eksik, kÃ¼Ã§Ã¼k harf ya da boÅŸluk bÄ±rakÄ±larak yazÄ±ldÄ±ÄŸÄ±nÄ± tespitle, kullanÄ±cÄ±yÄ± bu doÄŸrultuda doÄŸru yazÄ±m iÃ§in yÃ¶nlendirmemiz gerekir."},{title:"â€˜â€™Kampanya Kodu Aktif Edilemediâ€™â€™ UyarÄ±sÄ±",body:"GÃ¶rseldeki Ã¶rnekteki gibi eski bir promosyon kodu yazÄ±ldÄ±ÄŸÄ±nda â€˜â€™Kampanya Kodu Aktif Edilemediâ€™â€™ uyarÄ±sÄ± alÄ±nÄ±r."},{title:"â€˜â€™GeÃ§ersiz Kampanya Koduâ€™â€™ UyarÄ±sÄ±",body:"GÃ¶rseldeki Ã¶rnekteki gibi daha Ã¶nce kullanÄ±lmÄ±ÅŸ bir promosyon kodu yazÄ±ldÄ±ÄŸÄ±nda â€˜â€™GeÃ§ersiz Kampanya Koduâ€™â€™ hatasÄ± alÄ±nÄ±r.\nPromosyon kodunun hangi hesapta kullanÄ±ldÄ±ÄŸÄ±nÄ± aÅŸaÄŸÄ±daki gÃ¶rseldeki gibi Campaign alanÄ±nda arama yaparak gÃ¶rÃ¼ntÃ¼leyebiliriz."},{title:"Playstore Uygulama Aktivasyon Sorunu",body:"BazÄ± durumlarda, kullanÄ±cÄ±lar Google Play Store Ã¼zerinden S Sport Plus uygulamasÄ±nda abonelik satÄ±n aldÄ±klarÄ±nda veya yenileme gerÃ§ekleÅŸtiÄŸinde, Ã¼yelikleri otomatik olarak aktifleÅŸmeyebiliyor.  Bu durumda, kullanÄ±cÄ±nÄ±n uygulama Ã¼zerinden manuel olarak paket aktivasyonu yapmasÄ± gerekmektedir.\n\nAktivasyon iÅŸleminin baÅŸarÄ±lÄ± olabilmesi iÃ§in:\n Google Play Store Ã¼zerinden satÄ±n alma iÅŸlemi yapÄ±lÄ±rken kullanÄ±lan Gmail hesabÄ±, aktivasyon anÄ±nda cihazda aÃ§Ä±k olmalÄ±dÄ±r.\n Aktivasyon iÅŸlemi uygulama iÃ§erisinden yapÄ±lmalÄ±dÄ±r.\nDestek ekibi tarafÄ±ndan Mindbehind Ã¼zerinden â€œpaketgoogleâ€ kÄ±sayolu kullanÄ±larak yÃ¶nlendirme saÄŸlanabilir.  KullanÄ±cÄ± baÅŸarÄ±lÄ± bir ÅŸekilde paket aktivasyonu yaptÄ±ktan sonra, paket atamasÄ± sistemde gerÃ§ekleÅŸir ve log kayÄ±tlarÄ±nda ilgili iÅŸlem aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nÃ¼r (ekli gÃ¶rsellerdeki gibi).  Bu iÅŸlem, paketin doÄŸru ÅŸekilde tanÄ±mlanmasÄ± iÃ§in Ã¶nemlidir."},{title:"App Store Uygulama Aktivasyon Sorunu",body:"MÃ¼ÅŸteriler App Store Ã¼zerinden uygulamamÄ±zdan abonelik satÄ±n aldÄ±ÄŸÄ± veya yenileme olduÄŸu zaman bazen Ã¼yelik aktif olmuyor.\nÃœyelikleri aktif olabilmeleri iÃ§in, uygulama Ã¼zerinden paket aktivasyon yapmalarÄ± gerekiyor. Paket aktivasyon yaparken, satÄ±n alma yaparken hangi Apple kimliÄŸi hesabÄ± aÃ§Ä±k ise, o hesap aÃ§Ä±kken aktivasyon denemesi gerekiyor.\nMindbehind Ã¼zerinden â€˜â€™paketappleâ€™â€™ kÄ±sayolu kullanÄ±lÄ±r.\nMÃ¼ÅŸteri paket aktivasyonu yaptÄ±ktan sonra Ã¼yelik atamasÄ± ve loglarda nasÄ±l gÃ¶zÃ¼ktÃ¼ÄŸÃ¼ gÃ¶rsellerdeki gibidir.\nPaket aktivasyon butonu Ã¶rnek gÃ¶rÃ¼ntÃ¼sÃ¼ yandaki gibidir."},{title:"AKTÄ°VASYON SORUNLARI",body:"Ä°OS Uygulama Paket Aktivasyon â€˜â€™Abonelik BaÅŸkasÄ±na Aittirâ€™â€™ Sorunu\n\nÄ°os uygulamamÄ±zda mÃ¼ÅŸteri paket aktivasyon iÅŸlemi yaptÄ±ÄŸÄ±nda â€˜â€™Abonelik BaÅŸkasÄ±na Aittirâ€™â€™ hatasÄ± geliyor ise, cihazda aÃ§Ä±k olan Apple kimliÄŸi ile satÄ±n alÄ±nmÄ±ÅŸ, ancak aktivasyon yaptÄ±ÄŸÄ± eposta adresi farklÄ± bir eposta adresidir.\n\nFarklÄ± eposta adresi ile paket aktivasyon yaptÄ±ÄŸÄ±nda â€˜â€™Subscriberlogâ€™â€™ kÄ±smÄ±nda Ã¶rnek ekran gÃ¶rÃ¼ntÃ¼sÃ¼nde kÄ±rmÄ±zÄ± alana alÄ±nan â€˜â€™packageValidationâ€™â€™  kÄ±smÄ± Ã§Ä±kar, ok ile gÃ¶sterilen ID kÄ±smÄ±ndan doÄŸru Ã¼yeliÄŸi ID aramasÄ± ile bulabiliriz."},{title:"AKTÄ°VASYON SORUNLARI",body:"Android â€˜â€™Paket BaÅŸka Bir KullanÄ±cÄ±ya Ait OlduÄŸu Ä°Ã§in Paket Atama Ä°ÅŸlemi BaÅŸarÄ±sÄ±z Olduâ€™â€™ Sorunu\n\nAndroid uygulamamÄ±zda mÃ¼ÅŸteri paket aktivasyon iÅŸlemi yaptÄ±ÄŸÄ±nda â€˜â€™Paket BaÅŸka Bir KullanÄ±cÄ±ya Ait OlduÄŸu Ä°Ã§in Paket Atama Ä°ÅŸlemi BaÅŸarÄ±sÄ±z Olduâ€™â€™ hatasÄ± geliyor ise, cihazda aÃ§Ä±k olan Play Store gmail hesabÄ± ile satÄ±n alÄ±nmÄ±ÅŸ, ancak aktivasyon yaptÄ±ÄŸÄ± eposta adresi farklÄ± bir eposta adresidir.\n\nFarklÄ± eposta adresi ile paket aktivasyon yaptÄ±ÄŸÄ±nda â€˜â€™Subscriberlogâ€™â€™ kÄ±smÄ±nda Ã¶rnek ekran gÃ¶rÃ¼ntÃ¼sÃ¼nde kÄ±rmÄ±zÄ± alana alÄ±nan â€˜â€™Validate Google Packageâ€™â€™  kÄ±smÄ± Ã§Ä±kar, ok ile gÃ¶sterilen ID kÄ±smÄ±ndan doÄŸru Ã¼yeliÄŸi ID aramasÄ± ile bulabiliriz."},{title:"AKTÄ°VASYON SORUNLARI",body:"Android Uygulama Paket Aktivasyon Ä°ÅŸlem TamamlanamadÄ± veya Ãœyelik Bulunamama Sorunu\nAndroid uygulamamÄ±zda mÃ¼ÅŸteri Ã¶deme yapmÄ±ÅŸ olmasÄ±na raÄŸmen paket aktivasyonu yaptÄ±ÄŸÄ±nda â€˜â€™Ä°ÅŸlem tamamlandÄ±, Ä°ÅŸlem TamamlanamadÄ± veya Abone bulunamadÄ±â€™â€™ hatasÄ± geliyor ve Ã¼yelik aktif olmuyor ise, mÃ¼ÅŸteriden GPA kodunu paylaÅŸÄ±lmasÄ± istenir.\nGPA kodu, Google tarafÄ±ndan Ã¶deme yapÄ±ldÄ±ÄŸÄ±na dair mÃ¼ÅŸteriye gÃ¶nderilen Ã¶deme faturasÄ± (makbuz) iÃ§erisinde yer almaktadÄ±r.\nBu GPA kodu ile Ã¼yeliÄŸi Tvmanager Ã¼zerinden aÅŸaÄŸÄ±daki gÃ¶rseldeki gibi Reporting > General > Payments kÄ±smÄ±nda tarihi aralÄ±ÄŸÄ± ayarlanÄ±p â€˜â€™Transaction Identiferâ€™â€™ kÄ±smÄ±ndan arama yapÄ±lÄ±p, Ã¼yelik IDâ€™sine â€˜â€™Subscriber IDâ€™â€™ Ã¼zerinden ulaÅŸÄ±labilir."},{title:"AKTÄ°VASYON SORUNLARI",body:"TÃ¼rksat Abone BulunamadÄ± veya Abone Active DeÄŸil Sorunu\nBu hata, Hizmet ID veya GeÃ§ici Kod hatalÄ± yazÄ±lmasÄ±ndan dolayÄ± alÄ±nÄ±r.  MÃ¼ÅŸteriler genellikle bazÄ± bÃ¼yÃ¼k kÃ¼Ã§Ã¼k harfleri karÄ±ÅŸtÄ±rabiliyor veya sistemden dolayÄ± bazen bu sorun alÄ±nabiliyor.\nÃ‡Ã¶zÃ¼m olarak harf hatasÄ± olmamasÄ± iÃ§in Tvmanager>Reporting>General>Thirtdparty Provisions kÄ±smÄ±ndan tarih aralÄ±ÄŸÄ± belirleyip, Hizmet ID numarasÄ±nÄ± â€˜â€™Extrenal IDâ€™â€™ kÄ±smÄ±ndan aratÄ±p, kullanÄ±cÄ± TÃ¼rksat bilgilerini bulup â€˜â€™UniqueIDâ€™â€™ kÄ±smÄ±ndan geÃ§ici kodu bulup, kullanÄ±cÄ±ya paylaÅŸtÄ±ÄŸÄ±mÄ±zda, ID ve GeÃ§ici kodu kopyala yapÄ±ÅŸtÄ±rÄ±r ÅŸeklinde ilerlemesini iletebiliriz.\nAynÄ± sorun devam eder ise, kullanÄ±cÄ±dan onay alÄ±p, ID ve geÃ§ici kod ile kullanÄ±cÄ±nÄ±n Ã¼yeliÄŸini kendimiz yapabiliriz. MÃ¼ÅŸterinin Ã¼yeliÄŸini biz tarafÄ±ndan yapÄ±ldÄ± ise, mÃ¼ÅŸteriye ÅŸifresini nasÄ±l gÃ¼ncelleyebileceÄŸi ile ilgili bilgi verilir."}]};function renderTechSections(){const e=(database||[]).filter(e=>"teknik"===String(e.category||"").toLowerCase());let t=[];try{t=JSON.parse(localStorage.getItem("techCardsOverride")||"[]")}catch(e){t=[]}const a=Array.isArray(t)&&t.length?t:e,n={broadcast:[],access:[],app:[],activation:[],cards:[]};a.forEach(e=>{const t=`${e.title||""} ${e.text||""} ${e.script||""}`.toLowerCase();t.includes("yayÄ±n")||t.includes("don")||t.includes("buffer")||t.includes("akÄ±ÅŸ")||t.includes("tv")?n.broadcast.push(e):t.includes("eriÅŸim")||t.includes("vpn")||t.includes("proxy")||t.includes("login")||t.includes("giriÅŸ")||t.includes("yurtdÄ±ÅŸÄ±")?n.access.push(e):t.includes("app")||t.includes("uygulama")||t.includes("hata")||t.includes("crash")||t.includes("versiyon")?n.app.push(e):t.includes("aktivasyon")||t.includes("satÄ±n")||t.includes("satÄ±nalma")||t.includes("store")||t.includes("Ã¶deme")||t.includes("google")||t.includes("apple")?n.activation.push(e):n.broadcast.push(e),n.cards.push(e)}),window.__techBuckets=n;const i=(e,t,a)=>{const n=document.getElementById(e);n&&(n.oninput=()=>renderTechList(t,n.value||"",a))};i("x-broadcast-search","broadcast","x-broadcast-list"),i("x-access-search","access","x-access-list"),i("x-app-search","app","x-app-list"),i("x-activation-search","activation","x-activation-list"),i("x-cards-search","cards","x-cards"),renderTechList("broadcast","","x-broadcast-list"),renderTechList("access","","x-access-list"),renderTechList("app","","x-app-list"),renderTechList("activation","","x-activation-list"),renderTechList("cards","","x-cards")}let techEditMode=!1;function renderTechList(e,t,a){const n=document.getElementById(a);if(!n)return;const i=window.__techBuckets&&window.__techBuckets[e]?window.__techBuckets[e]:[],l=String(t||"").trim().toLowerCase(),r=l?i.filter(e=>`${e.title||""} ${e.text||""} ${e.script||""} ${e.link||""}`.toLowerCase().includes(l)):i,s=isAdminMode?`\n        <div style="display:flex;gap:10px;align-items:center;margin:10px 0 14px;">\n          <button class="x-btn x-btn-admin" onclick="toggleTechEdit()"><i class="fas fa-pen"></i> ${techEditMode?"DÃ¼zenlemeyi Kapat":"DÃ¼zenlemeyi AÃ§"}</button>\n          ${techEditMode?`<button class="x-btn x-btn-admin" onclick="addTechCard('${e}')"><i class="fas fa-plus"></i> Kart Ekle</button>`:""}\n          <span style="color:#888;font-weight:800;font-size:.9rem">Bu dÃ¼zenlemeler tarayÄ±cÄ±da saklanÄ±r (local).</span>\n        </div>\n    `:"";r.length?n.innerHTML=s+`\n      <div class="x-card-grid">\n        ${r.map((e,t)=>techCardHtml(e,t)).join("")}\n      </div>\n    `:n.innerHTML=s+'<div class="home-mini-item">KayÄ±t bulunamadÄ±.</div>'}function techCardKey(e,t){return e&&(e.id||e.code)?String(e.id||e.code):`${(e.title||"").slice(0,40)}__${t}`}function techCardHtml(e,t){const a=escapeHtml(e.title||""),n=escapeHtml(e.code||e.category||"TEKNÄ°K"),i=(e.text||"").toString(),l=escapeHtml(i),r=(e.link||"").trim(),s=(e.script||"").trim(),o=techCardKey(e,t),d=i&&i.length>180||s&&s.length>120||!!r;return`\n      <div class="x-card" data-key="${escapeHtml(o)}">\n        <div class="x-card-head">\n          <div class="x-card-title">${a}</div>\n          <div class="x-card-badge">${n}</div>\n        </div>\n        <div class="x-card-body">\n          ${l?`<div class="x-card-text x-card-text-truncate">${l}</div>`:""}\n          ${d?`<button class="x-readmore" onclick='openTechCardDetail(${JSON.stringify(o)})'>Devam oku</button>`:""}\n        </div>\n        <div class="x-card-actions">\n          ${s?`<button class="x-btn x-btn-copy" onclick='copyText(${JSON.stringify(s)})'><i class="fas fa-copy"></i> Kopyala</button>`:""}\n          ${isAdminMode&&techEditMode?`\n            <button class="x-btn x-btn-admin" onclick="editTechCard(${JSON.stringify(o)})"><i class="fas fa-pen"></i> DÃ¼zenle</button>\n            <button class="x-btn x-btn-admin" onclick="deleteTechCard(${JSON.stringify(o)})"><i class="fas fa-trash"></i> Sil</button>\n          `:""}\n        </div>\n      </div>\n    `}function openTechCardDetail(e){try{const t=__getTechCardsForUi();let a=null;if(String(e||"").startsWith("idx:")){const n=parseInt(String(e).split(":")[1],10);Number.isNaN(n)||(a=t[n])}else a=t.find((t,a)=>techCardKey(t,a)===e)||null;if(!a)return void Swal.fire({icon:"warning",title:"KayÄ±t bulunamadÄ±",timer:1200,showConfirmButton:!1});showCardDetail({title:a.title||"Detay",text:a.text||"",script:a.script||"",alert:a.alert||"",link:a.link||""})}catch(e){Swal.fire("Hata","Detay aÃ§Ä±lamadÄ±.","error")}}function toggleTechEdit(){techEditMode=!techEditMode;try{filterTechCards()}catch(e){}}function getTechOverride(){try{const e=JSON.parse(localStorage.getItem("techCardsOverride")||"[]");if(Array.isArray(e))return e}catch(e){}return[]}function saveTechOverride(e){storage.set("techCardsOverride",e||[])}function addTechCard(e){Swal.fire({title:"Teknik Kart Ekle",html:'\n          <input id="tc-title" class="swal2-input" placeholder="BaÅŸlÄ±k">\n          <input id="tc-badge" class="swal2-input" placeholder="Etiket (Ã¶r: TEKNÄ°K)">\n          <input id="tc-link" class="swal2-input" placeholder="Link (opsiyonel)">\n          <textarea id="tc-text" class="swal2-textarea" placeholder="AÃ§Ä±klama"></textarea>\n          <textarea id="tc-script" class="swal2-textarea" placeholder="Script (opsiyonel)"></textarea>\n        ',showCancelButton:!0,confirmButtonText:"Ekle",cancelButtonText:"VazgeÃ§",preConfirm:()=>{const e=(document.getElementById("tc-title").value||"").trim();return e?{id:"local_"+Date.now(),title:e,code:(document.getElementById("tc-badge").value||"TEKNÄ°K").trim(),link:(document.getElementById("tc-link").value||"").trim(),text:(document.getElementById("tc-text").value||"").trim(),script:(document.getElementById("tc-script").value||"").trim(),category:"teknik"}:Swal.showValidationMessage("BaÅŸlÄ±k zorunlu")}}).then(e=>{if(!e.isConfirmed)return;const t=getTechOverride(),a=(database||[]).filter(e=>"teknik"===String(e.category||"").toLowerCase()),n=t.length?t:a;n.unshift(e.value),saveTechOverride(n);try{filterTechCards()}catch(e){}})}function editTechCard(e){const t=getTechOverride(),a=(database||[]).filter(e=>"teknik"===String(e.category||"").toLowerCase()),n=t.length?t:a,i=n.findIndex((t,a)=>techCardKey(t,a)===e);if(i<0)return;const l=n[i]||{};Swal.fire({title:"KartÄ± DÃ¼zenle",html:`\n          <input id="tc-title" class="swal2-input" placeholder="BaÅŸlÄ±k" value="${escapeHtml(l.title||"")}">\n          <input id="tc-badge" class="swal2-input" placeholder="Etiket" value="${escapeHtml(l.code||l.category||"TEKNÄ°K")}">\n          <input id="tc-link" class="swal2-input" placeholder="Link" value="${escapeHtml(l.link||"")}">\n          <textarea id="tc-text" class="swal2-textarea" placeholder="AÃ§Ä±klama">${escapeHtml(l.text||"")}</textarea>\n          <textarea id="tc-script" class="swal2-textarea" placeholder="Script">${escapeHtml(l.script||"")}</textarea>\n        `,showCancelButton:!0,confirmButtonText:"Kaydet",cancelButtonText:"VazgeÃ§",preConfirm:()=>{const e=(document.getElementById("tc-title").value||"").trim();return e?{...l,title:e,code:(document.getElementById("tc-badge").value||"TEKNÄ°K").trim(),link:(document.getElementById("tc-link").value||"").trim(),text:(document.getElementById("tc-text").value||"").trim(),script:(document.getElementById("tc-script").value||"").trim(),category:"teknik"}:Swal.showValidationMessage("BaÅŸlÄ±k zorunlu")}}).then(e=>{if(e.isConfirmed){n[i]=e.value,saveTechOverride(n);try{filterTechCards()}catch(e){}}})}function deleteTechCard(e){Swal.fire({title:"Silinsin mi?",text:"Bu kart local veriden silinecek.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sil",cancelButtonText:"VazgeÃ§"}).then(t=>{if(!t.isConfirmed)return;const a=getTechOverride(),n=(database||[]).filter(e=>"teknik"===String(e.category||"").toLowerCase());saveTechOverride((a.length?a:n).filter((t,a)=>techCardKey(t,a)!==e));try{filterTechCards()}catch(e){}})}function renderTechList(e,t,a=!1){const n=document.getElementById(e);n&&(t&&0!==t.length?n.innerHTML=t.map(e=>`\n      <div class="news-item" style="cursor:pointer" onclick="showCardDetail(${JSON.stringify(e).replace(/</g,"<")})">\n        <span class="news-title">${escapeHtml(e.title||"")}</span>\n        ${a?`<span class="news-tag" style="background:#eef2ff;color:#2b3a8a;border:1px solid #dde3ff">${escapeHtml(e.category||"")}</span>`:""}\n        <div class="news-desc" style="white-space:pre-line">${escapeHtml(e.text||"")}</div>\n        ${e.script?`<div class="script-box" style="margin-top:10px"><b>Script:</b><div style="margin-top:6px;white-space:pre-line">${escapeHtml(e.script||"")}</div><div style="text-align:right;margin-top:10px"><button class="btn btn-copy" onclick="event.stopPropagation(); copyText('${escapeForJsString(e.script||"")}')">Kopyala</button></div></div>`:""}\n      </div>\n    `).join(""):n.innerHTML='<div style="padding:16px;opacity:.7">Bu baÅŸlÄ±k altÄ±nda iÃ§erik yok.</div>')}function renderTechDocs(){const e={broadcast:"x-broadcast-docs",access:"x-access-docs",app:"x-app-docs",activation:"x-activation-docs"};Object.keys(e).forEach(t=>{const a=document.getElementById(e[t]);if(a)try{const e=TECH_DOC_CONTENT&&TECH_DOC_CONTENT[t]?TECH_DOC_CONTENT[t]:[];if(!Array.isArray(e)||0===e.length)return void(a.innerHTML='<div style="padding:12px 2px;opacity:.7">Bu baÅŸlÄ±k altÄ±nda teknik dÃ¶kÃ¼man bulunamadÄ±.</div>');a.innerHTML=e.map((e,t)=>`\n                <div class="doc-card">\n                  <button type="button" class="doc-head" onclick="toggleDocAccordion(this)">\n                    <span class="doc-title">${escapeHtml(e.title||"Ä°Ã§erik "+(t+1))}</span>\n                    <i class="fas fa-chevron-down"></i>\n                  </button>\n                  <div class="doc-body" style="display:none; white-space:pre-line">${escapeHtml(e.body||"")}</div>\n                </div>\n            `).join("")}catch(e){console.error("renderTechDocs error",e),a.innerHTML='<div style="padding:12px 2px;opacity:.7">DÃ¶kÃ¼manlar yÃ¼klenemedi. (Konsolu kontrol edin)</div>'}})}function toggleDocAccordion(e){try{const t=e.closest(".doc-card");if(!t)return;const a=t.querySelector(".doc-body");if(!a)return;const n="none"!==a.style.display;a.style.display=n?"none":"block",t.classList.toggle("open",!n)}catch(e){}}function renderTechWizardInto(e){const t=document.getElementById(e);if(t){if(window.embeddedTwState=window.embeddedTwState||{currentStep:"start",history:[]},!techWizardData||0===Object.keys(techWizardData).length)return t.innerHTML='<div style="padding:16px;opacity:.7">Sihirbaz yÃ¼kleniyor...</div>',void loadTechWizardData().then(()=>renderTechWizardInto(e));embeddedTwRender(e)}}function embeddedTwRender(e){const t=document.getElementById(e);if(!t)return;const a=window.embeddedTwState||{currentStep:"start",history:[]},n=techWizardData[a.currentStep];if(!n)return void(t.innerHTML=`<div class="tech-alert">Hata: AdÄ±m bulunamadÄ± (${escapeHtml(String(a.currentStep))}).</div>`);let i=`\n      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap">\n        <div style="display:flex; gap:8px; align-items:center">\n          ${a.history&&a.history.length>0?`<button type="button" class="tech-btn tech-btn-option" onclick="embeddedTwBack('${e}')">â¬… Geri</button>`:""}\n          <button type="button" class="tech-btn tech-btn-option" onclick="embeddedTwReset('${e}')">â†» SÄ±fÄ±rla</button>\n        </div>\n        <div style="opacity:.7; font-size:.9rem">AdÄ±m: ${escapeHtml(n.title||"")}</div>\n      </div>\n\n      <div class="tech-step-title">${escapeHtml(n.title||"")}</div>\n    `;n.text&&(i+=`<div style="font-size:1rem; margin:10px 0; white-space:pre-line">${escapeHtml(n.text)}</div>`),n.script&&(i+=`<div class="tech-script-box"><span class="tech-script-label">MÃ¼ÅŸteriye iletilecek:</span>${escapeHtml(n.script)}</div>`),n.alert&&(i+=`<div class="tech-alert">${escapeHtml(n.alert)}</div>`),Array.isArray(n.buttons)&&n.buttons.length&&(i+='<div class="tech-buttons-area">',n.buttons.forEach(t=>{const a="option"===t.style?"tech-btn-option":"tech-btn-primary";i+=`<button type="button" class="tech-btn ${a}" onclick="embeddedTwChangeStep('${e}','${escapeForJsString(t.next||"start")}')">${escapeHtml(t.text||"")}</button>`}),i+="</div>"),t.innerHTML=i}function embeddedTwChangeStep(e,t){window.embeddedTwState=window.embeddedTwState||{currentStep:"start",history:[]},window.embeddedTwState.history.push(window.embeddedTwState.currentStep),window.embeddedTwState.currentStep=t,embeddedTwRender(e)}function embeddedTwBack(e){window.embeddedTwState=window.embeddedTwState||{currentStep:"start",history:[]},window.embeddedTwState.history.length&&(window.embeddedTwState.currentStep=window.embeddedTwState.history.pop(),embeddedTwRender(e))}function embeddedTwReset(e){window.embeddedTwState={currentStep:"start",history:[]},embeddedTwRender(e)}function __getTechCardsForUi(){return(database||[]).map((e,t)=>({...e,__dbIndex:t})).filter(e=>"teknik"===String(e.category||"").toLowerCase()&&"pasif"!==String(e.status||"").toLowerCase())}async function addTechCardSheet(){if(!isAdminMode)return;const{value:e}=await Swal.fire({title:"Teknik Kart Ekle",html:'\n        <input id="tc-title" class="swal2-input" placeholder="BaÅŸlÄ±k">\n        <textarea id="tc-text" class="swal2-textarea" placeholder="AÃ§Ä±klama"></textarea>\n        <textarea id="tc-script" class="swal2-textarea" placeholder="Script (opsiyonel)"></textarea>\n        <input id="tc-link" class="swal2-input" placeholder="Link (opsiyonel)">\n      ',showCancelButton:!0,confirmButtonText:"Ekle",cancelButtonText:"VazgeÃ§",preConfirm:()=>{const e=(document.getElementById("tc-title").value||"").trim();if(!e)return Swal.showValidationMessage("BaÅŸlÄ±k zorunlu");const t=new Date,a=t.getDate()+"."+(t.getMonth()+1)+"."+t.getFullYear();return{cardType:"card",category:"Teknik",title:e,text:(document.getElementById("tc-text").value||"").trim(),script:(document.getElementById("tc-script").value||"").trim(),code:"",link:(document.getElementById("tc-link").value||"").trim(),status:"Aktif",date:a}}});if(e&&e){Swal.fire({title:"Ekleniyor...",didOpen:()=>Swal.showLoading(),showConfirmButton:!1});try{const t=await apiCall("addCard",{...e});"success"===t.result?(Swal.fire({icon:"success",title:"Eklendi",timer:1200,showConfirmButton:!1}),await loadContentData(),filterTechCards()):Swal.fire("Hata",t.message||"Eklenemedi","error")}catch(e){Swal.fire("Hata","Sunucu hatasÄ±.","error")}}}async function editTechCardSheet(e){if(!isAdminMode)return;const t=(database||[])[e];if(!t)return;const{value:a}=await Swal.fire({title:"Teknik KartÄ± DÃ¼zenle",html:`\n        <input id="tc-title" class="swal2-input" placeholder="BaÅŸlÄ±k" value="${escapeHtml(t.title||"")}">\n        <textarea id="tc-text" class="swal2-textarea" placeholder="AÃ§Ä±klama">${escapeHtml(t.text||"")}</textarea>\n        <textarea id="tc-script" class="swal2-textarea" placeholder="Script">${escapeHtml(t.script||"")}</textarea>\n        <input id="tc-link" class="swal2-input" placeholder="Link" value="${escapeHtml(t.link||"")}">\n      `,showCancelButton:!0,confirmButtonText:"Kaydet",cancelButtonText:"VazgeÃ§",preConfirm:()=>{const e=(document.getElementById("tc-title").value||"").trim();return e?{title:e,text:(document.getElementById("tc-text").value||"").trim(),script:(document.getElementById("tc-script").value||"").trim(),link:(document.getElementById("tc-link").value||"").trim()}:Swal.showValidationMessage("BaÅŸlÄ±k zorunlu")}});if(!a)return;const n=t.title;a.text!==(t.text||"")&&sendUpdate(n,"Text",a.text,"card"),setTimeout(()=>{a.script!==(t.script||"")&&sendUpdate(n,"Script",a.script,"card")},350),setTimeout(()=>{a.link!==(t.link||"")&&sendUpdate(n,"Link",a.link,"card")},700),setTimeout(()=>{a.title!==n&&sendUpdate(n,"Title",a.title,"card")},1100)}function deleteTechCardSheet(e){if(!isAdminMode)return;const t=(database||[])[e];t&&Swal.fire({title:"Silinsin mi?",text:"Kart pasife alÄ±nacak.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sil",cancelButtonText:"VazgeÃ§"}).then(e=>{e.isConfirmed&&sendUpdate(t.title,"Status","Pasif","card")})}function renderTechCardsTab(e=""){const t=document.getElementById("x-cards");if(!t)return;const a=String(e||"").trim().toLowerCase(),n=__getTechCardsForUi(),i=a?n.filter(e=>`${e.title||""} ${e.text||""} ${e.script||""} ${e.link||""}`.toLowerCase().includes(a)):n,l=isAdminMode&&isEditingActive?'<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px">\n           <button class="x-btn x-btn-admin" onclick="addTechCardSheet()"><i class="fas fa-plus"></i> Kart Ekle</button>\n         </div>':"";i.length?t.innerHTML=l+`\n      <div class="x-card-grid">\n        ${i.map(e=>{const t=(e.text||"").length>180||(e.script||"").length>120||!!e.link,a={title:e.title,text:e.text||"",script:e.script||"",link:e.link||""},n=isAdminMode&&isEditingActive?`\n              <button class="x-btn x-btn-admin" onclick="event.stopPropagation();editTechCardSheet(${e.__dbIndex})"><i class="fas fa-pen"></i> DÃ¼zenle</button>\n              <button class="x-btn x-btn-admin" onclick="event.stopPropagation();deleteTechCardSheet(${e.__dbIndex})"><i class="fas fa-trash"></i> Sil</button>\n            `:"";return`\n            <div class="x-card" style="cursor:pointer" onclick='showCardDetail(${JSON.stringify(a).replace(/</g,"\\u003c")})'>\n              <div class="x-card-head">\n                <div class="x-card-title">${escapeHtml(e.title||"")}</div>\n                <div class="x-card-badge">TEKNÄ°K</div>\n              </div>\n              <div class="x-card-body">\n                ${e.text?`<div class="x-card-text x-card-text-truncate">${escapeHtml(e.text||"")}</div>`:'<div style="opacity:.7">Ä°Ã§erik yok</div>'}\n                ${t?`<button class="x-readmore" onclick='event.stopPropagation();showCardDetail(${JSON.stringify(a).replace(/</g,"\\u003c")})'>Devam oku</button>`:""}\n              </div>\n              <div class="x-card-actions" onclick="event.stopPropagation();">\n                ${e.script?`<button class="x-btn x-btn-copy" onclick='copyText(${JSON.stringify(e.script||"")})'><i class="fas fa-copy"></i> Kopyala</button>`:""}\n                ${n}\n              </div>\n            </div>\n          `}).join("")}\n      </div>\n    `:t.innerHTML=l+'<div style="opacity:.7;padding:16px">KayÄ±t bulunamadÄ±.</div>'}function filterTechCards(){const e=document.getElementById("x-cards-search");renderTechCardsTab(e?e.value:"")}function applySportsRights(){if(!Array.isArray(sportsData)||0===sportsData.length)return;const e=window.sportRightsFromSheet&&window.sportRightsFromSheet.length?window.sportRightsFromSheet:SPORTS_RIGHTS_FALLBACK;sportsData.forEach(t=>{const a=`${t.title||""} ${t.desc||""} ${t.detail||""}`.toLowerCase(),n=e.find(e=>a.includes(String(e.name||"").toLowerCase().replaceAll("*","").trim().split(" ")[0]));if(n){const e=`YayÄ±n hakkÄ± bitiÅŸ: ${n.end||n.duration}`;t.tip&&!t.tip.includes("YayÄ±n hakkÄ±")?t.tip=`${t.tip} â€¢ ${e}`:t.tip||(t.tip=e),t.detail&&!t.detail.includes("YayÄ±n hakkÄ±")?t.detail=`${t.detail}\n\n${e}`:t.detail||(t.detail=e)}})}const _orig_afterDataLoaded=window.afterDataLoaded;window.afterDataLoaded=function(){try{"function"==typeof _orig_afterDataLoaded&&_orig_afterDataLoaded()}catch(e){}try{applySportsRights()}catch(e){}};let __techDocsCache=null,__techDocsLoadedAt=0,__techCatsCache=null,__techCatsLoadedAt=0;const TECH_TAB_LABELS={broadcast:"YayÄ±n SorunlarÄ±",access:"EriÅŸim SorunlarÄ±",app:"App HatalarÄ±",activation:"Aktivasyon SorunlarÄ±",info:"SÄ±k Sorulan Sorular",payment:"Ã–deme SorunlarÄ±"};function __normalizeTechTab(e){return e}function __normalizeTechCategory(e){const t=(e||"").toString().trim().toLowerCase();return t.startsWith("yay")?"broadcast":t.startsWith("eri")?"access":t.startsWith("app")?"app":t.startsWith("akt")?"activation":t.startsWith("bil")?"info":t.startsWith("Ã¶de")||t.startsWith("ode")||t.includes("Ã¶deme")||t.includes("odeme")?"payment":""}async function __fetchTechDocs(){const e=await apiCall("getTechDocs");return(Array.isArray(e.data)?e.data:[]).filter(e=>"pasif"!==(e.Durum||"").toString().trim().toLowerCase()).map(e=>({categoryKey:__normalizeTechCategory(e.Kategori),kategori:(e.Kategori||"").trim(),baslik:(e.BaÅŸlÄ±k||e.Baslik||e.Title||e["BaÅŸlÄ±k"]||"").toString().trim(),icerik:(e.Ä°Ã§erik||e.Icerik||e.Content||e["Ä°Ã§erik"]||"").toString(),adim:(e.AdÄ±m||e.Adim||e.Step||e["AdÄ±m"]||"").toString(),not:(e.Not||"").toString(),link:(e.Link||"").toString(),image:(e.Resim||e.Image||e.GÃ¶rsel||e.Gorsel||"").toString(),id:e.id,durum:(e.Durum||"").toString()})).filter(e=>e.categoryKey&&e.baslik)}async function __fetchTechDocCategories(){try{const e=await apiCall("getTechDocCategories");return e&&"success"===e.result&&Array.isArray(e.categories)?e.categories:[]}catch(e){return[]}}async function getTechDocCategoryOptions(e=!1){const t=Date.now();if(!e&&__techCatsCache&&t-__techCatsLoadedAt<3e5)return __techCatsCache;const a=await __fetchTechDocCategories();return __techCatsCache=a,__techCatsLoadedAt=t,a}function __renderTechList(e,t){const a=document.getElementById("broadcast"===e?"x-broadcast-list":"access"===e?"x-access-list":"app"===e?"x-app-list":"activation"===e?"x-activation-list":"info"===e?"x-info-list":"payment"===e?"x-payment-list":"");if(!a)return;if(!t||0===t.length)return void(a.innerHTML='<div style="padding:16px;opacity:.75">Bu baÅŸlÄ±k altÄ±nda henÃ¼z iÃ§erik yok. (Sheet: Teknik_Dokumanlar)</div>');const n=isAdminMode&&isEditingActive?`<div style="display:flex;gap:10px;align-items:center;margin:0 0 12px;">\n         <button class="x-btn x-btn-admin" onclick="addTechDoc('${e}')"><i class="fas fa-plus"></i> Yeni Konu Ekle</button>\n       </div>`:"";var i;i=t,a.innerHTML=n+i.map((t,a)=>{const n=[t.icerik?`<div class="q-doc-body" style="white-space: pre-line">${t.icerik}</div>`:"",t.image?`<div style="margin:10px 0;"><img src="${processImageUrl(t.image)}" loading="lazy" onerror="this.style.display='none'" style="max-width:100%; border-radius:8px; max-height:300px; object-fit:cover;"></div>`:"",t.adim?`<div class="q-doc-meta" style="white-space: pre-line"><b>AdÄ±m:</b> ${escapeHtml(t.adim)}</div>`:"",t.not?`<div class="q-doc-meta" style="white-space: pre-line"><b>Not:</b> ${escapeHtml(t.not)}</div>`:"",t.link?`<div class="q-doc-meta"><b>Link:</b> <a href="${escapeHtml(t.link)}" target="_blank">${escapeHtml(t.link)}</a></div>`:""].join(""),i=isAdminMode&&isEditingActive?`<span style="float:right;display:inline-flex;gap:8px" onclick="event.stopPropagation();event.preventDefault();">\n             <button class="x-btn x-btn-admin" style="padding:6px 10px" onclick="editTechDoc('${e}','${escapeForJsString(t.baslik)}')"><i class="fas fa-pen"></i></button>\n             <button class="x-btn x-btn-admin" style="padding:6px 10px" onclick="deleteTechDoc('${e}','${escapeForJsString(t.baslik)}')"><i class="fas fa-trash"></i></button>\n           </span>`:"";return`\n        <details class="q-accordion" style="margin-bottom:10px;background:#fff;border-radius:12px;border:1px solid rgba(0,0,0,.08);padding:10px 12px">\n          <summary style="cursor:pointer;font-weight:800">${escapeHtml(t.baslik)}${i}</summary>\n          <div style="padding:10px 2px 2px 2px">${n}</div>\n        </details>\n      `}).join("")}async function loadTechDocsIfNeeded(e=!1){const t=Date.now();if(!e&&__techDocsCache&&t-__techDocsLoadedAt<12e4)return __techDocsCache;try{const e=await __fetchTechDocs();return __techDocsCache=e,__techDocsLoadedAt=t,e}catch(e){return console.error("[TECH DOCS]",e),[]}}async function filterTechDocList(e){try{const t=document.getElementById(`x-${e}-search`),a=(t?t.value:"").toLowerCase().trim(),n=(await loadTechDocsIfNeeded(!1)).filter(t=>t.categoryKey===e),i=a?n.filter(e=>(e.baslik||"").toLowerCase().includes(a)||(e.icerik||"").toLowerCase().includes(a)||(e.adim||"").toLowerCase().includes(a)||(e.not||"").toLowerCase().includes(a)):n;__renderTechList(e,i)}catch(e){console.error(e)}}let __techCategoryOptions=null;async function loadTechCategoryOptions(){if(__techCategoryOptions)return __techCategoryOptions;try{const e=await apiCall("getTechDocCategories");if(e&&"success"===e.result&&Array.isArray(e.categories))return __techCategoryOptions=e.categories.filter(Boolean),__techCategoryOptions}catch(e){console.error("[TECH CATS]",e)}return __techCategoryOptions=[],__techCategoryOptions}function techTabLabel(e){return{broadcast:"YayÄ±n SorunlarÄ±",access:"EriÅŸim SorunlarÄ±",app:"App HatalarÄ±",activation:"Aktivasyon SorunlarÄ±",info:"SÄ±k Sorulan Sorular",payment:"Ã–deme SorunlarÄ±"}[e]||"YayÄ±n SorunlarÄ±"}async function addTechDoc(e){if(!isAdminMode)return;const t=await getTechDocCategoryOptions(!1),a=TECH_TAB_LABELS[e]||"",n=(t&&t.length?t:Object.values(TECH_TAB_LABELS)).map(e=>String(e||"").trim()).filter(Boolean),i=Array.from(new Set(n.map(e=>e.toLowerCase()))).map(e=>n.find(t=>t.toLowerCase()===e)).map(e=>`<option value="${escapeHtml(e)}" ${e===a?"selected":""}>${escapeHtml(e)}</option>`).join(""),{value:l}=await Swal.fire({title:"Teknik Konu Ekle",html:`\n      <select id="td-cat" class="swal2-select" style="width:100%;max-width:420px">\n        ${i}\n      </select>\n      <input id="td-title" class="swal2-input" placeholder="BaÅŸlÄ±k">\n      <textarea id="td-content" class="swal2-textarea" placeholder="Ä°Ã§erik"></textarea>\n      <input id="td-step" class="swal2-input" placeholder="AdÄ±m (opsiyonel)">\n      <input id="td-note" class="swal2-input" placeholder="Not (opsiyonel)">\n      <input id="td-link" class="swal2-input" placeholder="Link (opsiyonel)">\n      <input id="td-image" class="swal2-input" placeholder="GÃ¶rsel Linki (opsiyonel)">\n    `,showCancelButton:!0,confirmButtonText:"Ekle",cancelButtonText:"VazgeÃ§",preConfirm:()=>{const e=(document.getElementById("td-cat")?.value||a||"").trim();if(!e)return Swal.showValidationMessage("Kategori zorunlu");const t=(document.getElementById("td-title").value||"").trim();return t?{kategori:e,baslik:t,icerik:(document.getElementById("td-content").value||"").trim(),adim:(document.getElementById("td-step").value||"").trim(),not:(document.getElementById("td-note").value||"").trim(),link:(document.getElementById("td-link").value||"").trim(),image:(document.getElementById("td-image").value||"").trim(),durum:"Aktif"}:Swal.showValidationMessage("BaÅŸlÄ±k zorunlu")}});if(l){Swal.fire({title:"Ekleniyor...",didOpen:()=>Swal.showLoading(),showConfirmButton:!1});try{const t=await apiCall("upsertTechDoc",{keyKategori:"",keyBaslik:"",...l});"success"===t.result?(Swal.fire({icon:"success",title:"Eklendi",timer:1200,showConfirmButton:!1}),await loadTechDocsIfNeeded(!0),filterTechDocList(e)):Swal.fire("Hata",t.message||"Eklenemedi","error")}catch(e){Swal.fire("Hata","Sunucu hatasÄ±.","error")}}}async function editTechDoc(e,t){if(!isAdminMode)return;const a=(await loadTechDocsIfNeeded(!1)).find(a=>a.categoryKey===e&&(a.baslik||"")===t);if(!a)return;const n=await getTechDocCategoryOptions(!1),i=(n&&n.length?n:Object.values(TECH_TAB_LABELS)).map(e=>String(e||"").trim()).filter(Boolean),l=Array.from(new Set(i.map(e=>e.toLowerCase()))).map(e=>i.find(t=>t.toLowerCase()===e)).map(e=>`<option value="${escapeHtml(e)}" ${e===a.kategori?"selected":""}>${escapeHtml(e)}</option>`).join(""),{value:r}=await Swal.fire({title:"Teknik Konuyu DÃ¼zenle",html:`\n      <select id="td-cat" class="swal2-select" style="width:100%;max-width:420px">\n        ${l}\n      </select>\n      <input id="td-title" class="swal2-input" placeholder="BaÅŸlÄ±k" value="${escapeHtml(a.baslik||"")}">\n      <textarea id="td-content" class="swal2-textarea" placeholder="Ä°Ã§erik">${escapeHtml(a.icerik||"")}</textarea>\n      <input id="td-step" class="swal2-input" placeholder="AdÄ±m" value="${escapeHtml(a.adim||"")}">\n      <input id="td-note" class="swal2-input" placeholder="Not" value="${escapeHtml(a.not||"")}">\n      <input id="td-link" class="swal2-input" placeholder="Link" value="${escapeHtml(a.link||"")}">\n      <input id="td-image" class="swal2-input" placeholder="GÃ¶rsel Linki" value="${escapeHtml(a.image||"")}">\n    `,showCancelButton:!0,confirmButtonText:"Kaydet",cancelButtonText:"VazgeÃ§",preConfirm:()=>{const e=(document.getElementById("td-cat")?.value||a.kategori||"").trim();if(!e)return Swal.showValidationMessage("Kategori zorunlu");const t=(document.getElementById("td-title").value||"").trim();return t?{kategori:e,baslik:t,icerik:(document.getElementById("td-content").value||"").trim(),adim:(document.getElementById("td-step").value||"").trim(),not:(document.getElementById("td-note").value||"").trim(),link:(document.getElementById("td-link").value||"").trim(),image:(document.getElementById("td-image").value||"").trim(),durum:"Aktif"}:Swal.showValidationMessage("BaÅŸlÄ±k zorunlu")}});if(r){Swal.fire({title:"Kaydediliyor...",didOpen:()=>Swal.showLoading(),showConfirmButton:!1});try{const t=await apiCall("upsertTechDoc",{id:a.id,keyKategori:a.kategori,keyBaslik:a.baslik,...r,username:currentUser,token:getToken()});"success"===t.result?(Swal.fire({icon:"success",title:"Kaydedildi",timer:1200,showConfirmButton:!1}),await loadTechDocsIfNeeded(!0),filterTechDocList(e)):Swal.fire("Hata",t.message||"Kaydedilemedi","error")}catch(e){Swal.fire("Hata","Sunucu hatasÄ±.","error")}}}function deleteTechDoc(e,t){isAdminMode&&Swal.fire({title:"Silinsin mi?",text:"Konu pasife alÄ±nacak.",icon:"warning",showCancelButton:!0,confirmButtonText:"Sil",cancelButtonText:"VazgeÃ§"}).then(async a=>{if(a.isConfirmed)try{const a=(await loadTechDocsIfNeeded(!1)).find(a=>a.categoryKey===e&&(a.baslik||"")===t),n=(a&&a.kategori,await apiCall("deleteTechDoc",{id:a.id,username:currentUser,token:getToken()}));"success"===n.result?(await loadTechDocsIfNeeded(!0),filterTechDocList(e),Swal.fire({icon:"success",title:"Silindi",timer:1e3,showConfirmButton:!1})):Swal.fire("Hata",n.message||"Silinemedi","error")}catch(e){Swal.fire("Hata","Sunucu hatasÄ±.","error")}})}window.switchTechTab=async function(e){try{document.querySelectorAll("#tech-fullscreen .q-nav-item").forEach(e=>e.classList.remove("active"));const t={wizard:"x-view-wizard",access:"x-view-access",app:"x-view-app",activation:"x-view-activation",payment:"x-view-payment",cards:"x-view-cards",info:"x-view-info"},a=t[e]||t.wizard,n=document.querySelector(`#tech-fullscreen .q-nav-item[data-tech-tab="${e}"]`);n&&n.classList.add("active"),document.querySelectorAll("#tech-fullscreen .q-view-section").forEach(e=>e.classList.remove("active"));const i=document.getElementById(a);if(i&&i.classList.add("active"),["access","app","activation","payment","info"].includes(e)){const t=(await loadTechDocsIfNeeded(!1)).filter(t=>t.categoryKey===e);__renderTechList(e,t)}if("wizard"===e)try{renderTechWizardInto("x-wizard")}catch(e){console.error(e)}if("cards"===e)try{filterTechCards()}catch(e){console.error(e)}}catch(e){console.error(e)}};try{window.openMenuPermissions=openMenuPermissions}catch(e){}function openImageUploader(){Swal.fire({title:"GÃ¶rsel YÃ¼kle",html:'\n        <div style="font-size:0.9rem;color:#555;margin-bottom:15px">\n           SeÃ§tiÄŸiniz gÃ¶rsel bulut sistemine yÃ¼klenecek ve size bir link verilecektir.\n           Bu linki "Image" sÃ¼tununa yapÄ±ÅŸtÄ±rarak kartlarda kullanabilirsiniz.\n        </div>\n        <input type="file" id="swal-img-input" accept="image/*" class="swal2-file" style="display:block;margin:0 auto;">\n        ',showCancelButton:!0,confirmButtonText:"YÃ¼kle",cancelButtonText:"Ä°ptal",preConfirm:()=>{const e=document.getElementById("swal-img-input");if(!e||!e.files||0===e.files.length)return void Swal.showValidationMessage("LÃ¼tfen bir gÃ¶rsel seÃ§in.");const t=e.files[0];return new Promise((e,a)=>{const n=new FileReader;n.onload=()=>{const a=n.result.split(",")[1];e({base64:a,mimeType:t.type,fileName:t.name})},n.onerror=e=>a(e),n.readAsDataURL(t)})}}).then(e=>{if(e.isConfirmed){const t=e.value;Swal.fire({title:"YÃ¼kleniyor...",didOpen:()=>{Swal.showLoading()}}),apiCall("uploadImage",t).then(e=>{"success"===e.result?Swal.fire({icon:"success",title:"YÃ¼klendi!",html:`\n                           <div>GÃ¶rsel Linki:</div>\n                           <input type="text" value="${e.url}" id="uploaded-img-url" class="swal2-input" readonly>\n                           <button class="btn btn-copy" style="margin-top:10px" onclick="copyText(document.getElementById('uploaded-img-url').value)">Link'i Kopyala</button>\n                         `,confirmButtonText:"Tamam"}):Swal.fire("Hata",e.message||"YÃ¼klenemedi.","error")}).catch(e=>{Swal.fire("Hata","Sunucu hatasÄ±: "+e,"error")})}})}async function openActiveUsersPanel(){try{Swal.fire({title:"YÃ¼kleniyor...",didOpen:()=>{Swal.showLoading()}});const e=await apiCall("getActiveUsers",{});if(!e||"success"!==e.result)return void Swal.fire("Hata","Aktif kullanÄ±cÄ±lar yÃ¼klenemedi","error");const t=e.users||[];if(0===t.length)return void Swal.fire({title:"ðŸ‘¥ Aktif KullanÄ±cÄ±lar",html:'<p style="color:#999;padding:20px">Åžu an aktif kullanÄ±cÄ± yok.</p>',confirmButtonText:"Tamam"});const a=`\n            <div style="max-height:500px;overflow:auto;border:1px solid rgba(0,0,0,.08);border-radius:12px">\n                <table style="width:100%;border-collapse:collapse">\n                    <thead style="position:sticky;top:0;background:#f7f7f7;z-index:1">\n                        <tr>\n                            <th style="padding:12px;text-align:center">#</th>\n                            <th style="padding:12px;text-align:left">KullanÄ±cÄ±</th>\n                            <th style="padding:12px;text-align:center">Rol</th>\n                            <th style="padding:12px;text-align:left">Grup</th>\n                            <th style="padding:12px;text-align:left">Son Sinyal</th>\n                            <th style="padding:12px;text-align:center">Durum</th>\n                            <th style="padding:12px;text-align:center">Ä°ÅŸlem</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        ${t.map((e,t)=>{const a=e.last_seen?new Date(e.last_seen):null,n=new Date,i=(a?(n-a)/1e3:999999)<65,l=a?a.toLocaleString("tr-TR"):"-";return`\n                <tr style="border-bottom:1px solid #eee; background-color:${i?"transparent":"#f9f9f9"}">\n                    <td style="padding:12px;text-align:center; color:${i?"inherit":"#999"}">${t+1}</td>\n                    <td style="padding:12px;font-weight:600; color:${i?"inherit":"#999"}">${escapeHtml(e.username)}</td>\n                    <td style="padding:12px;text-align:center">\n                        <span style="display:inline-block;padding:4px 8px;border-radius:4px;font-size:0.85rem;background:${"admin"===e.role?"#4caf50":"locadmin"===e.role?"#2196f3":"qusers"===e.role?"#ff9800":"#9e9e9e"};color:#fff;opacity:${i?1:.6}">${escapeHtml(e.role)}</span>\n                    </td>\n                    <td style="padding:12px;font-size:0.9rem; color:${i?"inherit":"#999"}">${escapeHtml(e.group||"-")}</td>\n                    <td style="padding:12px;font-size:0.85rem;color:#666">${escapeHtml(l)}</td>\n                    <td style="padding:12px;text-align:center">\n                        ${i?'<span style="color:#2e7d32;font-weight:bold;font-size:0.85rem;padding:4px 8px;background:#e8f5e9;border-radius:12px"><i class="fas fa-circle" style="font-size:8px;vertical-align:middle"></i> Online</span>':'<span style="color:#757575;font-weight:bold;font-size:0.85rem;padding:4px 8px;background:#eeeeee;border-radius:12px"><i class="far fa-circle" style="font-size:8px;vertical-align:middle"></i> Offline</span>'}\n                    </td>\n                    <td style="padding:12px;text-align:center">\n                       ${e.username!==currentUser?`<button \n                            onclick="kickUser('${escapeForJsString(e.username)}', '${e.id||""}')" \n                            style="padding:6px 12px;background:#d32f2f;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem; opacity:${i?1:.5}"\n                            title="KullanÄ±cÄ±yÄ± sistemden at">\n                            <i class="fas fa-power-off"></i> At\n                        </button>`:'<span style="color:#ccc">-</span>'}\n                    </td>\n                </tr>\n            `}).join("")}\n                    </tbody>\n                </table>\n            </div>\n            <div style="margin-top:15px;padding:10px;background:#e3f2fd;border-radius:8px;font-size:0.9rem;color:#1976d2">\n                <i class="fas fa-info-circle"></i> <strong>Online:</strong> Son 1 dk iÃ§inde aktif. <strong>Offline:</strong> Son 24 saat iÃ§inde giriÅŸ yapmÄ±ÅŸ.\n                <br><small>Not: "At" butonu kullanÄ±cÄ±yÄ± bir sonraki sinyalde (max 30sn) sistemden dÃ¼ÅŸÃ¼rÃ¼r.</small>\n            </div>\n        `;Swal.fire({title:"ðŸ‘¥ Aktif KullanÄ±cÄ±lar",html:a,width:1e3,showConfirmButton:!0,confirmButtonText:"Kapat"})}catch(e){Swal.fire("Hata","Bir hata oluÅŸtu: "+e.message,"error")}}async function kickUser(e,t){if(!t&&e){const{data:a}=await sb.from("profiles").select("id").eq("username",e).single();a&&(t=a.id)}const{isConfirmed:a}=await Swal.fire({title:"KullanÄ±cÄ±yÄ± At?",text:`${e} kullanÄ±cÄ±sÄ± sistemden atÄ±lacak.`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Evet, At"});if(a&&t)try{const{error:a}=await sb.from("profiles").update({force_logout:!0}).eq("id",t);if(a)throw a;saveLog("KullanÄ±cÄ±yÄ± Sistemden Atma",e),Swal.fire("BaÅŸarÄ±lÄ±","KullanÄ±cÄ±ya Ã§Ä±kÄ±ÅŸ komutu gÃ¶nderildi (max 30sn).","success"),openActiveUsersPanel()}catch(e){console.error(e),Swal.fire("Hata","KullanÄ±cÄ± atÄ±lamadÄ±: "+e.message,"error")}}async function fetchUserListForAdmin(){try{const e=await apiCall("getUserList",{});e&&"success"===e.result&&(adminUserList=e.users||[],console.log("[Pusula] Admin User List loaded:",adminUserList.length))}catch(e){console.error("[Pusula] fetchUserListForAdmin error:",e)}}async function openUserManagementPanel(){try{Swal.fire({title:"YÃ¼kleniyor...",didOpen:()=>{Swal.showLoading()}});const e=await apiCall("getUserList",{});if(!e||"success"!==e.result)throw new Error("KullanÄ±cÄ± listesi alÄ±namadÄ±.");const t=e.users||[],a=`\n            <div style="margin-bottom:15px;text-align:right">\n                \x3c!-- Yeni KullanÄ±cÄ± butonu kaldÄ±rÄ±ldÄ±, Supabase Auth zorunlu --\x3e\n                <button class="x-btn-admin" onclick="Swal.fire('Bilgi', 'Yeni kullanÄ±cÄ±larÄ± Supabase Dashboard Ã¼zerinden ekleyiniz.', 'info')" style="background:#ddd; color:#555"><i class="fas fa-info-circle"></i> KullanÄ±cÄ± Ekleme HakkÄ±nda</button>\n            </div>\n            <div style="max-height:450px;overflow:auto;border:1px solid #eee;border-radius:10px">\n                <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">\n                    <thead style="background:#f9fafb;position:sticky;top:0;">\n                        <tr>\n                            <th style="padding:10px;">#</th>\n                            <th style="padding:10px;text-align:left">KullanÄ±cÄ±</th>\n                            <th style="padding:10px;text-align:left">Rol</th>\n                            <th style="padding:10px;text-align:left">Grup</th>\n                            <th style="padding:10px;">Ä°ÅŸlem</th>\n                        </tr>\n                    </thead>\n                    <tbody>${t.map((e,t)=>`\n            <tr style="border-bottom:1px solid #eee">\n                <td style="padding:10px;text-align:center">${t+1}</td>\n                <td style="padding:10px;"><strong>${escapeHtml(e.username||e.name)}</strong></td>\n                <td style="padding:10px;">${escapeHtml(e.role||"-")}</td>\n                <td style="padding:10px;">${escapeHtml(e.group||"-")}</td>\n                <td style="padding:10px;text-align:center">\n                    <button class="x-btn-admin" onclick="editUserPopup('${e.id}')" style="background:var(--secondary);padding:5px 10px;font-size:0.75rem;"><i class="fas fa-edit"></i> DÃ¼zenle</button>\n                    <button class="x-btn-admin" onclick="deleteUser('${e.id}', '${escapeForJsString(e.username||e.name)}')" style="background:var(--accent);padding:5px 10px;font-size:0.75rem;"><i class="fas fa-trash"></i> Sil</button>\n                </td>\n            </tr>\n        `).join("")}</tbody>\n                </table>\n            </div>\n        `;Swal.fire({title:"ðŸ‘¥ KullanÄ±cÄ± YÃ¶netimi",html:a,width:800,showConfirmButton:!0,confirmButtonText:"Kapat"}),window.editUserPopup=async function(e){let a=e?t.find(t=>String(t.id)===String(e)):null;if(!a)return;const{value:n}=await Swal.fire({title:"KullanÄ±cÄ± DÃ¼zenle",html:`\n                    <input id="u-name" class="swal2-input" placeholder="KullanÄ±cÄ± AdÄ±" value="${a.username||a.name||""}" readonly style="background:#eee">\n                    <p style="font-size:0.8rem;text-align:left;color:#666;margin:5px 23px;">Rol ve Grup yetkilerini gÃ¼ncelleyebilirsiniz.</p>\n                    <select id="u-role" class="swal2-input">\n                        <option value="user" ${"user"===a.role?"selected":""}>KullanÄ±cÄ±</option>\n                        <option value="agent" ${"agent"===a.role?"selected":""}>Temsilci (Agent)</option>\n                        <option value="qusers" ${"qusers"===a.role?"selected":""}>Kalite (QA)</option>\n                        <option value="admin" ${"admin"===a.role?"selected":""}>YÃ¶netici (Admin)</option>\n                        <option value="locadmin" ${"locadmin"===a.role?"selected":""}>Tam Yetkili (LocAdmin)</option>\n                    </select>\n                    <input id="u-group" class="swal2-input" placeholder="Grup (Ã–rn: TelesatÄ±ÅŸ)" value="${a.group||""}">\n                `,showCancelButton:!0,confirmButtonText:"Kaydet",preConfirm:()=>({id:e,username:a.username,fullName:a.name,role:document.getElementById("u-role").value,group:document.getElementById("u-group").value})});if(n){Swal.fire({title:"Kaydediliyor...",didOpen:()=>Swal.showLoading()});const e=await apiCall("saveUser",n);"success"===e.result?Swal.fire("BaÅŸarÄ±lÄ±","KullanÄ±cÄ± kaydedildi.","success").then(()=>openUserManagementPanel()):Swal.fire("Hata",e.message||"Kaydedilemedi","error")}},window.deleteUser=async function(e,t){if((await Swal.fire({title:"Emin misiniz?",text:`${t} kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinize emin misiniz?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Evet, Sil",confirmButtonColor:"#d32f2f"})).isConfirmed){const t=await apiCall("deleteUser",{id:e});"success"===t.result?Swal.fire("Silindi","KullanÄ±cÄ± silindi.","success").then(()=>openUserManagementPanel()):Swal.fire("Hata",t.message||"Silinemedi","error")}}}catch(e){Swal.fire("Hata",e.message,"error")}}async function openLogsPanel(){try{Swal.fire({title:"GÃ¼nlÃ¼kler yÃ¼kleniyor...",didOpen:()=>{Swal.showLoading()}});const e=await apiCall("getLogs",{});if(!e||"success"!==e.result)throw new Error("Loglar alÄ±namadÄ±.");const t=e.logs||[],a=`\n            <div style="max-height:500px; overflow:auto; border:1px solid #eee; border-radius:10px;">\n                <table style="width:100%; border-collapse:collapse; text-align:left;">\n                    <thead style="background:#f4f7f9; position:sticky; top:0;">\n                        <tr>\n                            <th style="padding:10px;">Tarih</th>\n                            <th style="padding:10px;">KullanÄ±cÄ±</th>\n                            <th style="padding:10px;">Eylem</th>\n                            <th style="padding:10px;">Detay</th>\n                            <th style="padding:10px;">IP</th>\n                        </tr>\n                    </thead>\n                    <tbody>${t.map((e,t)=>`\n            <tr style="border-bottom:1px solid #eee; font-size:0.8rem;">\n                <td style="padding:8px; color:#888;">${new Date(e.Date).toLocaleString("tr-TR")}</td>\n                <td style="padding:8px;"><strong>${escapeHtml(e.Username)}</strong></td>\n                <td style="padding:8px;"><span class="badge" style="background:#e3f2fd; color:#1976d2; padding:2px 6px; border-radius:4px;">${escapeHtml(e.Action)}</span></td>\n                <td style="padding:8px; color:#555;">${escapeHtml(e.Details)}</td>\n                <td style="padding:8px; color:#999; font-family:monospace;">${escapeHtml(e["Ä°P ADRESÄ°"]||"-")}</td>\n            </tr>\n        `).join("")}</tbody>\n                </table>\n            </div>\n        `;Swal.fire({title:"ðŸ“œ Sistem LoglarÄ±",html:a,width:1e3,showConfirmButton:!0,confirmButtonText:"Kapat"})}catch(e){Swal.fire("Hata","Loglar yÃ¼klenirken bir sorun oluÅŸtu.","error")}}async function openMenuPermissions(){try{Swal.fire({title:"Yetkiler YÃ¼kleniyor...",didOpen:()=>{Swal.showLoading()}});const e=await apiCall("getRolePermissions",{});if(!e||"success"!==e.result)return void Swal.fire("Hata","Yetki listesi alÄ±namadÄ±.","error");allRolePermissions=e.permissions||[];const t=e.groups||["admin","qusers","users"];let a=0;const n=e=>{const a=t[e],n=allRolePermissions.filter(e=>e.role===a),i={home:"Ana Sayfa",search:"Arama Ã‡ubuÄŸu",news:"Duyurular",tech:"Teknik SayfasÄ±",persuasion:"Ä°kna SayfasÄ±",campaign:"Kampanya SayfasÄ±",info:"Bilgi SayfasÄ±",broadcast:"YayÄ±n AkÄ±ÅŸÄ±",guide:"Spor Rehberi",return:"Ä°ade AsistanÄ±",telesales:"TeleSatÄ±ÅŸ",game:"Oyun Merkezi",quality:"Kalite Paneli",shift:"Vardiyam"},l=[],r=new Set;document.querySelectorAll("[data-menu-key]").forEach(e=>{const t=e.getAttribute("data-menu-key");r.has(t)||(l.push({key:t,label:i[t]||e.textContent.trim().replace(/\s+/g," ")||t,perms:["View"]}),r.add(t))}),l.sort((e,t)=>e.label.localeCompare(t.label,"tr"));const s=[{cat:"Genel Yetkiler",items:[{key:"EditMode",label:"DÃ¼zenleme Modunu AÃ§ma",perms:["Execute"]},{key:"AddContent",label:"Yeni Ä°Ã§erik Ekleme",perms:["Execute"]},{key:"ImageUpload",label:"GÃ¶rsel YÃ¼kleme",perms:["Execute"]},{key:"Reports",label:"Rapor Ã‡ekme (DÄ±ÅŸa Aktar)",perms:["Execute"]},{key:"RbacAdmin",label:"Yetki YÃ¶netimi",perms:["Execute"]},{key:"ActiveUsers",label:"Aktif KullanÄ±cÄ±lar",perms:["Execute"]},{key:"UserAdmin",label:"KullanÄ±cÄ± YÃ¶netimi",perms:["Execute"]},{key:"SystemLogs",label:"Sistem LoglarÄ±",perms:["Execute"]}]},{cat:"Sayfa EriÅŸimi",items:l},{cat:"Kalite YÃ¶netimi",items:[{key:"Evaluation",label:"DeÄŸerlendirme Yapma",perms:["Execute"]},{key:"Feedback",label:"Geri Bildirim Ekleme",perms:["Execute"]},{key:"Training",label:"EÄŸitim Atama",perms:["Execute"]}]}];return`\n                <div class="rbac-container">\n                    <div class="rbac-header">\n                        <div style="font-weight:700;color:var(--primary)">\n                            <i class="fas fa-user-shield"></i> \n                            <span style="text-transform:capitalize">${a}</span> RolÃ¼ Yetki TanÄ±mlarÄ±\n                        </div>\n                        <div class="rbac-info-box">\n                            <i class="fas fa-info-circle"></i> LocAdmin her zaman tam yetkilidir.\n                        </div>\n                    </div>\n\n                    <div class="rbac-role-selector">\n                        ${t.map((t,a)=>`\n                            <button class="rbac-role-btn ${a===e?"active":""}" onclick="window.switchRbacRole(${a})">\n                                ${t.toUpperCase()}\n                            </button>\n                        `).join("")}\n                    </div>\n\n                    <div class="rbac-table-wrapper">\n                        <table class="rbac-table">\n                            <thead>\n                                <tr>\n                                    <th style="text-align:left">Kaynak / Yetki AlanÄ±</th>\n                                    <th style="text-align:center">Durum</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${s.map(t=>`\n                                    <tr class="rbac-category-row"><td colspan="2">${t.cat}</td></tr>\n                                    ${t.items.map(t=>{const i=n.some(e=>e.resource===t.key&&!0===e.value),l=a.replace(/'/g,"\\'");return`\n                                            <tr>\n                                                <td class="rbac-resource-name">${t.label}</td>\n                                                <td style="text-align:center">\n                                                    <label class="rbac-switch">\n                                                        <input type="checkbox" id="perm_${e}_${t.key}" ${i?"checked":""} \n                                                            onchange="window.toggleRbacPerm('${l}', '${t.key}', this.checked)">\n                                                        <span class="rbac-slider"></span>\n                                                    </label>\n                                                </td>\n                                            </tr>\n                                        `}).join("")}\n                                `).join("")}\n                            </tbody>\n                        </table>\n                    </div>\n                </div>\n            `};window.switchRbacRole=e=>{a=e,Swal.update({html:n(e)})},window.toggleRbacPerm=(e,t,a)=>{const n=allRolePermissions.findIndex(a=>a.role===e&&a.resource===t);n>-1?allRolePermissions[n].value=a:allRolePermissions.push({role:e,resource:t,permission:"All",value:a})},Swal.fire({title:"ðŸ›¡ï¸ GeliÅŸmiÅŸ Yetki YÃ¶netimi",html:n(0),width:800,showCancelButton:!0,cancelButtonText:"VazgeÃ§",confirmButtonText:"DeÄŸiÅŸiklikleri Kaydet",confirmButtonColor:"var(--success)",preConfirm:async()=>{const e=[];t.forEach(t=>{const a=allRolePermissions.filter(e=>e.role===t).map(e=>({resource:e.resource,permission:e.permission||"All",value:e.value}));e.push({role:t,perms:a})});try{Swal.showLoading();for(const t of e)await apiCall("setRolePermissions",t);return!0}catch(e){Swal.showValidationMessage(`KayÄ±t hatasÄ±: ${e.message}`)}}}).then(e=>{e.isConfirmed&&Swal.fire("BaÅŸarÄ±lÄ±","TÃ¼m yetkiler gÃ¼ncellendi. KullanÄ±cÄ±larÄ±n etkilenmesi iÃ§in sayfayÄ± yenilemeleri gerekebilir.","success")})}catch(e){Swal.fire("Hata","Bir hata oluÅŸtu: "+e.message,"error")}}function hasPerm(e,t="All"){const a=(getMyRole()||"").trim().toLowerCase(),n=(localStorage.getItem("sSportGroup")||"").trim().toLowerCase();function i(e){return String(e||"").toLowerCase().replace(/iÌ‡/g,"i").replace(/Ä±/g,"i").replace(/ÅŸ/g,"s").replace(/ÄŸ/g,"g").replace(/Ã¼/g,"u").replace(/Ã¶/g,"o").replace(/Ã§/g,"c").trim()}const l=i(a),r=i(n);if("locadmin"===l||"locadmin"===r)return!0;if(r&&""!==r&&"all"!==r){const a=allRolePermissions.find(a=>!(i(a.role)!==r||a.resource!==e&&"All"!==a.resource||a.permission!==t&&"All"!==a.permission));if(a)return a.value}const s=allRolePermissions.find(a=>!(i(a.role)!==l||a.resource!==e&&"All"!==a.resource||a.permission!==t&&"All"!==a.permission));return!!s&&s.value}async function loadPermissionsOnStartup(){if(!currentUser)return;const e=await apiCall("getRolePermissions",{});if(e&&"success"===e.result&&(allRolePermissions=e.permissions||[],applyPermissionsToUI(),!hasPerm("home","View"))){const e=[{key:"quality",action:openQualityArea},{key:"tech",action:()=>openTechArea("wizard")},{key:"shift",action:()=>filterCategory(null,"shift")},{key:"news",action:openNews},{key:"broadcast",action:openBroadcastFlow},{key:"telesales",action:()=>filterCategory(null,"TelesatÄ±ÅŸ")},{key:"persuasion",action:()=>filterCategory(null,"Ä°kna")},{key:"campaign",action:()=>filterCategory(null,"Kampanya")},{key:"info",action:()=>filterCategory(null,"Bilgi")}];for(const t of e)if(hasPerm(t.key,"View")){t.action(),console.log(`[Auth] Ana sayfa yetkisi yok, ${t.key} sayfasÄ±na yÃ¶nlendirildi.`);break}}}function applyPermissionsToUI(){getMyRole();const e=document.getElementById("dropdownQuickEdit");e&&(e.style.display=hasPerm("EditMode")?"flex":"none");const t=document.getElementById("dropdownAddCard");t&&(t.style.display=hasPerm("AddContent")?"flex":"none");const a=document.getElementById("dropdownImage");a&&(a.style.display=hasPerm("ImageUpload")?"flex":"none");document.querySelectorAll(".admin-btn").forEach(e=>{e.style.display=hasPerm("Reports")?"":"none"});const n=document.getElementById("dropdownPerms");n&&(n.style.display=hasPerm("RbacAdmin")?"flex":"none");const i=document.getElementById("dropdownActiveUsers");i&&(i.style.display=hasPerm("ActiveUsers")?"flex":"none");const l=document.getElementById("dropdownUserMgmt");l&&(l.style.display=hasPerm("UserAdmin")?"flex":"none");const r=document.getElementById("dropdownLogs");r&&(r.style.display=hasPerm("SystemLogs")?"flex":"none");const s={home:"home",search:"search",tech:"tech",telesales:"telesales",persuasion:"persuasion",campaign:"campaign",info:"info",news:"news",quality:"quality",shift:"shift",broadcast:"broadcast",guide:"guide",return:"return",game:"game"};Object.keys(s).forEach(e=>{document.querySelectorAll(`[data-menu-key="${e}"]`).forEach(t=>{hasPerm(s[e],"View")?t.style.display="":t.style.display="none"});document.querySelectorAll(`[data-shortcut-key="${e}"]`).forEach(t=>{hasPerm(s[e],"View")?t.style.display="":t.style.display="none"})});try{"home"===currentCategory&&renderHomePanels()}catch(e){}checkQualityNotifications()}async function openAgentNotePopup(e,t){const{value:a}=await Swal.fire({title:"ðŸ’¬ GÃ¶rÃ¼ÅŸ / Not Ekle",html:'\n        <div style="margin-top:5px; text-align:left;">\n            <p style="font-size:0.9rem; color:#555; margin-bottom:10px;">\n                Bu deÄŸerlendirme ile ilgili eklemek istediÄŸiniz bir not, teÅŸekkÃ¼r veya gÃ¶rÃ¼ÅŸ varsa aÅŸaÄŸÄ±ya yazabilirsiniz.\n            </p>\n            <textarea id="swal-agent-note" class="swal2-textarea" style="margin-top:0;" placeholder="Notunuzu buraya yazÄ±n..."></textarea>\n        </div>\n        ',showCancelButton:!0,confirmButtonText:"GÃ¶nder",cancelButtonText:"VazgeÃ§",confirmButtonColor:"#f57c00",preConfirm:()=>{const e=document.getElementById("swal-agent-note").value;return e&&e.trim()?e.trim():(Swal.showValidationMessage("LÃ¼tfen bir not yazÄ±n veya VazgeÃ§ butonuna basÄ±n."),!1)}});if(a){Swal.fire({title:"Not Kaydediliyor...",didOpen:()=>Swal.showLoading(),showConfirmButton:!1});try{"success"===(await apiCall("submitAgentNote",{callId:e,username:currentUser,note:a,status:"Bekliyor"})).result?(Swal.fire("BaÅŸarÄ±lÄ±","GÃ¶rÃ¼ÅŸÃ¼nÃ¼z yÃ¶neticiye iletildi.","success"),fetchEvaluationsForAgent(currentUser),checkQualityNotifications()):Swal.fire("Hata","Ä°ÅŸlem sÄ±rasÄ±nda bir kÄ±sÄ±tlama oluÅŸtu. LÃ¼tfen baÄŸlantÄ±nÄ±zÄ± kontrol edin.","error")}catch(e){Swal.fire("Hata","Sistem hatasÄ± oluÅŸtu. LÃ¼tfen tekrar deneyin.","error")}}}async function openWizardEditor(e,t){if(!isAdminMode)return;let a="WizardSteps"===e?wizardStepsData[t]:techWizardData[t];if(!a)return void Swal.fire("Hata","AdÄ±m verisi bulunamadÄ±.","error");let n="WizardSteps"===e?a.options.map(e=>`${e.text} | ${e.next} | ${e.style||"primary"}`).join(", "):(a.buttons||[]).map(e=>`${e.text} | ${e.next} | ${e.style||"primary"}`).join(", ");const{value:i}=await Swal.fire({title:`ðŸ”§ DÃ¼zenle: ${t}`,html:`\n            <div style="text-align:left; font-size:0.85rem;">\n                <label>BaÅŸlÄ±k</label><input id="w-title" class="swal2-input" value="${a.title||""}">\n                <label>Metin</label><textarea id="w-text" class="swal2-textarea" style="height:80px;">${a.text||""}</textarea>\n                <label>Script</label><textarea id="w-script" class="swal2-textarea" style="height:60px;">${a.script||""}</textarea>\n                <label>SeÃ§enekler (Format: Metin | NextID | Style , ...)</label>\n                <textarea id="w-options" class="swal2-textarea" style="height:80px;">${n}</textarea>\n                ${"WizardSteps"===e?`<label>SonuÃ§ (red, green, yellow)</label><input id="w-result" class="swal2-input" value="${a.result||""}">`:""}\n                ${"TechWizardSteps"===e?`<label>Alert</label><input id="w-alert" class="swal2-input" value="${a.alert||""}">`:""}\n            </div>\n        `,width:600,showCancelButton:!0,confirmButtonText:"Kaydet",preConfirm:()=>({title:document.getElementById("w-title").value,text:document.getElementById("w-text").value,script:document.getElementById("w-script").value,options:document.getElementById("w-options").value,result:document.getElementById("w-result")?document.getElementById("w-result").value:null,alert:document.getElementById("w-alert")?document.getElementById("w-alert").value:null})});if(i){Swal.fire({title:"Kaydediliyor...",didOpen:()=>Swal.showLoading()});try{const a={StepID:t,Title:i.title,Text:i.text,Script:i.script,Options:i.options};null!==i.result&&(a.Result=i.result),null!==i.alert&&(a.Alert=i.alert);const{error:n}=await sb.from(e).upsert(a,{onConflict:"StepID"});if(n)throw n;Swal.fire("BaÅŸarÄ±lÄ±","GÃ¼ncellendi. Yenileniyor...","success"),"WizardSteps"===e?(await loadWizardData(),renderStep(t)):(await loadTechWizardData(),twRenderStep())}catch(e){Swal.fire("Hata","Kaydedilemedi: "+e.message,"error")}}}async function openAdminReplyPopup(e,t,a){const{value:n}=await Swal.fire({title:"Geri Bildirim YanÄ±tla",html:`\n        <div style="text-align:left; background:#f5f5f5; padding:10px; border-radius:5px; margin-bottom:10px; font-size:0.9rem;">\n            <strong>Temsilci Notu:</strong><br>${escapeHtml(a)}\n        </div>\n        <textarea id="swal-manager-reply" class="swal2-textarea" placeholder="YÃ¶netici cevabÄ±nÄ± yaz..."></textarea>\n        <select id="swal-reply-status" class="swal2-input">\n            <option value="TamamlandÄ±">âœ… YanÄ±tla ve SÃ¼reci Tamamla</option>\n            <option value="Bekliyor">â³ Ä°nceleme Devam Ediyor</option>\n        </select>\n        `,showCancelButton:!0,confirmButtonText:"Kaydet",cancelButtonText:"Ä°ptal",preConfirm:()=>({reply:document.getElementById("swal-manager-reply").value,status:document.getElementById("swal-reply-status").value})});if(n){Swal.fire({title:"Kaydediliyor...",didOpen:()=>Swal.showLoading(),showConfirmButton:!1});try{"success"===(await apiCall("resolveAgentFeedback",{callId:e,agentName:t,reply:n.reply,status:n.status,username:currentUser})).result?(Swal.fire("BaÅŸarÄ±lÄ±","YanÄ±t kaydedildi.","success"),"function"==typeof refreshQualityData&&refreshQualityData(),fetchEvaluationsForAgent(t,!0),checkQualityNotifications()):Swal.fire("Hata","Kaydedilemedi.","error")}catch(e){Swal.fire("Hata","Sunucu hatasÄ±.","error")}}}function checkQualityNotifications(){apiCall("getQualityNotifications",{username:currentUser,role:getMyRole()}).then(e=>{if("success"===e.result){const t=e.notifications;let a=0;const n=document.querySelector('[data-menu-key="quality"]');if(!n)return;const i=n.querySelector(".notif-badge");if(i&&i.remove(),a=isAdminMode||isLocAdmin?t.pendingFeedbackCount||0:t.unseenCount||0,a>0){const e=document.createElement("span");e.className="notif-badge",e.innerText=a,e.style.cssText="\n                    position: absolute;\n                    top: -5px;\n                    right: -5px;\n                    background: red;\n                    color: white;\n                    border-radius: 50%;\n                    padding: 2px 6px;\n                    font-size: 0.7rem;\n                    font-weight: bold;\n                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n                    animation: pulse 2s infinite;\n                ",n.style.position="relative",n.appendChild(e)}}}).catch(e=>console.log("Notif check error",e))}
